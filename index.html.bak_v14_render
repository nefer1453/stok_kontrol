<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stok Kontrol Motoru</title>
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{
      --bg:#070b14;
      --card:#0b1220;
      --card2:#0d1730;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.08);
      --ok:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --blue:#2563eb;
      --r:20px;
      --pad:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070b14,#05070f);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(7,11,20,.72);backdrop-filter: blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:860px;margin:0 auto;padding:14px 14px 92px}
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px;font-size:16px}
    .hint{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center}
    .col{display:flex;flex-direction:column;gap:10px}
    input,select,textarea{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    input::placeholder,textarea::placeholder{color:rgba(148,163,184,.75)}
    textarea{min-height:56px;resize:vertical}
    .btn{
      border:0;border-radius:16px;
      padding:14px 16px;
      font-weight:800;
      cursor:pointer;
      color:white;
    }
    .btn:active{transform:translateY(1px)}
    .btnOK{background:linear-gradient(180deg,#16a34a,#0f7a35)}
    .btnBAD{background:linear-gradient(180deg,#ef4444,#b91c1c)}
    .btnBLUE{background:linear-gradient(180deg,#2563eb,#1d4ed8)}
    .btnWARN{background:linear-gradient(180deg,#f59e0b,#b45309)}
    .pillRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      padding:8px 10px;border-radius:999px;font-size:12px;
    }
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi .k{padding:10px 12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .k b{color:var(--text)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;border-radius:18px;border:1px solid var(--line);
      background:rgba(255,255,255,.02)
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted)}
    .deltaPlus{color:#86efac}
    .deltaMinus{color:#fca5a5}
    .muted{color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .stickySearch{
      position:sticky;top:72px;z-index:40;
      padding-top:10px;
    }
    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;z-index:80;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      background:rgba(7,11,20,.72);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
    }
    .bottomInner{max-width:860px;margin:0 auto;display:flex;gap:10px}
    .tab{flex:1;text-align:center;padding:14px 12px;border-radius:18px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);font-weight:800}
    .tab.active{background:linear-gradient(180deg,rgba(37,99,235,.25),rgba(37,99,235,.10));border-color:rgba(37,99,235,.35)}
    .tab.warn{background:linear-gradient(180deg,rgba(245,158,11,.25),rgba(245,158,11,.10));border-color:rgba(245,158,11,.35)}
    .hidden{display:none !important}
  
    /* UI_NET_STOK_V1 */
    /* Net stok: büyük ve vurucu */
    .pill.netstok{
      font-weight: 950 !important;
      font-size: 18px !important;
      line-height: 1 !important;
      padding: 10px 14px !important;
      border-radius: 999px !important;
      transform: translateZ(0);
    }
    /* Kart içindeki net stok daha da öne çıksın */
    .netstokWrap{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .netstokLabel{ font-size:12px; color:#64748b; font-weight:800; letter-spacing:.2px; }
    

/* REPORT_MANAGER_V2 */
.reportGrid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:10px;
}
@media (min-width:720px){
  .reportGrid{grid-template-columns:repeat(3,minmax(0,1fr));}
}
.kpi{
  border:1px solid rgba(148,163,184,.35);
  border-radius:16px;
  padding:12px;
  background:rgba(255,255,255,.04);
}
.kpi .k{font-size:12px; opacity:.85}
.kpi .v{font-size:22px; font-weight:900; margin-top:6px}
.kpi .s{font-size:12px; opacity:.85; margin-top:6px; line-height:1.25}
.reportTitle{font-size:18px; font-weight:950; margin:0 0 6px}
.reportSub{font-size:12px; opacity:.85; margin:0 0 12px; line-height:1.35}
.reportSectionTitle{font-weight:900; margin:14px 0 8px}
.reportList{display:flex; flex-direction:column; gap:10px}
.reportItem{border:1px solid rgba(148,163,184,.25); border-radius:14px; padding:12px}
.reportItem .t{font-weight:900}
.reportItem .m{font-size:12px; opacity:.85; margin-top:6px; line-height:1.25}
.reportBadgeRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
.reportBadge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.25); opacity:.95}
.reportWarn{border-color: rgba(239,68,68,.45)}


/* REPORT_COMPACT_V1 */
:root{ --repMaxH: 220px; }
.miniScroll{
  max-height: var(--repMaxH);
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}
.repCompactNote{ font-size:12px; color:#64748b; margin-top:6px; }
@media (max-height: 740px){
  :root{ --repMaxH: 180px; }
}

</style>

<style id="detailStyle">
.detail-panel{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  height:75%;
  background:#fff;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
  box-shadow:0 -10px 30px rgba(0,0,0,.15);
  transform:translateY(100%);
  transition:.3s ease;
  z-index:9999;
  padding:20px;
  overflow:auto;
}
.detail-panel.show{
  transform:translateY(0);
}
.hidden{display:none;}
.detail-close{
  margin-top:20px;
  padding:12px;
  background:#ef4444;
  color:#fff;
  border:none;
  border-radius:12px;
  width:100%;
  font-weight:700;
}
</style>

</head>
<body>
<header>
  <div class="wrap" style="padding-bottom:14px">
    <div class="top">
      <div>
        <h1>Stok Kontrol Motoru</h1>
        <div class="sub">v1.1 — ürün + işlem (Sipariş/Dağılım/Satış/SKT/İade)</div>
      </div>
      <div class="chip" title="Bu ekran: Ürün → İşlem akışı">
        <span>İşlem modu</span><b id="modeName" style="color:var(--text)">+</b>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- SOL: Ürün + İşlem -->
    <section class="card">
      <h2>Ürün</h2>
      <div class="hint">Önce ürün ekle. Sonra işlemi o ürün için gir.</div>

      <div style="margin-top:10px" class="row">
        <input id="inpName" placeholder="Ürün adı (örn: Kaşar 600g)" autocomplete="off" />
        <button id="btnAddProd" class="btn btnOK" type="button" style="min-width:140px">Ürün Ekle</button>
      </div>
      <div class="hint" style="margin-top:6px">Enter = ürün ekler.</div>

      <div class="sep"></div>

      <h2>İşlem</h2>
      <div class="hint">Artış / Azalış ve alt tür seç. Adet yaz. İşlem ekle.</div>

      <div style="margin-top:10px" class="col">
        <select id="selProd"></select>

        <div class="row">
          <button id="btnPlus" class="btn btnOK" type="button" style="flex:1">+ Artış</button>
          <button id="btnMinus" class="btn btnBAD" type="button" style="flex:1">- Azalış</button>
        </div>

        <select id="selType"></select>

        <!-- koşullu alanlar -->
        <div id="boxExtra" class="col"></div>

        <div class="row">
          <input id="inpQty" inputmode="numeric" placeholder="Adet" />
          <button id="btnAddOp" class="btn btnBLUE" type="button" style="min-width:160px">İşlem Ekle</button>
        </div>

        <textarea id="inpNote" placeholder="Not (opsiyonel)"></textarea>

        <div class="pillRow" id="quickPills"></div>

        <div class="hint" id="logicHint" style="margin-top:4px">
          Mantık: Ürün seç → işlem türü seç → adet → işlem ekle.
        </div>
      </div>
    </section>

    <!-- SAĞ: Kayıtlar -->
    
    <!-- SAĞ: Rapor -->
    <section class="card" id="cardReport">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h2 style="margin-bottom:2px">Rapor</h2>
          <div class="hint">Özet ve “akıl” (bugün / 7 gün / 30 gün)</div>
        </div>
        <div class="row" style="gap:8px">
          <button id="btnReportToday" class="btn btnBLUE" type="button" style="padding:10px 12px;border-radius:14px">Bugün</button>
          <button id="btnReport7" class="btn btnBLUE" type="button" style="padding:10px 12px;border-radius:14px">7g</button>
          <button id="btnReport30" class="btn btnBLUE" type="button" style="padding:10px 12px;border-radius:14px">30g</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="kpi">
        <div class="k">Artış: <b id="rPlus">0</b></div>
        <div class="k">Azalış: <b id="rMinus">0</b></div>
        <div class="k">Net: <b id="rNet">0</b></div>
        <div class="k">İşlem: <b id="rOps">0</b></div>
      </div>

      <div class="sep"></div>

      <div class="row" style="gap:10px;align-items:flex-start;flex-wrap:wrap">
        <div style="flex:1;min-width:240px">
          <div class="hint" style="margin-bottom:8px">Türlere göre</div>
          <div id="rKinds" class="list"></div>
        </div>
        <div style="flex:1;min-width:240px">
          <div class="hint" style="margin-bottom:8px">En çok hareket</div>
          <div id="rTop" class="list"></div>
        </div>
      </div>

      <div class="sep"></div>
      <div class="hint" id="rRangeHint">Aralık: —</div>
    </section>

<section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h2 style="margin-bottom:2px">Kayıtlar</h2>
          <div class="hint">İşlem geçmişi + filtre</div>
        </div>
        <div class="kpi">
          <div class="k">Ürün: <b id="kProducts">0</b></div>
          <div class="k">İşlem: <b id="kOps">0</b></div>
        </div>
      </div>

      <div class="stickySearch">
        <input id="inpSearch" placeholder="Ara (sabit)..." autocomplete="off" />
      </div>

      <div class="sep"></div>

      <div id="listOps" class="list"></div>
    </section>
  </div>

<div id="mgrReportV2" style="display:none"></div>
</main>

<nav class="bottomBar" aria-label="Alt menü">
  <div class="bottomInner">
    <button id="tabProducts" class="tab active" type="button">Ürünler</button>
    <button id="tabOps" class="tab" type="button">İşlemler</button>
    <button id="tabClear" class="tab warn" type="button">Temizle</button>
  </div>
</nav>

<script>
/* ====== DATA ====== */
const KEY = "stok_kontrol_v11";
const $ = (id)=>document.getElementById(id);

function nowTs(){ return Date.now(); }
function fmtTime(ts){
  const d=new Date(ts);
  const pad=n=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

let db = JSON.parse(localStorage.getItem(KEY) || "null") || {
  products: [],     // {id,name,createdAt}
  ops: []           // {id,productId,dir,kind,qty,note,meta,ts}
};

function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }

/* ====== MODEL: TYPES ====== */
/**
dir: "plus" | "minus"
kind: string
meta: object (ek alanlar)
*/
const TYPES = {
  plus: [
    { id:"siparis_firma_magaza",   label:"Sipariş • Firma • Mağazaya ziyaret", extra:[] },
    { id:"siparis_firma_tel_geldi",label:"Sipariş • Firma • Telefon geldi", extra:[] },
    { id:"siparis_firma_tel_edildi",label:"Sipariş • Firma • Telefon edildi", extra:[] },

    { id:"siparis_depo_merkez",    label:"Sipariş • Depo • Merkez depoya", extra:[] },
    { id:"siparis_depo_sarkuteri", label:"Sipariş • Depo • Şarküteri depoya", extra:[] },

    { id:"dagilim_merkez",         label:"Dağılım • Merkez dağılımı", extra:[] },
    { id:"dagilim_normal",         label:"Dağılım • Normal", extra:[] },
    { id:"dagilim_iskonto",        label:"Dağılım • İskonto", extra:[] },

    { id:"dagilim_insert",         label:"Dağılım • İnsert", extra:[
      { id:"insertName", label:"İnsert adı", ph:"örn: Ramazan Insert", type:"text" },
      { id:"insertFrom", label:"İnsert başlangıç", ph:"YYYY-AA-GG", type:"date" },
      { id:"insertTo",   label:"İnsert bitiş", ph:"YYYY-AA-GG", type:"date" },
    ]},
  ],
  minus: [
    { id:"satis_normal",           label:"Satış • Normal", extra:[] },
    { id:"satis_iskonto",          label:"Satış • İskonto", extra:[] },
    { id:"satis_insert",           label:"Satış • İnsert", extra:[
      { id:"insertName", label:"İnsert adı", ph:"örn: Hafta Sonu Insert", type:"text" },
      { id:"insertFrom", label:"İnsert başlangıç", ph:"YYYY-AA-GG", type:"date" },
      { id:"insertTo",   label:"İnsert bitiş", ph:"YYYY-AA-GG", type:"date" },
    ]},

    { id:"azalis_skt",             label:"Azalış • SKT", extra:[] },

    { id:"iade_musteri",           label:"İade • Müşteri iadesi", extra:[] },
    { id:"iade_tarihi_gecmis",     label:"İade • Tarihi geçmiş", extra:[] },
    { id:"iade_fabrika",           label:"İade • Fabrika kaynaklı sorun", extra:[] },
    { id:"iade_raf",               label:"İade • Raf kaynaklı sorun", extra:[] },
  ]
};

/* ====== UI STATE ====== */
let mode = "plus"; // default
function setMode(m){
  mode = m;
  $("modeName").textContent = (m==="plus") ? "+" : "-";
  $("btnPlus").style.opacity = (m==="plus") ? "1" : ".65";
  $("btnMinus").style.opacity = (m==="minus") ? "1" : ".65";
  fillTypeSelect();
}

function ensureProductsSeed(){
  // hiç ürün yoksa dropdown boş kalmasın
  if(!db.products.length){
    db.products.push({id: "p_"+nowTs().toString(16), name:"(önce ürün ekle)", createdAt: nowTs(), placeholder:true});
    save();
  }
}

function realProducts(){
  return db.products.filter(p=>!p.placeholder);
}

function fillProductsSelect(){
  const sel = $("selProd");
  const prods = db.products.slice().sort((a,b)=>a.createdAt-b.createdAt);
  sel.innerHTML = "";
  for(const p of prods){
    const o=document.createElement("option");
    o.value=p.id;
    o.textContent=p.name;
    sel.appendChild(o);
  }
}

function currentTypeDef(){
  const id = $("selType").value;
  const arr = TYPES[mode] || [];
  return arr.find(x=>x.id===id) || arr[0];
}

function fillTypeSelect(){
  const sel = $("selType");
  sel.innerHTML = "";
  const arr = TYPES[mode] || [];
  for(const t of arr){
    const o=document.createElement("option");
    o.value=t.id;
    o.textContent=t.label;
    sel.appendChild(o);
  }
  buildExtraFields();
  buildQuickPills();
}

function buildExtraFields(){
  const box = $("boxExtra");
  box.innerHTML = "";
  const t = currentTypeDef();
  if(!t || !t.extra || !t.extra.length) return;

  for(const f of t.extra){
    const wrap=document.createElement("div");
    wrap.className="col";
    const lab=document.createElement("div");
    lab.className="hint";
    lab.textContent=f.label;
    const inp=document.createElement("input");
    inp.id="x_"+f.id;
    inp.placeholder=f.ph||"";
    inp.type=f.type||"text";
    wrap.appendChild(lab);
    wrap.appendChild(inp);
    box.appendChild(wrap);
  }
}

function buildQuickPills(){
  const box = $("quickPills");
  box.innerHTML = "";
  // sık kullanılanlar: her mod için 5 tane
  const quick = (mode==="plus")
    ? ["siparis_firma_tel_edildi","dagilim_merkez","dagilim_insert","dagilim_normal","siparis_depo_merkez"]
    : ["satis_normal","satis_insert","azalis_skt","iade_musteri","iade_tarihi_gecmis"];

  const arr = TYPES[mode];
  for(const id of quick){
    const t = arr.find(x=>x.id===id);
    if(!t) continue;
    const b=document.createElement("button");
    b.type="button";
    b.className="pill";
    b.textContent=t.label;
    b.onclick=()=>{ $("selType").value=t.id; buildExtraFields(); };
    box.appendChild(b);
  }
}

$("selType").addEventListener("change", buildExtraFields);

/* ====== CORE OPS ====== */
function addProduct(name){
  name = (name||"").trim();
  if(!name) return {ok:false, msg:"Ürün adı boş."};
  // placeholder varsa sil
  db.products = db.products.filter(p=>!p.placeholder);

  // aynı isim varsa tekrar ekleme (basit)
  const exists = db.products.find(p=>p.name.toLowerCase()===name.toLowerCase());
  if(exists){
    fillProductsSelect();
    $("selProd").value = exists.id;
    return {ok:true, msg:"Zaten vardı, seçtim."};
  }

  const p = {id:"p_"+nowTs().toString(16), name, createdAt: nowTs()};
  db.products.push(p);
  save();
  fillProductsSelect();
  $("selProd").value = p.id;
  return {ok:true, msg:"Ürün eklendi."};
}

function parseQty(v){
  v = (v||"").toString().trim().replace(",",".");
  // adet: tam sayı hedef
  const n = Number(v);
  if(!Number.isFinite(n)) return null;
  if(n<=0) return null;
  return Math.round(n);
}

function readExtraMeta(){
  const t = currentTypeDef();
  const meta = {};
  if(!t || !t.extra || !t.extra.length) return meta;
  for(const f of t.extra){
    const el = $("x_"+f.id);
    meta[f.id] = (el && el.value) ? el.value.trim() : "";
  }
  return meta;
}

function addOperation(){
  const pid = $("selProd").value;
  const prod = db.products.find(p=>p.id===pid && !p.placeholder);
  if(!prod) return {ok:false, msg:"Önce ürün ekle ve seç."};

  const qty = parseQty($("inpQty").value);
  if(!qty) return {ok:false, msg:"Adet geçersiz."};

  const kind = $("selType").value;
  const note = ($("inpNote").value||"").trim();
  const meta = readExtraMeta();

  // Insert seçildiyse insertName zorunlu olsun (yumuşak zorunlu)
  if((kind==="dagilim_insert" || kind==="satis_insert")){
    if(!meta.insertName){
      return {ok:false, msg:"İnsert adı boş olmasın."};
    }
  }

  const op = {
    id:"o_"+nowTs().toString(16),
    productId: pid,
    dir: mode,   // plus/minus
    kind,
    qty,
    note,
    meta,
    ts: nowTs()
  };
  db.ops.push(op);
  save();

  // temizlik
  $("inpQty").value="";
  $("inpNote").value="";
  // extra temizle
  buildExtraFields();

  renderAll();
reportToday();
  return {ok:true, msg:"İşlem eklendi."};
}

function stockOf(productId){
  let s=0;
  for(const op of db.ops){
    if(op.productId!==productId) continue;
    s += (op.dir==="plus" ? op.qty : -op.qty);
  }
  return s;
}

/* ====== RENDER ====== */
function renderOps(){
  const q = ($("inpSearch").value||"").trim().toLowerCase();
  const list = $("listOps");
  list.innerHTML = "";

  const prodMap = new Map(db.products.map(p=>[p.id,p]));
  const ops = db.ops.slice().sort((a,b)=>b.ts-a.ts);

  const filtered = ops.filter(op=>{
    const p = prodMap.get(op.productId);
    const name = (p?p.name:"").toLowerCase();
    const kindLabel = (TYPES.plus.concat(TYPES.minus).find(x=>x.id===op.kind)?.label || op.kind).toLowerCase();
    const note = (op.note||"").toLowerCase();
    if(!q) return true;
    return name.includes(q) || kindLabel.includes(q) || note.includes(q);
  });

  if(!filtered.length){
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML = `<div class="muted">İşlem yok.</div><div class="hint" style="margin-top:6px">Henüz işlem yok. Ürün ekle → işlem gir.</div>`;
    list.appendChild(d);
    return;
  }

  for(const op of filtered){
    const p = prodMap.get(op.productId);
    const pname = p ? p.name : "(silinmiş ürün)";
    const tdef = TYPES.plus.concat(TYPES.minus).find(x=>x.id===op.kind);
    const label = tdef ? tdef.label : op.kind;

    const delta = (op.dir==="plus") ? `+${op.qty}` : `-${op.qty}`;
    const deltaCls = (op.dir==="plus") ? "deltaPlus" : "deltaMinus";

    const st = stockOf(op.productId);
    const metaParts = [];
    if(op.meta){
      if(op.meta.insertName) metaParts.push(`İnsert: ${op.meta.insertName}`);
      if(op.meta.insertFrom || op.meta.insertTo){
        const a = op.meta.insertFrom || "—";
        const b = op.meta.insertTo || "—";
        metaParts.push(`Tarih: ${a} → ${b}`);
      }
    }

    const el=document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <div class="itemTop">
        <div>
          <div style="font-weight:900">${pname}</div>
          <div class="hint">${label}</div>
        </div>
        <div style="text-align:right">
          <div class="${deltaCls}" style="font-weight:900;font-size:16px">${delta}</div>
          <div class="hint">Stok: ${st}</div>
        </div>
      </div>
      <div class="sep" style="margin:10px 0"></div>
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div class="hint">${fmtTime(op.ts)}</div>
        <div class="tag">${op.dir==="plus" ? "Artış" : "Azalış"}</div>
      </div>
      ${metaParts.length ? `<div class="hint" style="margin-top:8px">${metaParts.join(" • ")}</div>` : ""}
      ${op.note ? `<div style="margin-top:8px" class="muted">${op.note}</div>` : ""}
    `;
    list.appendChild(el);
  }
}

function renderKPIs(){
  $("kProducts").textContent = String(realProducts().length);
  $("kOps").textContent = String(db.ops.length);
}

function renderAll(){
  ensureProductsSeed();
  fillProductsSelect();
  renderOps();
  renderKPIs();
}


/* ====== REPORT (v1.2) ====== */
function kindGroup(kind){
  if(kind.startsWith("siparis_")) return "Sipariş";
  if(kind.startsWith("dagilim_")) return "Dağılım";
  if(kind.startsWith("satis_")) return "Satış";
  if(kind.startsWith("azalis_skt")) return "SKT";
  if(kind.startsWith("iade_")) return "İade";
  return "Diğer";
}

function reportForDays(days){
  const end = Date.now();
  const start = end - (days*24*60*60*1000);

  const inRange = (op)=> op.ts >= start && op.ts <= end;

  let plus=0, minus=0, ops=0;
  const kindCount = new Map();        // group => count
  const productMove = new Map();      // productId => abs movement
  const productMap = new Map(db.products.map(p=>[p.id,p]));

  for(const op of db.ops){
    if(!inRange(op)) continue;
    ops++;
    if(op.dir==="plus") plus += op.qty;
    else minus += op.qty;

    const g = kindGroup(op.kind);
    kindCount.set(g, (kindCount.get(g)||0)+1);

    const mv = Math.abs(op.qty);
    productMove.set(op.productId, (productMove.get(op.productId)||0)+mv);
  }

  const net = plus - minus;

  // KPI
  $("rPlus").textContent = String(plus);
  $("rMinus").textContent = String(minus);
  $("rNet").textContent = String(net);
  $("rOps").textContent = String(ops);

  // Kinds list
  const rk = $("rKinds");
  rk.innerHTML = "";
  const kindsSorted = [...kindCount.entries()].sort((a,b)=>b[1]-a[1]);
  if(!kindsSorted.length){
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML = `<div class="muted">Bu aralıkta işlem yok.</div>`;
    rk.appendChild(d);
  }else{
    for(const [k,c] of kindsSorted){
      const el=document.createElement("div");
      el.className="item";
      el.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px">
        <div style="font-weight:900">${k}</div>
        <div class="tag">${c} işlem</div>
      </div>`;
      rk.appendChild(el);
    }
  }

  // Top movers
  const rt = $("rTop");
  rt.innerHTML = "";
  const top = [...productMove.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
  if(!top.length){
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML = `<div class="muted">Hareket yok.</div>`;
    rt.appendChild(d);
  }else{
    for(const [pid,mv] of top){
      const p = productMap.get(pid);
      const name = p ? p.name : "(silinmiş ürün)";
      const el=document.createElement("div");
      el.className="item";
      el.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px">
        <div style="font-weight:900">${name}</div>
        <div class="tag">${mv} adet</div>
      </div>`;
      rt.appendChild(el);
    }
  }

  // Range hint
  const d0 = new Date(start);
  const d1 = new Date(end);
  const pad=n=>String(n).padStart(2,"0");
  const f=(d)=>`${pad(d.getDate())}.${pad(d.getMonth()+1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  $("rRangeHint").textContent = `Aralık: ${f(d0)} → ${f(d1)} (${days} gün)`;
}

function reportToday(){
  // “bugün” = gün başından şimdiye
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const end = Date.now();

  let plus=0, minus=0, ops=0;
  const kindCount = new Map();
  const productMove = new Map();
  const productMap = new Map(db.products.map(p=>[p.id,p]));
  const inRange = (op)=> op.ts >= start && op.ts <= end;

  for(const op of db.ops){
    if(!inRange(op)) continue;
    ops++;
    if(op.dir==="plus") plus += op.qty;
    else minus += op.qty;

    const g = kindGroup(op.kind);
    kindCount.set(g, (kindCount.get(g)||0)+1);

    const mv = Math.abs(op.qty);
    productMove.set(op.productId, (productMove.get(op.productId)||0)+mv);
  }

  $("rPlus").textContent = String(plus);
  $("rMinus").textContent = String(minus);
  $("rNet").textContent = String(plus - minus);
  $("rOps").textContent = String(ops);

  const rk = $("rKinds");
  rk.innerHTML = "";
  const kindsSorted = [...kindCount.entries()].sort((a,b)=>b[1]-a[1]);
  if(!kindsSorted.length){
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML = `<div class="muted">Bugün işlem yok.</div>`;
    rk.appendChild(d);
  }else{
    for(const [k,c] of kindsSorted){
      const el=document.createElement("div");
      el.className="item";
      el.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px">
        <div style="font-weight:900">${k}</div>
        <div class="tag">${c} işlem</div>
      </div>`;
      rk.appendChild(el);
    }
  }

  const rt = $("rTop");
  rt.innerHTML = "";
  const top = [...productMove.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
  if(!top.length){
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML = `<div class="muted">Hareket yok.</div>`;
    rt.appendChild(d);
  }else{
    for(const [pid,mv] of top){
      const p = productMap.get(pid);
      const name = p ? p.name : "(silinmiş ürün)";
      const el=document.createElement("div");
      el.className="item";
      el.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px">
        <div style="font-weight:900">${name}</div>
        <div class="tag">${mv} adet</div>
      </div>`;
      rt.appendChild(el);
    }
  }

  const pad=n=>String(n).padStart(2,"0");
  const f=(d)=>`${pad(d.getDate())}.${pad(d.getMonth()+1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  $("rRangeHint").textContent = `Aralık: ${f(new Date(start))} → ${f(new Date(end))} (Bugün)`;
}

/* ====== TABS ====== */
let tab="products"; // products | ops
function setTab(t){
  tab=t;
  $("tabProducts").classList.toggle("active", t==="products");
  $("tabOps").classList.toggle("active", t==="ops");

  // Bu demo aşamasında tek sayfa: butonlar sadece “odak” verir.
  if(t==="products"){
    $("inpName").scrollIntoView({behavior:"smooth",block:"center"});
  }else if(t==="ops"){
    $("listOps").scrollIntoView({behavior:"smooth",block:"start"});
  }
}

$("tabProducts").onclick=()=>setTab("products");
$("tabOps").onclick=()=>setTab("ops");
$("tabClear").onclick=()=>{
  const ok = confirm("Tüm veriyi silmek istiyor musun? (Ürünler + İşlemler)");
  if(!ok) return;
  db = {products:[], ops:[]};
  save();
  renderAll();
};

/* ====== EVENTS ====== */
$("btnPlus").onclick=()=>setMode("plus");
$("btnMinus").onclick=()=>setMode("minus");

$("btnAddProd").onclick=()=>{
  const r=addProduct($("inpName").value);
  if(!r.ok){ alert(r.msg); return; }
  $("inpName").value="";
  renderAll();
};

$("inpName").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    $("btnAddProd").click();
  }
});

$("btnAddOp").onclick=()=>{
  const r=addOperation();
  if(!r.ok){ alert(r.msg); return; }
};

$("inpSearch").addEventListener("input", ()=>renderOps());

/* init */
$("btnReportToday").onclick=()=>{ reportToday(); };
$("btnReport7").onclick=()=>{ reportForDays(7); };
$("btnReport30").onclick=()=>{ reportForDays(30); };

ensureProductsSeed();
setMode("plus");
renderAll();

/* REPORT_COMPACT_V1_JS */
(function(){
  function apply(){
    // Rapor içinde olma ihtimali yüksek listeleri yakala:
    document.querySelectorAll(
      '#report .list, #screenReport .list, #viewReport .list, .report .list, [id^="rep"] .list, [id^="repList"], [id^="rep"]'
    ).forEach(el=>{
      // sadece gerçekten uzun olabilecek bloklara uygula
      if(el && el.classList && !el.classList.contains("miniScroll")){
        // İçinde çok item varsa veya zaten "list" ise
        const isListy = el.classList.contains("list") || el.querySelector(".item") || el.children.length >= 6;
        if(isListy) el.classList.add("miniScroll");
      }
    });

    // Rapor başına küçük not (varsa)
    const rep = document.querySelector("#report, #screenReport, #viewReport, .report");
    if(rep && !rep.querySelector(".repCompactNote")){
      const note = document.createElement("div");
      note.className = "repCompactNote";
      note.textContent = "Rapor: uzun listeler bu kutunun içinde kayar (tek ekranda kalır).";
      rep.prepend(note);
    }
  }

  window.addEventListener("load", ()=>setTimeout(apply, 200));
  document.addEventListener("click", ()=>setTimeout(apply, 50));
  document.addEventListener("input", ()=>setTimeout(apply, 80));

  // Eğer uygulamada render/yenileme fonksiyonu varsa yakalamaya çalış (zararsız)
  try{
    const oldRender = window.renderAll || window.render || null;
    if(typeof oldRender === "function"){
      const name = window.renderAll ? "renderAll" : "render";
      window[name] = function(){
        const r = oldRender.apply(this, arguments);
        setTimeout(apply, 0);
        return r;
      };
    }
  }catch(_){}
})();

</script>

<script>
/* UI_NET_STOK_DOM_PATCH_V1 */
(function(){
  function apply(){
    try{
      const pills = document.querySelectorAll('.pill');
      for(const el of pills){
        const t = (el.textContent||"").trim().toLowerCase();
        if(t.startsWith("net") || t.startsWith("net stok") || t.startsWith("net:") || t.startsWith("netstok")){
          el.classList.add("netstok");
        }
      }
    }catch(_e){}
  }
  // İlk yükleme + ufak gecikme (render sonra)
  apply();
  setTimeout(apply, 120);
  setTimeout(apply, 500);
})();
</script>


<div id="productDetail" class="detail-panel hidden">
  <h3 id="detailTitle"></h3>
  <div id="detailOps"></div>
  <button id="detailClose" class="detail-close">Kapat</button>
</div>


<script>
function openDetail(productId){
  if(!window.db) return;
  const product=db.products.find(p=>p.id===productId);
  if(!product) return;

  const ops=db.ops.filter(o=>o.productId===productId);

  document.getElementById("detailTitle").textContent=product.name;

  const box=document.getElementById("detailOps");
  box.innerHTML="";

  if(!ops.length){
    box.innerHTML="<div>Bu ürüne ait işlem yok.</div>";
  }

  ops.forEach(o=>{
    const row=document.createElement("div");
    row.style.padding="8px 0";
    row.textContent=
      new Date(o.ts).toLocaleString() +
      " - " + o.type +
      " (" + o.qty + ")";
    box.appendChild(row);
  });

  const panel=document.getElementById("productDetail");
  panel.classList.remove("hidden");
  setTimeout(()=>panel.classList.add("show"),10);
}

document.addEventListener("click",function(e){
  if(e.target.dataset && e.target.dataset.pid){
    openDetail(e.target.dataset.pid);
  }
});

document.getElementById("detailClose")?.addEventListener("click",function(){
  const panel=document.getElementById("productDetail");
  panel.classList.remove("show");
  setTimeout(()=>panel.classList.add("hidden"),300);
});


// ===== v1.6 ANALYTICS CORE (auto-insert) =====
function analyzeProduct(productId){
  const now = Date.now();
  const days30 = 30 * 24 * 60 * 60 * 1000;

  const ops = (db.ops || []).filter(o => o.productId === productId);

  let totalIn = 0;
  let totalOut = 0;

  let last30Sales = 0;
  let insertSales = 0;
  let normalSales = 0;

  let returnQty = 0;
  let distributionQty = 0;

  for(const o of ops){
    const qty = Number(o.qty || 0);

    if(o.direction === "in") totalIn += qty;
    if(o.direction === "out") totalOut += qty;

    const t = String(o.type || "");

    // Son 30 gün satış
    if(o.direction === "out" && t.includes("Satış")){
      if(now - (Number(o.ts||0)) <= days30){
        last30Sales += qty;
      }
    }

    // Insert satış
    if(o.direction === "out" && t.includes("Satış") && t.includes("Insert")){
      insertSales += qty;
    }

    // Normal satış (Insert değilse)
    if(o.direction === "out" && t.includes("Satış") && !t.includes("Insert")){
      normalSales += qty;
    }

    // İade
    if(o.direction === "out" && t.includes("İade")){
      returnQty += qty;
    }

    // Dağılım (stok artış kaynaklarından biri)
    if(o.direction === "in" && t.includes("Dağılım")){
      distributionQty += qty;
    }
  }

  const netStock = totalIn - totalOut;

  // Oranlar
  const returnRate = totalOut > 0 ? (returnQty / totalOut) : 0;
  const distributionEfficiency = distributionQty > 0 ? (normalSales / distributionQty) : 0;
  const insertShare = (normalSales + insertSales) > 0 ? (insertSales / (normalSales + insertSales)) : 0;

  // Skor (0-100): basit ama yönetici bakışına uygun başlangıç
  // + satış (last30Sales) iyi
  // + dağılım verimi iyi
  // - iade oranı kötü
  // - net stok çok şişikse hafif kırp
  let score = 0;

  // satış katkısı: 0..40
  score += Math.min(40, last30Sales * 2);

  // verim katkısı: 0..35
  score += Math.max(0, Math.min(35, distributionEfficiency * 35));

  // iade cezası: 0..20
  score -= Math.min(20, returnRate * 100 * 0.4);

  // stok şişmesi cezası: 0..10
  if(netStock > 20) score -= Math.min(10, (netStock - 20) * 0.2);

  // insert payı şu an nötr (ileride “insert dönemi” tarih aralığı eklenince anlam kazanacak)
  // score += 0;

  score = Math.max(0, Math.min(100, Math.round(score)));

  return {
    totalIn, totalOut, netStock,
    last30Sales, insertSales, normalSales,
    returnQty, distributionQty,
    returnRate, distributionEfficiency, insertShare,
    score,
    opsCount: ops.length
  };
}
// ===== /v1.6 ANALYTICS CORE =====

</script>

<script>

/* REPORT_MANAGER_V2 */
(function(){
  function safeNum(x){ x=Number(x); return Number.isFinite(x)?x:0; }
  function toTRDate(ts){ try{return new Date(ts).toLocaleString("tr-TR")}catch(_){return ""} }
  function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function getDB(){
    // Bu projede DB anahtarı farklı olabilir; global KEY varsa yakalarız.
    // En risksiz: localStorage içinde "stok_kontrol" ile başlayan ilk key'i bul.
    try{
      const keys = Object.keys(localStorage||{});
      let k = keys.find(k=>k==="stok_kontrol_v1") || keys.find(k=>k.startsWith("stok_kontrol_")) || keys.find(k=>k.includes("stok_kontrol"));
      if(!k) return {key:null, db:{products:[], ops:[]}};
      const raw = localStorage.getItem(k);
      const db = JSON.parse(raw||"null") || {};
      return {key:k, db};
    }catch(_){
      return {key:null, db:{products:[], ops:[]}};
    }
  }

  function normalize(db){
    // farklı sürümler için tolerans:
    const products = db.products || db.items || [];
    const ops = db.ops || db.operations || [];
    return {products:Array.isArray(products)?products:[], ops:Array.isArray(ops)?ops:[]};
  }

  function summarize({products, ops}){
    const now = Date.now();
    const day = 24*60*60*1000;

    const byRange = (ms)=> ops.filter(o => safeNum(o.ts||o.time||0) >= now - ms);

    const last1d = byRange(1*day);
    const last7d = byRange(7*day);
    const last30d = byRange(30*day);

    const countTypes = (arr)=>{
      const m = {};
      for(const o of arr){
        const t = String(o.type || o.kind || "Bilinmiyor");
        m[t] = (m[t]||0)+1;
      }
      return m;
    };

    const types30 = countTypes(last30d);

    // Top ürünler (30g) — hareket sayısına göre
    const prodMov = {};
    for(const o of last30d){
      const pid = o.pid || o.productId || o.itemId || "";
      const name = String(o.pname || o.name || o.productName || "");
      const key = pid || name || "Bilinmeyen";
      prodMov[key] = prodMov[key] || {name: name||key, n:0};
      prodMov[key].n += 1;
    }
    const topProducts = Object.values(prodMov).sort((a,b)=>b.n-a.n).slice(0,8);

    // “Uyarılar”: negatif stok görünen ürün, aşırı iade/SKT vs.
    // (stok hesabı projede farklı olabilir; sadece kaba kontrol)
    const warns = [];
    for(const p of products){
      const stock = safeNum(p.stock ?? p.qty ?? p.net ?? 0);
      if(stock < 0) warns.push(`Negatif stok: ${p.name||p.title||"Ürün"} (${stock})`);
    }
    // SKT / iade sayısı (30g)
    const sktCount = safeNum(types30["SKT"]);
    const iadeCount = safeNum(types30["İade"] || types30["IADE"] || types30["iade"]);
    if(sktCount >= 10) warns.push(`SKT işlemi yüksek (30g): ${sktCount}`);
    if(iadeCount >= 10) warns.push(`İade işlemi yüksek (30g): ${iadeCount}`);

    return {
      meta: { nowTR: new Date().toLocaleString("tr-TR"), prodCount: products.length, opsCount: ops.length },
      kpi: {
        ops1d: last1d.length,
        ops7d: last7d.length,
        ops30d: last30d.length,
        types30,
        topProducts,
        warns
      },
      lastOps: ops.slice().sort((a,b)=>safeNum(b.ts||b.time||0)-safeNum(a.ts||a.time||0)).slice(0,8)
    };
  }

  function mount(){
    const host = document.getElementById("mgrReportV2");
    if(!host) return;

    const {db} = getDB();
    const norm = normalize(db);
    const sum = summarize(norm);

    host.style.display = "block";
    host.innerHTML = `
      <div class="reportTitle">Yönetici Raporu</div>
      <div class="reportSub">${esc(sum.meta.nowTR)} • Ürün: <b>${sum.meta.prodCount}</b> • İşlem: <b>${sum.meta.opsCount}</b>
        <span style="opacity:.7"> (Bu özet son 30 gün ağırlıklı)</span>
      </div>

      <div class="reportGrid">
        <div class="kpi">
          <div class="k">Bugün işlem</div>
          <div class="v">${sum.kpi.ops1d}</div>
          <div class="s">Gün içi tempo göstergesi</div>
        </div>
        <div class="kpi">
          <div class="k">7 gün işlem</div>
          <div class="v">${sum.kpi.ops7d}</div>
          <div class="s">Haftalık hareketlilik</div>
        </div>
        <div class="kpi">
          <div class="k">30 gün işlem</div>
          <div class="v">${sum.kpi.ops30d}</div>
          <div class="s">Aylık hareketlilik</div>
        </div>
      </div>

      <div class="reportSectionTitle">Tür dağılımı (30g)</div>
      <div class="reportList">
        ${Object.entries(sum.kpi.types30).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([t,n])=>`
          <div class="reportItem">
            <div class="t">${esc(t)}</div>
            <div class="reportBadgeRow">
              <span class="reportBadge">${n} işlem</span>
            </div>
          </div>
        `).join("") || `<div class="reportItem"><div class="m">Kayıt yok.</div></div>`}
      </div>

      <div class="reportSectionTitle">En hareketli ürünler (30g)</div>
      <div class="reportList">
        ${sum.kpi.topProducts.map(p=>`
          <div class="reportItem">
            <div class="t">${esc(p.name)}</div>
            <div class="reportBadgeRow">
              <span class="reportBadge">${p.n} hareket</span>
            </div>
          </div>
        `).join("") || `<div class="reportItem"><div class="m">Kayıt yok.</div></div>`}
      </div>

      <div class="reportSectionTitle">Uyarılar</div>
      <div class="reportList">
        ${(sum.kpi.warns||[]).map(w=>`
          <div class="reportItem reportWarn">
            <div class="t">Dikkat</div>
            <div class="m">${esc(w)}</div>
          </div>
        `).join("") || `<div class="reportItem"><div class="m">Şimdilik belirgin uyarı yok.</div></div>`}
      </div>

      <div class="reportSectionTitle">Son işlemler</div>
      <div class="reportList">
        ${sum.lastOps.map(o=>`
          <div class="reportItem">
            <div class="t">${esc(o.type||o.kind||"İşlem")}</div>
            <div class="m">${esc(o.pname||o.name||o.productName||"")} ${o.qty!=null?(" • adet: "+esc(o.qty)):""}</div>
            <div class="reportBadgeRow">
              <span class="reportBadge">${esc(toTRDate(o.ts||o.time||0))}</span>
            </div>
          </div>
        `).join("") || `<div class="reportItem"><div class="m">İşlem yok.</div></div>`}
      </div>
    `;
  }

  // dışarıdan da çağrılabilsin (debug)
  window.__SK_REPORT_V2__ = mount;

  // Sayfa yüklenince bir kez dene (Rapor sekmesi yoksa bile zarar vermez)
  window.addEventListener("load", ()=>{ try{ mount(); }catch(_){} }, {once:true});
})();

</script>
</body>
</html>

<!-- REPORT_COMPACT_V2 -->
<script>
(function(){

  function findReportRoot(){
    return document.querySelector('#screenReport, #report, [data-screen="report"]');
  }

  function compact(){
    const root = findReportRoot();
    if(!root) return;

    const cards = root.querySelectorAll('.card');
    if(cards.length < 3) return;

    if(root.querySelector('#reportDetailsV2')) return;

    const details = document.createElement('details');
    details.id = "reportDetailsV2";

    const summary = document.createElement('summary');
    summary.innerText = "Detayları Aç / Kapat";
    summary.style.fontWeight = "900";
    summary.style.cursor = "pointer";
    summary.style.padding = "12px";
    summary.style.border = "1px solid #ddd";
    summary.style.borderRadius = "12px";
    summary.style.marginTop = "10px";
    details.appendChild(summary);

    const body = document.createElement('div');
    body.style.maxHeight = "50vh";
    body.style.overflow = "auto";
    body.style.marginTop = "8px";

    for(let i=2;i<cards.length;i++){
      body.appendChild(cards[i]);
    }

    details.appendChild(body);
    cards[1].after(details);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    setTimeout(compact,300);
  });

})();
</script>


<script>
/* ================================
   v1.4 ANALYTICS ENGINE
================================ */

function analyzeProduct(productId){
  const now = Date.now();
  const days30 = now - (30*24*60*60*1000);

  const ops = db.ops.filter(o => o.productId === productId);

  let totalIn = 0;
  let totalOut = 0;
  let totalSales = 0;
  let last30Sales = 0;
  let insertSales = 0;
  let totalReturn = 0;

  for(const o of ops){
    const qty = Number(o.qty)||0;

    if(o.direction === "in") totalIn += qty;
    if(o.direction === "out") totalOut += qty;

    if(o.type === "satış"){
      totalSales += qty;
      if(o.ts >= days30) last30Sales += qty;
      if(o.subtype && o.subtype.toLowerCase().includes("insert")){
        insertSales += qty;
      }
    }

    if(o.type === "iade"){
      totalReturn += qty;
    }
  }

  const netStock = totalIn - totalOut;

  const salesPower = totalIn > 0 ? last30Sales / totalIn : 0;
  const returnRate = totalOut > 0 ? totalReturn / totalOut : 0;
  const insertImpact = totalSales > 0 ? insertSales / totalSales : 0;

  const score =
      (salesPower * 50)
    + (insertImpact * 20)
    - (returnRate * 20)
    + (netStock > 0 ? 10 : -10);

  return {
    totalIn,
    totalOut,
    netStock,
    last30Sales,
    insertImpact,
    returnRate,
    score: Math.round(score)
  };
}

function analyzeAllProducts(){
  return db.items.map(it => ({
    id: it.id,
    name: it.name,
    ...analyzeProduct(it.id)
  })).sort((a,b)=>b.score-a.score);
}
</script>

