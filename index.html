<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stok Kontrol Motoru</title>
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{
      --bg:#070b14; --card:#0b1220; --card2:#0d1730;
      --text:#e5e7eb; --muted:#94a3b8; --line:rgba(255,255,255,.08);
      --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b; --blue:#2563eb;
      --r:20px; --pad:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070b14,#05070f);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(7,11,20,.72);backdrop-filter: blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:920px;margin:0 auto;padding:14px 14px 18px}
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.15fr .85fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px;font-size:15px}
    .hint{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    input,select,textarea{
      width:100%; background:rgba(255,255,255,.03); color:var(--text);
      border:1px solid var(--line); border-radius:16px; padding:12px 12px;
      outline:none; font-size:14px;
    }
    input::placeholder,textarea::placeholder{color:rgba(148,163,184,.7)}
    .btn{
      border:0; border-radius:16px; padding:12px 14px; font-weight:900;
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer;
      border:1px solid rgba(255,255,255,.08);
      user-select:none;
    }
    .btnOK{background:rgba(22,163,74,.18); border-color:rgba(22,163,74,.35)}
    .btnBAD{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.35)}
    .btnBLUE{background:rgba(37,99,235,.16); border-color:rgba(37,99,235,.35)}
    .btn:active{transform:translateY(1px)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);font-size:12px}
    .kpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .kpi .pill{justify-content:center;font-weight:900}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{padding:12px;border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.03)}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .name{font-weight:950}
    .muted{color:var(--muted);font-size:12px;margin-top:4px}
    .miniRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted)}
    .netBig{font-size:26px;font-weight:1000;letter-spacing:.3px}
    .netBox{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .smallBtn{padding:10px 12px;border-radius:14px}
    .danger{color:#fecaca}
    /* REPORT_COMPACT_V2 */
    #cardReport{max-height: calc(100vh - 150px); overflow:auto; -webkit-overflow-scrolling: touch;}
    #cardReport .row:first-of-type{position: sticky; top:0; z-index:5; background: var(--card, #fff); padding-top:10px; padding-bottom:10px;}
    #cardReport .hr{margin:10px 0}
    /* ERROR_GUARD */
    #errorGuardBox{position:fixed;left:0;right:0;bottom:0;background:#7f1d1d;color:#fff;padding:12px;font-size:12px;display:none;z-index:99999;max-height:40vh;overflow:auto;border-top:2px solid #ef4444}
  
/* MODAL_ONEHAND_V1 */
#modal .card{
  position:relative;
}
#modal .onehandBar{
  position: sticky;
  bottom: 0;
  z-index: 20;
  background: rgba(11,18,32,.92);
  backdrop-filter: blur(8px);
  border-top: 1px solid rgba(255,255,255,.08);
  padding-top: 10px;
  padding-bottom: 10px;
  margin-top: 12px;
}
#modal .onehandBar .btn{ width: 100%; padding: 14px 16px; border-radius: 18px; }
#modal .fastTypeRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
#modal .fastTypeRow .btn{
  padding:10px 12px;
  border-radius: 999px;
  font-weight: 900;
}
#modal #opQty{
  font-size: 16px;
  font-weight: 900;
}


/* QUICK_QTY_V1 */
#quickQtyRow .btn{
  padding:10px 12px;
  border-radius:999px;
  font-weight:950;
}


/* V12_KOLI_MODE_MODAL_OPAQUE_V2 */
#modal{background:rgba(0,0,0,.78) !important;}
.modalCard{
  background: var(--card) !important;
  border: 1px solid var(--line) !important;
  box-shadow: 0 18px 50px rgba(0,0,0,.55) !important;
}
.modeBtn{padding:10px 12px;border-radius:999px}
.modeBtnOn{background:rgba(37,99,235,.22);border-color:rgba(37,99,235,.45)}
.modeHint{color:var(--muted);font-size:12px;margin-top:6px}


/* V15_UNDO_DELETE_OPS */
.btnMini{
  padding:8px 10px;
  border-radius:12px;
  font-size:12px;
  font-weight:900;
}
.btnDel{
  background:rgba(239,68,68,.14);
  border-color:rgba(239,68,68,.35);
}

</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Stok Kontrol Motoru</h1>
        <div class="sub">v1 ‚Äî √ºr√ºn + i≈ülemler + rapor + ‚Äúakƒ±l‚Äù √ßekirdeƒüi</div>
      </div>
      <div class="chip" id="chipMeta">Local ‚Ä¢ Hazƒ±r</div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- SOL -->
    <section class="card">
      <h2>√úr√ºn</h2>
      <div class="hint">√úr√ºn ekle / ara / stok kartlarƒ±</div>
      <div class="row" style="margin-top:10px">
        <input id="inProd" placeholder="√úr√ºn adƒ± (Enter = ekle)" />
        <button class="btn btnOK" id="btnAddProd" type="button">Ekle</button>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="inSearch" placeholder="Ara (sabit)" />
        <button class="btn smallBtn" id="btnClearSearch" type="button">Temizle</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="pill">Toplam: <b id="pCount">0</b></div>
        <button class="btn btnBLUE" id="btnAddOp" type="button">ƒ∞≈ülem Ekle</button>
      </div>

      <div class="list" id="prodList"></div>
    </section>

    <!-- SAƒû: RAPOR -->
    <section class="card" id="cardReport">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2 style="margin-bottom:2px">Rapor</h2>
          <div class="hint">√ñzet ve ‚Äúakƒ±l‚Äù (bug√ºn / 7 g√ºn / 30 g√ºn)</div>
        </div>
        <div class="row">
          <button id="btnReportToday" class="btn btnBLUE" type="button">Bug√ºn</button>
          <button id="btnReport7" class="btn btnBLUE" type="button">7g</button>
          <button id="btnReport30" class="btn btnBLUE" type="button">30g</button>
          <button id="btnUndo" class="btn" type="button">Geri Al</button>
        </div>
      </div>

      <div class="kpi">
        <div class="pill">Artƒ±: <b id="rPlus">0</b></div>
        <div class="pill">Eksi: <b id="rMinus">0</b></div>
        <div class="pill">Net: <b id="rNet">0</b></div>
      </div>

      <div class="hr"></div>
      <div class="hint">En √ßok √ºr√ºnler</div>
      <div class="list" id="rTop"></div>

      <div class="hr"></div>
      <div class="hint">T√ºr daƒüƒ±lƒ±mƒ±</div>
      <div class="list" id="rTypes"></div>

      <div class="hr"></div>
      <div class="hint">Akƒ±l</div>
      <div class="list" id="rBrain"></div>

      <div class="hr"></div>
      <button class="btn" id="btnSkorTest" type="button">Skor Test (debug)</button>
      <div class="hint" style="margin-top:8px">Sadece test: ilk √ºr√ºne g√∂re skor/√ßƒ±ktƒ± verir.</div>
    </section>
  </div>
</main>

<!-- MODAL -->
<div id="modal" style="position:fixed;inset:0;display:none;z-index:9999;background:rgba(0,0,0,.6);padding:14px">
  <div class="card" modalCard style="max-width:720px;margin:0 auto;max-height:85vh;overflow:auto">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="name">ƒ∞≈ülem Ekle</div>
        <div class="hint">√úr√ºn se√ß ‚Üí t√ºr se√ß ‚Üí alt kƒ±rƒ±lƒ±m (varsa) ‚Üí adet</div>
      </div>
      <button class="btn" id="btnClose" type="button">Kapat</button>
    </div>

    <div class="hr"></div>

    <div class="row">
      <select id="opProd"></select>

      <div class="row" style="gap:8px">
        <button class="btn modeBtn modeBtnOn" id="btnModeAdet" type="button">Adet</button>
        <button class="btn modeBtn" id="btnModeKoli" type="button">Koli</button>
      </div>
    </div>

    <!-- ADET MODU -->
    <div id="wrapAdet">
      <div class="row" style="margin-top:10px">
        <input id="opQty" inputmode="numeric" placeholder="Adet (√∂rn 3)" />
      </div>
      <div class="hint">Hƒ±zlƒ± adet</div>
      <div class="miniRow" id="quickQtyRow"></div>
    </div>

    <!-- KOLƒ∞ MODU -->
    <div id="wrapKoli" style="display:none">
      <div class="row" style="margin-top:10px">
        <input id="opPackCount" inputmode="numeric" placeholder="Koli sayƒ±sƒ± (√∂rn 2)" />
        <input id="opPackSize" inputmode="numeric" placeholder="Koli i√ßi adet (√∂rn 12)" />
      </div>

      <div class="hint">Hƒ±zlƒ± koli sayƒ±sƒ±</div>
      <div class="miniRow" id="quickPackRow"></div>

      <div class="modeHint">Toplam adet: <b id="opPackTotal">0</b> (koli√ói√ß adet)</div>
      <div class="modeHint">Not: Koli i√ßi adet girersen sistem bunu bu √ºr√ºne hatƒ±rlar.</div>
    </div>

    <div class="hint">Hƒ±zlƒ± adet / koli</div>
    <div class="miniRow" id="quickQtyRow"></div>


    <div class="miniRow" id="qtyRow" style="margin-top:8px"></div>

    <div class="hint">Hƒ±zlƒ± t√ºr (tek dokunu≈ü)</div>
    <div class="fastTypeRow" id="fastTypeRow"></div>

    <div class="row">
      <select id="opType"></select>
      <select id="opSub"></select>
    </div>

    <div class="row">
      <input id="opNote" placeholder="Not (opsiyonel)" />
    </div>

    <div class="onehandBar">
      <button class="btn btnOK" id="btnSaveOp" type="button">Kaydet</button>
    </div>

    <div class="hr"></div>
    <div class="hint">Hƒ±zlƒ± se√ßim (tek dokunu≈ü)</div>
    <div class="miniRow" id="quickRow"></div>
  </div>
</div>

<div id="errorGuardBox"><b>Sistem Hatasƒ±:</b><br><div id="errorGuardText"></div></div>

<script>
/* FAST_OPS_V1 */
/* MODAL_ONEHAND_V1 */
/* QUICK_QTY_V1 */
/* V12_KOLI_MODE_MODAL_OPAQUE_V2 */
/* V14_FASTOPS_SOLID */
/* V15_UNDO_DELETE_OPS */
/* ====== CORE DB ====== */
// V15: Undo / Delete altyapƒ±sƒ±
function ensureMeta(db){
  if(!db.meta || typeof db.meta!=="object") db.meta={};
  if(!Array.isArray(db.meta.undoStack)) db.meta.undoStack=[];
  return db;
}

function rememberUndo(db){
  ensureMeta(db);
  try{
    const last = (db.ops && db.ops.length) ? db.ops[db.ops.length-1] : null;
    if(last && last.id){
      db.meta.undoStack.push(last.id);
      // ≈üi≈ümesin
      if(db.meta.undoStack.length>60) db.meta.undoStack = db.meta.undoStack.slice(-60);
      db.meta.lastOpId = last.id;
    }
  }catch(e){}
}

function removeOpById(db, opId){
  if(!opId) return False
  let idx = -1
  for(let i=0;i<(db.ops||[]).length;i++){
    if(db.ops[i] && db.ops[i].id===opId){ idx=i; break; }
  }
  if(idx<0) return false;

  db.ops.splice(idx,1);

  // undoStack‚Äôten de temizle (t√ºm kopyalar)
  ensureMeta(db);
  db.meta.undoStack = (db.meta.undoStack||[]).filter(x=>x!==opId);
  if(db.meta.lastOpId===opId) db.meta.lastOpId = db.meta.undoStack.length ? db.meta.undoStack[db.meta.undoStack.length-1] : null;
  return true;
}

function undoLast(){
  const db=ensureMeta(loadDB());
  const st=db.meta.undoStack||[];
  if(!st.length){
    alert("Geri alƒ±nacak i≈ülem yok.");
    return;
  }
  const opId = st.pop();
  const ok = removeOpById(db, opId);
  saveDB(db);
  renderProducts();
  if(!ok) alert("ƒ∞≈ülem bulunamadƒ± (zaten silinmi≈ü olabilir).");
}

function deleteOp(opId, pid){
  const db=ensureMeta(loadDB());
  const ok = removeOpById(db, opId);
  saveDB(db);
  renderProducts();
  // aynƒ± √ºr√ºn√ºn ge√ßmi≈üini tekrar a√ß (tek dokunu≈üla geri d√∂ns√ºn)
  try{ if(pid) toggleHistory(pid); }catch(e){}
  if(!ok) alert("Silme ba≈üarƒ±sƒ±z (i≈ülem bulunamadƒ±).");
}


const KEY="stok_kontrol_db_v1";
const $=id=>document.getElementById(id);

function loadDB(){
  let db=null;
  try{ db=JSON.parse(localStorage.getItem(KEY)||"null"); }catch(e){}
  if(!db || typeof db!=="object") db={products:[], ops:[], meta:{v:1}};
  if(!Array.isArray(db.products)) db.products=[];
  if(!Array.isArray(db.ops)) db.ops=[];
  if(!db.meta) db.meta={v:1};
  return db;
}
function saveDB(db){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Date.now().toString(16)+Math.random().toString(16).slice(2); }
function todayISO(){ return new Date().toISOString().slice(0,10); }

/* ====== TYPES (Senin mantƒ±ƒüƒ±n) ====== */
/*
Artma tetikleri:
- Sipari≈ü (Firma/Depo altƒ±)  -> + (opsiyonel detay)
- Daƒüƒ±lƒ±m (Normal/ƒ∞skonto/Insert + kaynak) -> +
Eksilme tetikleri:
- Satƒ±≈ü -> -
- SKT -> -
- ƒ∞ade (M√º≈üteri/Tarihi ge√ßmi≈ü/Fabrika/Raf) -> -
*/
const TYPE_DEF = [
  {k:"siparis",  label:"Sipari≈ü (+)", dir:"+", subs:[
    "Firma ‚Ä¢ Ziyaret aldƒ±",
    "Firma ‚Ä¢ Telefon geldi",
    "Firma ‚Ä¢ Telefon ettik",
    "Depo ‚Ä¢ Merkez depoya",
    "Depo ‚Ä¢ ≈ûark√ºteri depoya"
  ]},
  {k:"dagilim",  label:"Daƒüƒ±lƒ±m (+)", dir:"+", subs:[
    "Merkez ‚Ä¢ Normal",
    "Merkez ‚Ä¢ ƒ∞skonto",
    "Merkez ‚Ä¢ Insert",
    "Insert ‚Ä¢ (isim/tarih not'a)"
  ]},
  {k:"satis",    label:"Satƒ±≈ü (-)",   dir:"-", subs:[
    "Normal satƒ±≈ü",
    "Insert satƒ±≈ü",
    "ƒ∞skonto satƒ±≈ü"
  ]},
  {k:"skt",      label:"SKT (-)",     dir:"-", subs:[
    "Tarihi yakla≈üan kontrol",
    "Tarihi ge√ßmi≈ü ayrƒ±ldƒ±"
  ]},
  {k:"iade",     label:"ƒ∞ade (-)",    dir:"-", subs:[
    "M√º≈üteri iadesi",
    "Tarihi ge√ßmi≈ü",
    "Fabrika kaynaklƒ±",
    "Raf kaynaklƒ±"
  ]},
];

/* V14_FASTOPS_SOLID */
function getProdById(db, pid){
  return (db.products||[]).find(x=>x.id===pid) || null;
}

function pickTypeByDir(dir, preferredKey){
  if(preferredKey){
    const t0 = TYPE_DEF.find(t=>t.k===preferredKey && t.dir===dir);
    if(t0) return t0;
  }
  return TYPE_DEF.find(t=>t.dir===dir) || null;
}

function rememberLastSelection(pid, dir, typeKey, sub){
  const db=loadDB();
  const prod=getProdById(db,pid);
  if(!prod) return;

  if(dir==="+"){
    prod.lastPlusType = typeKey || prod.lastPlusType;
    prod.lastPlusSub  = (sub!==undefined) ? sub : (prod.lastPlusSub||"");
  }else{
    prod.lastMinusType = typeKey || prod.lastMinusType;
    prod.lastMinusSub  = (sub!==undefined) ? sub : (prod.lastMinusSub||"");
  }
  rememberLastSelection(pid, t.dir, t.k, sub);
  saveDB(db);
}

function fastOp(pid, dir, unitMode, qty, packCount, packSize){
  const db=loadDB();
  const prod=getProdById(db,pid);
  if(!prod) return;

  const preferred = (dir==="+") ? prod.lastPlusType : prod.lastMinusType;
  const t = pickTypeByDir(dir, preferred);
  if(!t){ alert("T√ºr bulunamadƒ± (TYPE_DEF)."); return; }

  const sub = (dir==="+") ? (prod.lastPlusSub||"") : (prod.lastMinusSub||"");

  db.ops.push({
    id: uid(),
    pid,
    dir: t.dir,
    type: t.k,
    typeLabel: t.label,
    sub: sub,
    note: "",
    qty: qty,
    unitMode: unitMode,
    packCount: packCount || 0,
    packSize: packSize || 0,
    ts: Date.now(),
    day: todayISO()
  });

  
  rememberUndo(db);
rememberLastSelection(pid, dir, t.k, sub);

  saveDB(db);
  renderProducts();
}


/* V12_KOLI_MODE_MODAL_OPAQUE_V2 */
let OP_MODE = "adet"; // "adet" | "koli"

function setMode(mode){
  OP_MODE = mode;

  const bA = $("btnModeAdet"), bK = $("btnModeKoli");
  const wA = $("wrapAdet"), wK = $("wrapKoli");
  if(!bA||!bK||!wA||!wK) return;

  if(mode==="adet"){
    bA.classList.add("modeBtnOn");
    bK.classList.remove("modeBtnOn");
    wA.style.display="";
    wK.style.display="none";
    setTimeout(()=>{ try{$("opQty").focus({preventScroll:true});}catch(e){} }, 60);
  }else{
    bK.classList.add("modeBtnOn");
    bA.classList.remove("modeBtnOn");
    wK.style.display="";
    wA.style.display="none";
    syncPackDefaultsFromProduct();
    buildQuickPackRow();
    updatePackTotal();
    setTimeout(()=>{ try{$("opPackCount").focus({preventScroll:true});}catch(e){} }, 60);
  }
}

function updatePackTotal(){
  const c = parseInt(($("opPackCount")?.value || "0").trim(), 10) || 0;
  const s = parseInt(($("opPackSize")?.value  || "0").trim(), 10) || 0;
  const tot = Math.max(0, c) * Math.max(0, s);
  const out = $("opPackTotal");
  if(out) out.textContent = String(tot);
}

function buildQuickPackRow(){
  const wrap = $("quickPackRow");
  if(!wrap) return;
  wrap.innerHTML="";
  const presets=[1,2,3,4,5];
  for(const n of presets){
    const b=document.createElement("button");
    b.type="button";
    b.className="btn smallBtn";
    b.textContent=String(n)+" koli";
    b.addEventListener("click", ()=>{
      $("opPackCount").value = String(n);
      updatePackTotal();
      try{$("opPackCount").focus({preventScroll:true});}catch(e){}
    });
    wrap.appendChild(b);
  }
}

function syncPackDefaultsFromProduct(){
  const db = loadDB();
  const pid = $("opProd")?.value;
  if(!pid) return;
  const prod = db.products.find(x=>x.id===pid);
  if(!prod) return;

  if(prod.packDefault && !String($("opPackSize")?.value||"").trim()){
    $("opPackSize").value = String(prod.packDefault);
  }
}

function learnPackDefaultToProduct(packSize){
  const n = parseInt(String(packSize||"").trim(),10) || 0;
  if(n<=0) return;

  const db = loadDB();
  const pid = $("opProd")?.value;
  if(!pid) return;
  const prod = db.products.find(x=>x.id===pid);
  if(!prod) return;

  prod.packDefault = n;
  saveDB(db);
}


function computeStock(db, pid){
  let net=0;
  for(const o of db.ops){
    if(o.pid!==pid) continue;
    const qty = Number(o.qty||0);
    if(!qty) continue;
    net += (o.dir==="+" ? qty : -qty);
  }
  return net;
}

/* ====== RENDER PRODUCTS ====== */
function renderProducts(){
  const db=loadDB();
  const q=($("inSearch").value||"").trim().toLowerCase();
  const list=$("prodList");
  list.innerHTML="";
  $("pCount").textContent=String(db.products.length);

  const filtered = db.products.filter(p=>!q || (p.name||"").toLowerCase().includes(q));

  if(!filtered.length){
    list.innerHTML = `<div class="item"><div class="hint">√úr√ºn yok / arama sonucu bo≈ü.</div></div>`;
    fillProdSelect(); // modal select g√ºncel kalsƒ±n
    reportToday();
    return;
  }

  for(const p of filtered){
    const net = computeStock(db, p.id);
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`
      <div class="itemTop">
        <div style="flex:1">
          <div class="name">${escapeHTML(p.name||"")}</div>
          <div class="muted">ID: ${p.id.slice(0,8)} ‚Ä¢ Son: ${new Date(p.ts||Date.now()).toLocaleString("tr-TR")}</div>
        </div>
        <div class="netBox">
          <div class="netBig" title="Net Stok">${net}</div>
        </div>
      </div>
      <div class="miniRow">
        <span class="tag">Net: <b>${net}</b></span>
        <button class="btn smallBtn" data-act="qplus" data-pid="${p.id}" type="button">+1</button>
        <button class="btn smallBtn" data-act="qminus" data-pid="${p.id}" type="button">-1</button>
        <button class="btn smallBtn btnOK" data-act="plus" data-pid="${p.id}" type="button">+ ƒ∞≈ülem</button>
        <button class="btn smallBtn btnBAD" data-act="minus" data-pid="${p.id}" type="button">- ƒ∞≈ülem</button>
        
        <!-- V14 fast ops -->
        <button class="btn smallBtn btnOK" data-act="aPlus1" data-pid="${p.id}" type="button">+1</button>
        <button class="btn smallBtn btnBAD" data-act="aMinus1" data-pid="${p.id}" type="button">-1</button>
        ${p.packDefault ? `
          <button class="btn smallBtn btnOK" data-act="kPlus1" data-pid="${p.id}" type="button">+1 koli</button>
          <button class="btn smallBtn btnBAD" data-act="kMinus1" data-pid="${p.id}" type="button">-1 koli</button>
          <span class="tag">koli i√ßi: <b>${p.packDefault}</b></span>
        ` : ``}
<button class="btn smallBtn" data-act="hist" data-pid="${p.id}" type="button">Ge√ßmi≈ü</button>
      </div>
      <div class="list" id="hist_${p.id}" style="display:none;margin-top:10px"></div>
    `;
    list.appendChild(el);
  }

  // √ºr√ºn kart aksiyonlarƒ±
  list.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act=btn.getAttribute("data-act");
      const pid=btn.getAttribute("data-pid");
      if(act==="hist"){ toggleHistory(pid); return; }
      if(act==="qplus"){ quickOp(pid, "+", 1); return; }
      if(act==="qminus"){ quickOp(pid, "-", 1); return; }
      
      // V14 fast ops
      if(act==="aPlus1"){ fastOp(pid, "+", "adet", 1, 0, 0); return; }
      if(act==="aMinus1"){ fastOp(pid, "-", "adet", 1, 0, 0); return; }

      if(act==="kPlus1"){
        const db=loadDB();
        const prod=(db.products||[]).find(x=>x.id===pid);
        const ps = prod && prod.packDefault ? Number(prod.packDefault) : 0;
        if(!ps){ alert("Bu √ºr√ºnde koli i√ßi adet yok. Koli modunda bir kez gir ki √∂ƒürensin."); return; }
        fastOp(pid, "+", "koli", ps, 1, ps);
        return;
      }
      if(act==="kMinus1"){
        const db=loadDB();
        const prod=(db.products||[]).find(x=>x.id===pid);
        const ps = prod && prod.packDefault ? Number(prod.packDefault) : 0;
        if(!ps){ alert("Bu √ºr√ºnde koli i√ßi adet yok. Koli modunda bir kez gir ki √∂ƒürensin."); return; }
        fastOp(pid, "-", "koli", ps, 1, ps);
        return;
      }

openModal(pid, act==="plus" ? "+" : "-");
    });
  });

  fillProdSelect();
  reportToday();
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ====== HISTORY (√úr√ºn bazlƒ± detay) ====== */
function toggleHistory(pid){
  const db=loadDB();
  const box=$("hist_"+pid);
  if(!box) return;
  const visible = box.style.display!=="none";
  if(visible){ box.style.display="none"; return; }
  box.style.display="block";

  const ops = db.ops.filter(o=>o.pid===pid).sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,60);
  if(!ops.length){
    box.innerHTML = `<div class="item"><div class="hint">Bu √ºr√ºnde i≈ülem yok.</div></div>`;
    return;
  }
  box.innerHTML = ops.map(o=>{
    const dt=new Date(o.ts||Date.now()).toLocaleString("tr-TR");
    const sign = o.dir==="+" ? "+" : "-";
    return `
      <div class="item" style="background:rgba(255,255,255,.02)">
        <div class="row" style="justify-content:space-between">
          <div class="name">${sign}${o.qty} ‚Ä¢ ${escapeHTML(o.typeLabel||o.type||"")}</div>
          <div class="row" style="gap:8px;align-items:center">
            <div class="tag">${escapeHTML(dt)}</div>
            <button class="btn btnMini btnDel" type="button" data-del="${o.id}" data-pid="${o.pid}">Sil</button>
          </div>
        </div>
        <div class="muted">${escapeHTML(o.sub||"")} ${o.note?(" ‚Ä¢ "+escapeHTML(o.note)):""}</div>
      </div>
    `;
  }).join("");

    // V15: Sil butonlarƒ±
    box.querySelectorAll("button[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const opId = b.getAttribute("data-del");
        const pid2 = b.getAttribute("data-pid");
        if(!opId) return;
        if(confirm("Bu i≈ülemi silmek istiyor musun?")){
          deleteOp(opId, pid2);
        }
      });
    });
}

/* ====== MODAL ====== */
function fillProdSelect(){
  const db=loadDB();
  const sel=$("opProd");
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML="";
  for(const p of db.products){
    const net=computeStock(db,p.id);
    const opt=document.createElement("option");
    opt.value=p.id;
    opt.textContent=`${p.name}  (net:${net})`;
    sel.appendChild(opt);
  }
  if(cur && [...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

function fillTypeSelect(dirHint){
  const tSel=$("opType");
  tSel.innerHTML="";
  for(const t of TYPE_DEF){
    // dirHint varsa filtrele (kart √ºzerindeki + / -)
    if(dirHint && t.dir!==dirHint) continue;
    const opt=document.createElement("option");
    opt.value=t.k;
    opt.textContent=t.label;
    tSel.appendChild(opt);
  }
  // default ilk
  tSel.selectedIndex=0;
  fillSubSelect();
  buildQuickRow();
}

function fillSubSelect(){
  const tSel=$("opType");
  const sSel=$("opSub");
  const t=TYPE_DEF.find(x=>x.k===tSel.value);
  sSel.innerHTML="";
  // opsiyonel: bo≈ü se√ßenek (hƒ±z i√ßin)
  const none=document.createElement("option");
  none.value="";
  none.textContent="Alt kƒ±rƒ±lƒ±m (opsiyonel)";
  sSel.appendChild(none);

  if(t && Array.isArray(t.subs)){
    for(const sub of t.subs){
      const opt=document.createElement("option");
      opt.value=sub;
      opt.textContent=sub;
      sSel.appendChild(opt);
    }
  }
  sSel.selectedIndex=0;
}

function buildQuickRow(){
  const wrap=$("quickRow");
  wrap.innerHTML="";
  const tSel=$("opType");
  const t=TYPE_DEF.find(x=>x.k===tSel.value);
  if(!t) return;

  // hƒ±zlƒ± alt kƒ±rƒ±lƒ±m chip'leri (tek dokunu≈ü)
  const arr=(t.subs||[]).slice(0,6);
  for(const sub of arr){
    const b=document.createElement("button");
    b.className="btn smallBtn";
    b.type="button";
    b.textContent=sub.split("‚Ä¢")[0].trim();
    b.title=sub;
    b.addEventListener("click", ()=>{
      $("opSub").value=sub;
    });
    wrap.appendChild(b);
  }
}

/* QUICK_QTY_V1 */
function buildQuickQtyRow(){
  const wrap = $("quickQtyRow");
  if(!wrap) return;
  wrap.innerHTML="";

  const presets = [1,2,3,5,6,10,12,15,20];

  for(const n of presets){
    const b=document.createElement("button");
    b.type="button";
    b.className="btn smallBtn";
    b.textContent = String(n);
    b.title = "Adet = " + n;
    b.addEventListener("click", ()=>{
      $("opQty").value = String(n);
      try{$("opQty").focus({preventScroll:true});}catch(e){}
    });
    wrap.appendChild(b);
  }

  // k√º√ß√ºk d√ºzeltme: -1 / +1
  const bMinus=document.createElement("button");
  bMinus.type="button";
  bMinus.className="btn smallBtn btnBAD";
  bMinus.textContent="-1";
  bMinus.title="Adet -1";
  bMinus.addEventListener("click", ()=>{
    const cur = parseInt(($("opQty").value||"0").trim(),10) || 0;
    const next = Math.max(0, cur-1);
    $("opQty").value = String(next);
    try{$("opQty").focus({preventScroll:true});}catch(e){}
  });
  wrap.appendChild(bMinus);

  const bPlus=document.createElement("button");
  bPlus.type="button";
  bPlus.className="btn smallBtn btnOK";
  bPlus.textContent="+1";
  bPlus.title="Adet +1";
  bPlus.addEventListener("click", ()=>{
    const cur = parseInt(($("opQty").value||"0").trim(),10) || 0;
    $("opQty").value = String(cur+1);
    try{$("opQty").focus({preventScroll:true});}catch(e){}
  });
  wrap.appendChild(bPlus);
}



/* FAST_OPS_V1 */
function showToast(msg){
  let t=document.getElementById("toastBox");
  if(!t){
    t=document.createElement("div");
    t.id="toastBox";
    t.style.position="fixed";
    t.style.left="50%";
    t.style.bottom="72px";
    t.style.transform="translateX(-50%)";
    t.style.background="rgba(2,6,23,.92)";
    t.style.border="1px solid rgba(255,255,255,.12)";
    t.style.color="#e5e7eb";
    t.style.padding="10px 12px";
    t.style.borderRadius="14px";
    t.style.fontSize="12px";
    t.style.zIndex="99998";
    t.style.display="none";
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(window.__toastT);
  window.__toastT=setTimeout(()=>{ t.style.display="none"; }, 1200);
}

function buildQtyRow(){
  const wrap=$("qtyRow");
  if(!wrap) return;
  wrap.innerHTML="";
  const nums=[1,2,3,5,10];
  for(const n of nums){
    const b=document.createElement("button");
    b.className="btn smallBtn";
    b.type="button";
    b.textContent=String(n);
    b.addEventListener("click", ()=>{
      $("opQty").value=String(n);
      try{ $("opQty").focus({preventScroll:true}); }catch(e){}
    });
    wrap.appendChild(b);
  }
  // Enter = kaydet (modal i√ßindeyken)
  const q=$("opQty");
  if(q && !q.__fastBound){
    q.__fastBound=true;
    q.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); addOp(); }
    });
  }
}

// modal her a√ßƒ±ldƒ±ƒüƒ±nda qty row hazƒ±r olsun
const __openModal0 = openModal;
openModal = function(pid, dirHint){
  __openModal0(pid, dirHint);
  buildQtyRow();
};

// Kart √ºst√º +1 / -1 hƒ±zlƒ± i≈ülem
function quickOp(pid, dir, qty){
  const db=loadDB();
  const lc = (db.meta && db.meta.lastChoice) ? db.meta.lastChoice[dir] : null;

  // ƒ∞lk kezse: kullanƒ±cƒ±ya modal a√ßtƒ±rƒ±p ‚Äú≈üablonu √∂ƒüret‚Äù
  if(!lc || !lc.typeKey){
    showToast("ƒ∞lk kez: t√ºr se√ßelim");
    openModal(pid, dir);
    return;
  }

  const t=TYPE_DEF.find(x=>x.k===lc.typeKey && x.dir===dir);
  if(!t){
    showToast("≈ûablon yok: t√ºr se√ßelim");
    openModal(pid, dir);
    return;
  }

  db.ops.push({
    id:uid(),
    pid,
    dir:t.dir,
    type:t.k,
    typeLabel:t.label,
    sub:(lc.sub||""),
    note:"",
    qty:qty,
    unitMode: OP_MODE,
    packCount: packCount,
    packSize: packSize,
    ts:Date.now(),
    day: todayISO()
  });
  
  rememberUndo(db);
saveDB(db);
  renderProducts();
  showToast((dir==="+"?"+":"-")+qty+" kaydedildi");
}


function openModal(pid, dirHint){
  $("modal").style.display="block";
  fillProdSelect();
  if(pid) $("opProd").value=pid;
  fillTypeSelect(dirHint);
  try{ buildQuickQtyRow(); }catch(e){}

  // MODAL_ONEHAND_V1: son se√ßimleri geri y√ºkle
  try{
    const db=loadDB();
    const lc = (db.meta && db.meta.lastChoice) ? db.meta.lastChoice[dirHint] : null;

    // pid yoksa son √ºr√ºn√º se√ß
    if(!pid && db.meta && db.meta.lastPid){
      const lp = db.meta.lastPid;
      if($("opProd") && [...$("opProd").options].some(o=>o.value===lp)) $("opProd").value = lp;
    }

    // t√ºr/sub otomatik (dirHint'e g√∂re)
    if(lc && lc.typeKey){
      if($("opType") && [...$("opType").options].some(o=>o.value===lc.typeKey)){
        $("opType").value = lc.typeKey;
        fillSubSelect();
        if(lc.sub) $("opSub").value = lc.sub;
        buildQuickRow();
      }
    }
  }catch(e){}

  // MODAL_ONEHAND_V1: hƒ±zlƒ± t√ºr butonlarƒ±
  try{
    const row=$("fastTypeRow");
    if(row){
      row.innerHTML="";
      const dir=dirHint; // "+" veya "-"
      const list = TYPE_DEF.filter(t=>!dir || t.dir===dir);
      for(const t of list){
        const b=document.createElement("button");
        b.type="button";
        b.className="btn smallBtn " + (t.dir==="+" ? "btnOK" : "btnBAD");
        // kƒ±sa isim:
        const short = t.label.replace(" (+)","").replace(" (-)","").trim();
        b.textContent = (t.dir==="+"?"+ ":"- ") + short;
        b.addEventListener("click", ()=>{
          $("opType").value = t.k;
          fillSubSelect();
          buildQuickRow();
        });
        row.appendChild(b);
      }
    }
  }catch(e){}


  $("opQty").value="";
  if($("opPackCount")) $("opPackCount").value="";
  if($("opPackSize")) $("opPackSize").value="";
  $("opNote").value="";
  try{ setMode("adet"); }catch(e){}
  // flicker √∂ld√ºrmek i√ßin agresif autofocus yok:
  setTimeout(()=>{ try{$("opQty").focus({preventScroll:true});}catch(e){} }, 60);
}

function closeModal(){
  $("modal").style.display="none";
}

function addProduct(){
  const name=($("inProd").value||"").trim();
  if(!name){ alert("√úr√ºn adƒ± yaz."); return; }
  const db=loadDB();
  db.products.push({id:uid(), name, ts:Date.now()});
  saveDB(db);
  $("inProd").value="";
  renderProducts();
  try{$("inProd").focus({preventScroll:true});}catch(e){}
}

function addOp(){
  const pid=$("opProd").value;
  let qty = 0;
  let packCount = 0;
  let packSize = 0;

  if(OP_MODE==="adet"){
    qty = Math.abs(parseInt(($("opQty").value||"").trim(),10))||0;
  }else{
    packCount = Math.abs(parseInt(($("opPackCount").value||"").trim(),10))||0;
    packSize  = Math.abs(parseInt(($("opPackSize").value||"").trim(),10))||0;
    qty = packCount * packSize;
    if(packSize>0) learnPackDefaultToProduct(packSize);
  }
  if(!pid){ alert("√úr√ºn se√ß."); return; }
  if(!qty){
    if(OP_MODE==="adet"){
      alert("Adet gir (√∂rn 3).");
      $("opQty").focus();
    }else{
      alert("Koli sayƒ±sƒ± ve koli i√ßi adet gir (√∂rn 2 koli √ó 12).");
      try{$("opPackCount").focus();}catch(e){}
    }
    return;
  }

  const tKey=$("opType").value;
  const t=TYPE_DEF.find(x=>x.k===tKey);
  if(!t){ alert("T√ºr se√ß."); return; }

  const db=loadDB();
  const sub=($("opSub").value||"").trim();
  const note=($("opNote").value||"").trim();

  db.ops.push({
    id:uid(),
    pid,
    dir:t.dir,
    type:t.k,
    typeLabel:t.label,
    sub:sub,
    note:note,
    qty:qty,
    unitMode: OP_MODE,
    packCount: packCount,
    packSize: packSize,
    ts:Date.now(),
    day: todayISO()
  });
  
  
  rememberUndo(db);
// FAST_OPS_V1: son se√ßim (dir/type/sub) hafƒ±zasƒ±
  try{
    if(!db.meta) db.meta={v:1};
    if(!db.meta.lastChoice) db.meta.lastChoice={};
    const dir = t.dir; // "+" / "-"
    db.meta.lastChoice[dir] = { typeKey: t.k, sub: sub || "" };
  }catch(e){}

  // MODAL_ONEHAND_V1: son √ºr√ºn (pid) hafƒ±zasƒ±
  try{
    if(!db.meta) db.meta={v:1};
    db.meta.lastPid = pid;
  }catch(e){}

saveDB(db);
  closeModal();
  renderProducts();
}

/* ====== REPORT / ANALYTICS ====== */
function opsInDays(db, days){
  const now = new Date();
  const from = new Date(now.getTime() - days*24*3600*1000);
  return db.ops.filter(o=>{
    const d = new Date(o.ts||0);
    return d>=from;
  });
}
function reportForDays(days){
  const db=loadDB();
  const ops=opsInDays(db, days);
  let plus=0, minus=0;
  for(const o of ops){
    const q=Number(o.qty||0);
    if(o.dir==="+") plus+=q; else minus+=q;
  }
  $("rPlus").textContent=String(plus);
  $("rMinus").textContent=String(minus);
  $("rNet").textContent=String(plus - minus);

  // Top √ºr√ºnler
  const m=new Map();
  for(const o of ops){
    const p=db.products.find(x=>x.id===o.pid);
    if(!p) continue;
    const key=p.id;
    const cur=m.get(key)||{name:p.name, score:0, plus:0, minus:0};
    if(o.dir==="+"){cur.plus+=Number(o.qty||0)}else{cur.minus+=Number(o.qty||0)}
    cur.score += Number(o.qty||0);
    m.set(key,cur);
  }
  const top=[...m.values()].sort((a,b)=>(b.plus+b.minus)-(a.plus+a.minus)).slice(0,8);
  $("rTop").innerHTML = top.length ? top.map(x=>`
    <div class="item">
      <div class="row" style="justify-content:space-between">
        <div class="name">${escapeHTML(x.name)}</div>
        <div class="tag">net ${x.plus-x.minus}</div>
      </div>
      <div class="muted">+${x.plus} / -${x.minus}</div>
    </div>
  `).join("") : `<div class="item"><div class="hint">Bu aralƒ±kta veri yok.</div></div>`;

  // T√ºr daƒüƒ±lƒ±mƒ±
  const tm=new Map();
  for(const o of ops){
    const k=o.typeLabel||o.type||"";
    tm.set(k, (tm.get(k)||0) + Number(o.qty||0));
  }
  const trows=[...tm.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
  $("rTypes").innerHTML = trows.length ? trows.map(([k,v])=>`
    <div class="item">
      <div class="row" style="justify-content:space-between">
        <div class="name">${escapeHTML(k)}</div>
        <div class="tag">${v}</div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="hint">T√ºr verisi yok.</div></div>`;

  // ‚ÄúAkƒ±l‚Äù (basit, donmayan)
  const brain=[];
  if(ops.length===0) brain.push("Veri yok: √∂nce i≈ülem gir.");
  if(minus>plus) brain.push("üü• Eksilme artƒ±dan fazla: satƒ±≈ü/skt/iade baskƒ±n.");
  if(plus>0 && minus===0) brain.push("üüß Sadece artƒ±≈ü var: daƒüƒ±lƒ±m/sipari≈ü girilmi≈ü, satƒ±≈ü yok.");
  if(plus-minus<0) brain.push("üü• Net negatif: stok a√ßƒ±ƒüƒ±/yanlƒ±≈ü kayƒ±t ihtimali.");
  if(brain.length===0) brain.push("üü© Stabil: kritik sinyal yok.");
  $("rBrain").innerHTML = brain.map(t=>`<div class="item"><div class="name">${escapeHTML(t)}</div></div>`).join("");
}

function reportToday(){ reportForDays(1); }

/* ====== ERROR GUARD ====== */
(function(){
  function showError(msg){
    const box=$("errorGuardBox");
    const txt=$("errorGuardText");
    if(!box||!txt) return;
    box.style.display="block";
    txt.textContent=msg;
  }
  window.addEventListener("error", e=> showError((e.message||"Hata") + " @ " + (e.filename||"") + ":" + (e.lineno||"")));
  window.addEventListener("unhandledrejection", e=> showError("Promise Error: " + (e.reason?.message || e.reason)));
})();

/* ====== EVENTS ====== */
$("btnAddProd").onclick=addProduct;
$("inProd").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addProduct(); }});
$("btnAddOp").onclick=()=>openModal(null,null);
$("btnClose").onclick=closeModal;
$("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal(); });

$("opType").addEventListener("change", ()=>{ fillSubSelect(); buildQuickRow(); });
$("btnSaveOp").onclick=addOp;

$("btnClearSearch").onclick=()=>{ $("inSearch").value=""; renderProducts(); };
$("inSearch").addEventListener("input", ()=>renderProducts());

$("btnReportToday").onclick=()=>reportToday();
$("btnReport7").onclick=()=>reportForDays(7);
$("btnReport30").onclick=()=>reportForDays(30);

// Skor test (debug): kritik deƒüilse ‚Äú0‚Äù gibi davranƒ±r ‚Üí burada basit √ßƒ±ktƒ± g√∂steriyoruz
$("btnSkorTest").onclick=()=>{
  const db=loadDB();
  if(!db.products.length){ alert("√ñnce √ºr√ºn ekle."); return; }
  const pid=db.products[0].id;
  const net=computeStock(db,pid);
  alert("Skor Test ‚úÖ\n\nƒ∞lk √ºr√ºn: "+db.products[0].name+"\nNet: "+net+"\n\nNot: Skor sistemi kritik sinyal yoksa 'stabil' sayar.");
};

(function boot(){
  $("chipMeta").textContent = "LocalStorage ‚Ä¢ " + KEY;
  renderProducts();
  reportToday();
  // agresif autofocus yok: flicker riskini azaltƒ±r
})();

/* V12_BINDINGS */
document.addEventListener("DOMContentLoaded", ()=>{
    if($("btnUndo")) $("btnUndo").onclick = undoLast;
if($("btnModeAdet")) $("btnModeAdet").onclick = ()=> setMode("adet");
  if($("btnModeKoli")) $("btnModeKoli").onclick = ()=> setMode("koli");

  if($("opPackCount")) $("opPackCount").addEventListener("input", updatePackTotal);
  if($("opPackSize"))  $("opPackSize").addEventListener("input", updatePackTotal);

  if($("opProd")) $("opProd").addEventListener("change", ()=>{
    if(OP_MODE==="koli") syncPackDefaultsFromProduct();
    updatePackTotal();
  });

  // a√ßƒ±lƒ±≈üta adet modu
  try{ setMode("adet"); }catch(e){}
});

</script>
</body>
</html>
