<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stok Kontrol Motoru</title>
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{
      --bg:#070b14; --card:#0b1220; --card2:#0d1730;
      --text:#e5e7eb; --muted:#94a3b8; --line:rgba(255,255,255,.08);
      --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b; --blue:#2563eb;
      --r:20px; --pad:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070b14,#05070f);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(7,11,20,.72);backdrop-filter: blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:920px;margin:0 auto;padding:14px 14px 18px}
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.15fr .85fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px;font-size:15px}
    .hint{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    input,select,textarea{
      width:100%; background:rgba(255,255,255,.03); color:var(--text);
      border:1px solid var(--line); border-radius:16px; padding:12px 12px;
      outline:none; font-size:14px;
    }
    input::placeholder,textarea::placeholder{color:rgba(148,163,184,.7)}
    .btn{
      border:0; border-radius:16px; padding:12px 14px; font-weight:900;
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer;
      border:1px solid rgba(255,255,255,.08);
      user-select:none;
    }
    .btnOK{background:rgba(22,163,74,.18); border-color:rgba(22,163,74,.35)}
    .btnBAD{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.35)}
    .btnBLUE{background:rgba(37,99,235,.16); border-color:rgba(37,99,235,.35)}
    .btn:active{transform:translateY(1px)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);font-size:12px}
    .kpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .kpi .pill{justify-content:center;font-weight:900}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{padding:12px;border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.03)}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .name{font-weight:950}
    .muted{color:var(--muted);font-size:12px;margin-top:4px}
    .miniRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted)}
    .netBig{font-size:26px;font-weight:1000;letter-spacing:.3px}
    .netBox{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .smallBtn{padding:10px 12px;border-radius:14px}

    /* REPORT_COMPACT (saƒü kart i√ßinde scroll + sticky √ºst bar) */
    #cardReport{max-height: calc(100vh - 150px); overflow:auto; -webkit-overflow-scrolling: touch;}
    #cardReport .row:first-of-type{position: sticky; top:0; z-index:5; background: var(--card, #fff); padding-top:10px; padding-bottom:10px;}
    #cardReport .hr{margin:10px 0}

    /* MODAL: opak */
    #modal{background:rgba(0,0,0,.78) !important;}
    .modalCard{
      background: var(--card) !important;
      border: 1px solid var(--line) !important;
      box-shadow: 0 18px 50px rgba(0,0,0,.55) !important;
    }

    /* Adet/Koli mod */
    .modeBtn{padding:10px 12px;border-radius:999px}
    .modeBtnOn{background:rgba(37,99,235,.22);border-color:rgba(37,99,235,.45)}
    .modeHint{color:var(--muted);font-size:12px;margin-top:6px}

    /* Error Guard */
    #errorGuardBox{position:fixed;left:0;right:0;bottom:0;background:#7f1d1d;color:#fff;padding:12px;font-size:12px;display:none;z-index:99999;max-height:40vh;overflow:auto;border-top:2px solid #ef4444}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Stok Kontrol Motoru</h1>
        <div class="sub">v1.4 ‚Äî adet/koli + rapor + akƒ±l (stabil)</div>
      </div>
      <div class="chip" id="chipMeta">Local ‚Ä¢ Hazƒ±r</div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- SOL -->
    <section class="card">
      <h2>√úr√ºn</h2>
      <div class="hint">√úr√ºn ekle / ara / stok kartlarƒ±</div>
      <div class="row" style="margin-top:10px">
        <input id="inProd" placeholder="√úr√ºn adƒ± (Enter = ekle)" />
        <button class="btn btnOK" id="btnAddProd" type="button">Ekle</button>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="inSearch" placeholder="Ara (sabit)" />
        <button class="btn smallBtn" id="btnClearSearch" type="button">Temizle</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="pill">Toplam: <b id="pCount">0</b></div>
        <button class="btn btnBLUE" id="btnAddOp" type="button">ƒ∞≈ülem Ekle</button>
      </div>

      <div class="list" id="prodList"></div>
    </section>

    <!-- SAƒû: RAPOR -->
    <section class="card" id="cardReport">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2 style="margin-bottom:2px">Rapor</h2>
          <div class="hint">√ñzet ve ‚Äúakƒ±l‚Äù (bug√ºn / 7 g√ºn / 30 g√ºn)</div>
        </div>
        <div class="row">
          <button id="btnReportToday" class="btn btnBLUE" type="button">Bug√ºn</button>
          <button id="btnReport7" class="btn btnBLUE" type="button">7g</button>
          <button id="btnReport30" class="btn btnBLUE" type="button">30g</button>
        </div>
      </div>

      <div class="kpi">
        <div class="pill">Artƒ±: <b id="rPlus">0</b></div>
        <div class="pill">Eksi: <b id="rMinus">0</b></div>
        <div class="pill">Net: <b id="rNet">0</b></div>
      </div>

      <div class="hr"></div>
      <div class="hint">En √ßok √ºr√ºnler</div>
      <div class="list" id="rTop"></div>

      <div class="hr"></div>
      <div class="hint">T√ºr daƒüƒ±lƒ±mƒ±</div>
      <div class="list" id="rTypes"></div>

      <div class="hr"></div>
      <div class="hint">Akƒ±l</div>
      <div class="list" id="rBrain"></div>
    </section>
  </div>
</main>

<!-- MODAL -->
<div id="modal" style="position:fixed;inset:0;display:none;z-index:9999;padding:14px">
  <div class="card modalCard" style="max-width:720px;margin:0 auto;max-height:85vh;overflow:auto">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="name">ƒ∞≈ülem Ekle</div>
        <div class="hint">√úr√ºn se√ß ‚Üí t√ºr ‚Üí alt kƒ±rƒ±lƒ±m ‚Üí adet/koli</div>
      </div>
      <button class="btn" id="btnClose" type="button">Kapat</button>
    </div>

    <div class="hr"></div>

    <div class="row">
      <select id="opProd"></select>
      <div class="row" style="gap:8px">
        <button class="btn modeBtn modeBtnOn" id="btnModeAdet" type="button">Adet</button>
        <button class="btn modeBtn" id="btnModeKoli" type="button">Koli</button>
      </div>
    </div>

    <!-- ADET MODU -->
    <div id="wrapAdet">
      <div class="row" style="margin-top:10px">
        <input id="opQty" inputmode="numeric" placeholder="Adet (√∂rn 3)" />
      </div>
      <div class="hint">Hƒ±zlƒ± adet</div>
      <div class="miniRow" id="quickQtyRow"></div>
    </div>

    <!-- KOLƒ∞ MODU -->
    <div id="wrapKoli" style="display:none">
      <div class="row" style="margin-top:10px">
        <input id="opPackCount" inputmode="numeric" placeholder="Koli sayƒ±sƒ± (√∂rn 2)" />
        <input id="opPackSize" inputmode="numeric" placeholder="Koli i√ßi adet (√∂rn 12)" />
      </div>

      <div class="hint">Koli i√ßi preset (√ºr√ºne √∂zel)</div>
      <div class="miniRow" id="quickPackSizeRow"></div>

      <div class="hint" style="margin-top:8px">Hƒ±zlƒ± koli sayƒ±sƒ±</div>
      <div class="miniRow" id="quickPackRow"></div>

      <div class="modeHint">Toplam adet: <b id="opPackTotal">0</b> (koli√ói√ß adet)</div>
      <div class="modeHint">Not: Koli i√ßi adet girersen sistem bunu bu √ºr√ºne hatƒ±rlar.</div>
    </div>

    <div class="row" style="margin-top:10px">
      <select id="opType"></select>
      <select id="opSub"></select>
    </div>

    <div class="row">
      <input id="opNote" placeholder="Not (opsiyonel)" />
    </div>

    <div class="row" style="justify-content:flex-end">
      <button class="btn btnOK" id="btnSaveOp" type="button">Kaydet</button>
    </div>

    <div class="hr"></div>
    <div class="hint">Hƒ±zlƒ± alt kƒ±rƒ±lƒ±m</div>
    <div class="miniRow" id="quickRow"></div>
  </div>
</div>

<div id="errorGuardBox"><b>Sistem Hatasƒ±:</b><br><div id="errorGuardText"></div></div>

<script>
/* ====== CORE DB ====== */
const KEY="stok_kontrol_db_v1";
const $=id=>document.getElementById(id);

function loadDB(){
  let db=null;
  try{ db=JSON.parse(localStorage.getItem(KEY)||"null"); }catch(e){}
  if(!db || typeof db!=="object") db={products:[], ops:[], meta:{v:1}};
  if(!Array.isArray(db.products)) db.products=[];
  if(!Array.isArray(db.ops)) db.ops=[];
  if(!db.meta) db.meta={v:1};
  return db;
}
function saveDB(db){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Date.now().toString(16)+Math.random().toString(16).slice(2); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ====== TYPES (senin mantƒ±ƒüƒ±n) ====== */
const TYPE_DEF = [
  {k:"siparis",  label:"Sipari≈ü (+)", dir:"+", subs:[
    "Firma ‚Ä¢ Ziyaret aldƒ±","Firma ‚Ä¢ Telefon geldi","Firma ‚Ä¢ Telefon ettik",
    "Depo ‚Ä¢ Merkez depoya","Depo ‚Ä¢ ≈ûark√ºteri depoya"
  ]},
  {k:"dagilim",  label:"Daƒüƒ±lƒ±m (+)", dir:"+", subs:[
    "Merkez ‚Ä¢ Normal","Merkez ‚Ä¢ ƒ∞skonto","Merkez ‚Ä¢ Insert","Insert ‚Ä¢ (isim/tarih not'a)"
  ]},
  {k:"satis",    label:"Satƒ±≈ü (-)",   dir:"-", subs:["Normal satƒ±≈ü","Insert satƒ±≈ü","ƒ∞skonto satƒ±≈ü"]},
  {k:"skt",      label:"SKT (-)",     dir:"-", subs:["Tarihi yakla≈üan kontrol","Tarihi ge√ßmi≈ü ayrƒ±ldƒ±"]},
  {k:"iade",     label:"ƒ∞ade (-)",    dir:"-", subs:["M√º≈üteri iadesi","Tarihi ge√ßmi≈ü","Fabrika kaynaklƒ±","Raf kaynaklƒ±"]},
];

function computeStock(db, pid){
  let net=0;
  for(const o of db.ops){
    if(o.pid!==pid) continue;
    const qty = Number(o.qty||0);
    if(!qty) continue;
    net += (o.dir==="+" ? qty : -qty);
  }
  return net;
}

/* ====== MODE (Adet/Koli) ====== */
let OP_MODE="adet"; // adet | koli

function getProdById(db,pid){ return db.products.find(x=>x.id===pid)||null; }

function setMode(mode){
  OP_MODE=mode;
  const bA=$("btnModeAdet"), bK=$("btnModeKoli");
  const wA=$("wrapAdet"), wK=$("wrapKoli");
  if(!bA||!bK||!wA||!wK) return;

  if(mode==="adet"){
    bA.classList.add("modeBtnOn"); bK.classList.remove("modeBtnOn");
    wA.style.display=""; wK.style.display="none";
    setTimeout(()=>{ try{$("opQty").focus({preventScroll:true});}catch(e){} }, 60);
  }else{
    bK.classList.add("modeBtnOn"); bA.classList.remove("modeBtnOn");
    wK.style.display=""; wA.style.display="none";
    syncPackDefaultsFromProduct();
    buildQuickPackRow();
    buildQuickPackSizeRow();
    updatePackTotal();
    setTimeout(()=>{ try{$("opPackCount").focus({preventScroll:true});}catch(e){} }, 60);
  }
}

function updatePackTotal(){
  const c=parseInt(($("opPackCount")?.value||"0").trim(),10)||0;
  const s=parseInt(($("opPackSize")?.value||"0").trim(),10)||0;
  const tot=Math.max(0,c)*Math.max(0,s);
  if($("opPackTotal")) $("opPackTotal").textContent=String(tot);
}

function buildQuickPackRow(){
  const wrap=$("quickPackRow"); if(!wrap) return;
  wrap.innerHTML="";
  const presets=[1,2,3,4,5];
  for(const n of presets){
    const b=document.createElement("button");
    b.type="button"; b.className="btn smallBtn";
    b.textContent=`${n} koli`;
    b.onclick=()=>{ $("opPackCount").value=String(n); updatePackTotal(); };
    wrap.appendChild(b);
  }
}

function syncPackDefaultsFromProduct(){
  const db=loadDB();
  const pid=$("opProd")?.value; if(!pid) return;
  const prod=getProdById(db,pid); if(!prod) return;

  // packDefault varsa ve input bo≈üsa doldur
  if(prod.packDefault && !String($("opPackSize")?.value||"").trim()){
    $("opPackSize").value=String(prod.packDefault);
  }
}

function learnPackToProduct(packSize){
  const n=parseInt(String(packSize||"").trim(),10)||0;
  if(n<=0) return;

  const db=loadDB();
  const pid=$("opProd")?.value; if(!pid) return;
  const prod=getProdById(db,pid); if(!prod) return;

  prod.packDefault = n;

  // packSizes listesi (√ºr√ºne √∂zel)
  if(!Array.isArray(prod.packSizes)) prod.packSizes=[];
  if(!prod.packSizes.includes(n)) prod.packSizes.push(n);
  prod.packSizes = prod.packSizes.filter(x=>Number.isFinite(x)).sort((a,b)=>a-b);

  saveDB(db);
}

function buildQuickPackSizeRow(){
  const wrap=$("quickPackSizeRow"); if(!wrap) return;
  wrap.innerHTML="";
  const db=loadDB();
  const pid=$("opProd")?.value;
  const prod = pid ? getProdById(db,pid) : null;

  // √∂nce √ºr√ºn√ºn bildiƒüi packSizes, yoksa genel preset
  const fallback=[5,6,10,12,15,20];
  const arr = (prod && Array.isArray(prod.packSizes) && prod.packSizes.length) ? prod.packSizes : fallback;

  for(const n of arr.slice(0,10)){
    const b=document.createElement("button");
    b.type="button"; b.className="btn smallBtn";
    b.textContent=`${n}'li`;
    b.title=`Koli i√ßi ${n} adet`;
    b.onclick=()=>{ $("opPackSize").value=String(n); updatePackTotal(); };
    wrap.appendChild(b);
  }
}

/* ====== UI: PRODUCTS ====== */
function renderProducts(){
  const db=loadDB();
  const q=($("inSearch").value||"").trim().toLowerCase();
  const list=$("prodList");
  list.innerHTML="";
  $("pCount").textContent=String(db.products.length);

  const filtered=db.products.filter(p=>!q || (p.name||"").toLowerCase().includes(q));
  if(!filtered.length){
    list.innerHTML=`<div class="item"><div class="hint">√úr√ºn yok / arama sonucu bo≈ü.</div></div>`;
    fillProdSelect();
    reportToday();
    return;
  }

  for(const p of filtered){
    const net=computeStock(db,p.id);
    const packInfo = p.packDefault ? `<span class="tag">koli i√ßi: <b>${p.packDefault}</b></span>` : "";
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`
      <div class="itemTop">
        <div style="flex:1">
          <div class="name">${escapeHTML(p.name||"")}</div>
          <div class="muted">ID: ${p.id.slice(0,8)} ‚Ä¢ ${new Date(p.ts||Date.now()).toLocaleString("tr-TR")}</div>
        </div>
        <div class="netBox"><div class="netBig" title="Net Stok">${net}</div></div>
      </div>
      <div class="miniRow">
        <span class="tag">Net: <b>${net}</b></span>
        ${packInfo}
        <button class="btn smallBtn btnOK" data-act="plus" data-pid="${p.id}" type="button">+ ƒ∞≈ülem</button>
        <button class="btn smallBtn btnBAD" data-act="minus" data-pid="${p.id}" type="button">- ƒ∞≈ülem</button>
        <button class="btn smallBtn" data-act="hist" data-pid="${p.id}" type="button">Ge√ßmi≈ü</button>
      </div>
      <div class="list" id="hist_${p.id}" style="display:none;margin-top:10px"></div>
    `;
    list.appendChild(el);
  }

  list.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act=btn.getAttribute("data-act");
      const pid=btn.getAttribute("data-pid");
      if(act==="hist"){ toggleHistory(pid); return; }
      openModal(pid, act==="plus" ? "+" : "-");
    });
  });

  fillProdSelect();
  reportToday();
}

/* ====== HISTORY ====== */
function toggleHistory(pid){
  const db=loadDB();
  const box=$("hist_"+pid);
  if(!box) return;
  const visible = box.style.display!=="none";
  if(visible){ box.style.display="none"; return; }
  box.style.display="block";

  const ops=db.ops.filter(o=>o.pid===pid).sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,60);
  if(!ops.length){
    box.innerHTML=`<div class="item"><div class="hint">Bu √ºr√ºnde i≈ülem yok.</div></div>`;
    return;
  }
  box.innerHTML=ops.map(o=>{
    const dt=new Date(o.ts||Date.now()).toLocaleString("tr-TR");
    const sign=o.dir==="+"?"+":"-";
    const unit = (o.unitMode==="koli" && o.packCount && o.packSize) ? ` ‚Ä¢ ${o.packCount} koli √ó ${o.packSize}` : "";
    return `
      <div class="item" style="background:rgba(255,255,255,.02)">
        <div class="row" style="justify-content:space-between">
          <div class="name">${sign}${o.qty} ‚Ä¢ ${escapeHTML(o.typeLabel||o.type||"")}${unit}</div>
          <div class="tag">${escapeHTML(dt)}</div>
        </div>
        <div class="muted">${escapeHTML(o.sub||"")} ${o.note?(" ‚Ä¢ "+escapeHTML(o.note)):""}</div>
      </div>
    `;
  }).join("");
}

/* ====== MODAL ====== */
function fillProdSelect(){
  const db=loadDB();
  const sel=$("opProd"); if(!sel) return;
  const cur=sel.value;
  sel.innerHTML="";
  for(const p of db.products){
    const net=computeStock(db,p.id);
    const opt=document.createElement("option");
    opt.value=p.id;
    opt.textContent=`${p.name}  (net:${net})`;
    sel.appendChild(opt);
  }
  if(cur && [...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

function fillTypeSelect(dirHint){
  const tSel=$("opType");
  tSel.innerHTML="";
  for(const t of TYPE_DEF){
    if(dirHint && t.dir!==dirHint) continue;
    const opt=document.createElement("option");
    opt.value=t.k; opt.textContent=t.label;
    tSel.appendChild(opt);
  }
  tSel.selectedIndex=0;
  fillSubSelect();
  buildQuickRow();
}

function fillSubSelect(){
  const tSel=$("opType");
  const sSel=$("opSub");
  const t=TYPE_DEF.find(x=>x.k===tSel.value);
  sSel.innerHTML="";
  const none=document.createElement("option");
  none.value=""; none.textContent="Alt kƒ±rƒ±lƒ±m (opsiyonel)";
  sSel.appendChild(none);
  if(t && Array.isArray(t.subs)){
    for(const sub of t.subs){
      const opt=document.createElement("option");
      opt.value=sub; opt.textContent=sub;
      sSel.appendChild(opt);
    }
  }
  sSel.selectedIndex=0;
}

function buildQuickRow(){
  const wrap=$("quickRow"); if(!wrap) return;
  wrap.innerHTML="";
  const t=TYPE_DEF.find(x=>x.k===$("opType").value);
  if(!t) return;
  const arr=(t.subs||[]).slice(0,6);
  for(const sub of arr){
    const b=document.createElement("button");
    b.className="btn smallBtn"; b.type="button";
    b.textContent=sub.split("‚Ä¢")[0].trim();
    b.title=sub;
    b.onclick=()=>{ $("opSub").value=sub; };
    wrap.appendChild(b);
  }
}

function openModal(pid, dirHint){
  $("modal").style.display="block";
  fillProdSelect();
  if(pid) $("opProd").value=pid;
  fillTypeSelect(dirHint);

  $("opQty").value="";
  $("opPackCount").value="";
  $("opPackSize").value="";
  $("opNote").value="";
  setMode("adet");
}

function closeModal(){ $("modal").style.display="none"; }

function addProduct(){
  const name=($("inProd").value||"").trim();
  if(!name){ alert("√úr√ºn adƒ± yaz."); return; }
  const db=loadDB();
  db.products.push({id:uid(), name, ts:Date.now(), packDefault:0, packSizes:[]});
  saveDB(db);
  $("inProd").value="";
  renderProducts();
  try{$("inProd").focus({preventScroll:true});}catch(e){}
}

function addOp(){
  const pid=$("opProd").value;
  if(!pid){ alert("√úr√ºn se√ß."); return; }

  let qty=0, packCount=0, packSize=0;

  if(OP_MODE==="adet"){
    qty = Math.abs(parseInt(($("opQty").value||"").trim(),10))||0;
    if(!qty){ alert("Adet gir (√∂rn 3)."); $("opQty").focus(); return; }
  }else{
    packCount = Math.abs(parseInt(($("opPackCount").value||"").trim(),10))||0;
    packSize  = Math.abs(parseInt(($("opPackSize").value||"").trim(),10))||0;
    qty = packCount * packSize;
    if(!qty){
      alert("Koli sayƒ±sƒ± ve koli i√ßi adet gir (√∂rn 2 koli √ó 12).");
      try{$("opPackCount").focus();}catch(e){}
      return;
    }
    learnPackToProduct(packSize);
  }

  const tKey=$("opType").value;
  const t=TYPE_DEF.find(x=>x.k===tKey);
  if(!t){ alert("T√ºr se√ß."); return; }

  const db=loadDB();
  const sub=($("opSub").value||"").trim();
  const note=($("opNote").value||"").trim();

  db.ops.push({
    id:uid(), pid,
    dir:t.dir, type:t.k, typeLabel:t.label,
    sub, note,
    qty,
    unitMode: OP_MODE,
    packCount, packSize,
    ts:Date.now(),
    day: todayISO()
  });
  saveDB(db);
  closeModal();
  renderProducts();
}

/* ====== REPORT ====== */
function opsInDays(db, days){
  const now=new Date();
  const from=new Date(now.getTime()-days*24*3600*1000);
  return db.ops.filter(o=> new Date(o.ts||0) >= from);
}
function reportForDays(days){
  const db=loadDB();
  const ops=opsInDays(db, days);
  let plus=0, minus=0;
  for(const o of ops){
    const q=Number(o.qty||0);
    if(o.dir==="+") plus+=q; else minus+=q;
  }
  $("rPlus").textContent=String(plus);
  $("rMinus").textContent=String(minus);
  $("rNet").textContent=String(plus-minus);

  const m=new Map();
  for(const o of ops){
    const p=db.products.find(x=>x.id===o.pid);
    if(!p) continue;
    const cur=m.get(p.id)||{name:p.name, plus:0, minus:0};
    if(o.dir==="+") cur.plus+=Number(o.qty||0); else cur.minus+=Number(o.qty||0);
    m.set(p.id,cur);
  }
  const top=[...m.values()].sort((a,b)=>(b.plus+b.minus)-(a.plus+a.minus)).slice(0,8);
  $("rTop").innerHTML = top.length ? top.map(x=>`
    <div class="item">
      <div class="row" style="justify-content:space-between">
        <div class="name">${escapeHTML(x.name)}</div>
        <div class="tag">net ${x.plus-x.minus}</div>
      </div>
      <div class="muted">+${x.plus} / -${x.minus}</div>
    </div>
  `).join("") : `<div class="item"><div class="hint">Bu aralƒ±kta veri yok.</div></div>`;

  const tm=new Map();
  for(const o of ops){
    const k=o.typeLabel||o.type||"";
    tm.set(k, (tm.get(k)||0) + Number(o.qty||0));
  }
  const trows=[...tm.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
  $("rTypes").innerHTML = trows.length ? trows.map(([k,v])=>`
    <div class="item"><div class="row" style="justify-content:space-between">
      <div class="name">${escapeHTML(k)}</div><div class="tag">${v}</div>
    </div></div>
  `).join("") : `<div class="item"><div class="hint">T√ºr verisi yok.</div></div>`;

  const brain=[];
  if(ops.length===0) brain.push("Veri yok: √∂nce i≈ülem gir.");
  if(minus>plus) brain.push("üü• Eksilme artƒ±dan fazla (satƒ±≈ü/skt/iade baskƒ±n).");
  if(plus>0 && minus===0) brain.push("üüß Sadece artƒ±≈ü var (daƒüƒ±lƒ±m/sipari≈ü var, satƒ±≈ü yok).");
  if(plus-minus<0) brain.push("üü• Net negatif: stok a√ßƒ±ƒüƒ±/yanlƒ±≈ü kayƒ±t ihtimali.");
  if(brain.length===0) brain.push("üü© Stabil: kritik sinyal yok.");
  $("rBrain").innerHTML = brain.map(t=>`<div class="item"><div class="name">${escapeHTML(t)}</div></div>`).join("");
}
function reportToday(){ reportForDays(1); }

/* ====== ERROR GUARD ====== */
(function(){
  function showError(msg){
    const box=$("errorGuardBox"), txt=$("errorGuardText");
    if(!box||!txt) return;
    box.style.display="block";
    txt.textContent=msg;
  }
  window.addEventListener("error", e=> showError((e.message||"Hata")+" @ "+(e.filename||"")+":"+(e.lineno||"")));
  window.addEventListener("unhandledrejection", e=> showError("Promise Error: "+(e.reason?.message||e.reason)));
})();

/* ====== HOOK ====== */
document.addEventListener("DOMContentLoaded", ()=>{
  $("btnAddProd").onclick=addProduct;
  $("inProd").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addProduct(); }});
  $("btnClearSearch").onclick=()=>{ $("inSearch").value=""; renderProducts(); };
  $("inSearch").addEventListener("input", ()=> renderProducts());

  $("btnAddOp").onclick=()=> openModal("", "");
  $("btnClose").onclick=closeModal;
  $("modal").addEventListener("click", (e)=>{ if(e.target && e.target.id==="modal") closeModal(); });

  $("btnModeAdet").onclick=()=> setMode("adet");
  $("btnModeKoli").onclick=()=> setMode("koli");

  $("opPackCount").addEventListener("input", updatePackTotal);
  $("opPackSize").addEventListener("input", updatePackTotal);
  $("opProd").addEventListener("change", ()=>{
    if(OP_MODE==="koli"){ syncPackDefaultsFromProduct(); buildQuickPackSizeRow(); }
    updatePackTotal();
  });

  $("opType").addEventListener("change", ()=>{ fillSubSelect(); buildQuickRow(); });

  $("btnSaveOp").onclick=addOp;

  $("btnReportToday").onclick=()=>reportToday();
  $("btnReport7").onclick=()=>reportForDays(7);
  $("btnReport30").onclick=()=>reportForDays(30);

  renderProducts();
});
</script>
</body>
</html>
