<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stok Kontrol Motoru</title>
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{
      --bg:#070b14; --card:#0b1220; --card2:#0d1730;
      --text:#e5e7eb; --muted:#94a3b8; --line:rgba(255,255,255,.08);
      --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b; --blue:#2563eb;
      --r:20px; --pad:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070b14,#05070f);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(7,11,20,.72);backdrop-filter: blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:920px;margin:0 auto;padding:14px 14px 18px}
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.15fr .85fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px;font-size:15px}
    .hint{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    input,select,textarea{
      width:100%; background:rgba(255,255,255,.03); color:var(--text);
      border:1px solid var(--line); border-radius:16px; padding:12px 12px;
      outline:none; font-size:14px;
    }
    input::placeholder,textarea::placeholder{color:rgba(148,163,184,.7)}
    .btn{
      border:0; border-radius:16px; padding:12px 14px; font-weight:900;
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer;
      border:1px solid rgba(255,255,255,.08);
      user-select:none;
    }
    .btnOK{background:rgba(22,163,74,.18); border-color:rgba(22,163,74,.35)}
    .btnBAD{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.35)}
    .btnBLUE{background:rgba(37,99,235,.16); border-color:rgba(37,99,235,.35)}
    .btn:active{transform:translateY(1px)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);font-size:12px}
    .kpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .kpi .pill{justify-content:center;font-weight:900}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{padding:12px;border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.03)}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .name{font-weight:950}
    .muted{color:var(--muted);font-size:12px;margin-top:4px}
    .miniRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted)}
    .netBig{font-size:26px;font-weight:1000;letter-spacing:.3px}
    .netBox{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .smallBtn{padding:10px 12px;border-radius:14px}
    .danger{color:#fecaca}
    /* REPORT_COMPACT_V2 */
    #cardReport{max-height: calc(100vh - 150px); overflow:auto; -webkit-overflow-scrolling: touch;}
    #cardReport .row:first-of-type{position: sticky; top:0; z-index:5; background: var(--card, #fff); padding-top:10px; padding-bottom:10px;}
    #cardReport .hr{margin:10px 0}
    /* ERROR_GUARD */
    #errorGuardBox{position:fixed;left:0;right:0;bottom:0;background:#7f1d1d;color:#fff;padding:12px;font-size:12px;display:none;z-index:99999;max-height:40vh;overflow:auto;border-top:2px solid #ef4444}
  
/* MODAL_ONEHAND_V1 */
#modal .card{
  position:relative;
}
#modal .onehandBar{
  position: sticky;
  bottom: 0;
  z-index: 20;
  background: rgba(11,18,32,.92);
  backdrop-filter: blur(8px);
  border-top: 1px solid rgba(255,255,255,.08);
  padding-top: 10px;
  padding-bottom: 10px;
  margin-top: 12px;
}
#modal .onehandBar .btn{ width: 100%; padding: 14px 16px; border-radius: 18px; }
#modal .fastTypeRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
#modal .fastTypeRow .btn{
  padding:10px 12px;
  border-radius: 999px;
  font-weight: 900;
}
#modal #opQty{
  font-size: 16px;
  font-weight: 900;
}


/* QUICK_QTY_V1 */
#quickQtyRow .btn{
  padding:10px 12px;
  border-radius:999px;
  font-weight:950;
}


/* V12_KOLI_MODE_MODAL_OPAQUE_V2 */
#modal{background:rgba(0,0,0,.78) !important;}
.modalCard{
  background: var(--card) !important;
  border: 1px solid var(--line) !important;
  box-shadow: 0 18px 50px rgba(0,0,0,.55) !important;
}
.modeBtn{padding:10px 12px;border-radius:999px}
.modeBtnOn{background:rgba(37,99,235,.22);border-color:rgba(37,99,235,.45)}
.modeHint{color:var(--muted);font-size:12px;margin-top:6px}


/* V15_UNDO_DELETE_OPS */
.btnMini{
  padding:8px 10px;
  border-radius:12px;
  font-size:12px;
  font-weight:900;
}
.btnDel{
  background:rgba(239,68,68,.14);
  border-color:rgba(239,68,68,.35);
}


/* V16_REPORT_DETAIL_STOCK_CSV */

/* V17_HQ_REPORTS */
function sumQty(list){
  let n=0;
  for(const o of list){ n += Number(o.qty||0); }
  return n;
}

function filterType(ops, typeKey){
  return ops.filter(o => (o.type===typeKey) || (String(o.typeLabel||"").toLowerCase().includes(typeKey)));
}

function subBreakdown(list){
  const m=new Map();
  for(const o of list){
    const k=(o.sub||"").trim() || "Alt yok";
    m.set(k, (m.get(k)||0) + Number(o.qty||0));
  }
  return [...m.entries()].sort((a,b)=>b[1]-a[1]);
}

function dailySeries(ops, typeKey, days){
  // son N gÃ¼n (bugÃ¼n dahil) typeKey toplamÄ±
  const out=[];
  const now=new Date();
  for(let i=days-1;i>=0;i--){
    const d=new Date(now.getTime()-i*24*3600*1000);
    const key=d.toISOString().slice(0,10);
    let total=0;
    for(const o of ops){
      const day=o.day || (new Date(o.ts||0).toISOString().slice(0,10));
      if(day!==key) continue;
      if(typeKey && o.type!==typeKey) continue;
      total += Number(o.qty||0);
    }
    out.push([key,total]);
  }
  return out;
}

function renderHQSales(db, ops, days){
  const box=$("rHQSales");
  if(!box) return;

  const sales = ops.filter(o=>o.type==="satis");
  const total = sumQty(sales);

  const bd = subBreakdown(sales).slice(0,10);
  const series = dailySeries(ops, "satis", Math.min(7, Math.max(1, days)));

  const bdHtml = bd.length ? bd.map(([k,v])=>`
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">${escapeHTML(k)}</div>
        <div class="badge"><b>${fmtInt(v)}</b></div>
          ${speedHTMLLight(__crit[p.id])}
      </div>
    </div>
  `).join("") : `<div class="miniLine"><div class="hint">SatÄ±ÅŸ alt kÄ±rÄ±lÄ±m yok.</div></div>`;

  const serHtml = series.map(([d,v])=>`
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">${escapeHTML(d.slice(5))}</div>
        <div class="badge"><b>${fmtInt(v)}</b></div>
      </div>
    </div>
  `).join("");

  box.innerHTML = `
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Toplam SatÄ±ÅŸ</div>
        <div class="badge">adet <b>${fmtInt(total)}</b></div>
      </div>
      <div class="rTiny">AralÄ±k: ${fmtInt(days)} gÃ¼n â€¢ â€œSatÄ±ÅŸ (-)â€ iÅŸlemlerinden</div>
    </div>
    <div class="rTiny" style="margin-top:8px">SatÄ±ÅŸ alt kÄ±rÄ±lÄ±m</div>
    ${bdHtml}
    <div class="rTiny" style="margin-top:8px">GÃ¼nlÃ¼k satÄ±ÅŸ (son ${Math.min(7, Math.max(1, days))} gÃ¼n)</div>
    ${serHtml}
  `;
}

function renderHQInsert(db, ops, days){
  const box=$("rHQInsert");
  if(!box) return;

  const dist = ops.filter(o=>o.type==="dagilim").filter(o=>String(o.sub||"").toLowerCase().includes("insert"));
  const sales = ops.filter(o=>o.type==="satis").filter(o=>String(o.sub||"").toLowerCase().includes("insert"));

  const dTot = sumQty(dist);
  const sTot = sumQty(sales);
  const ratio = dTot>0 ? (sTot/dTot) : 0;
  const net = dTot - sTot;

  let signal = "ğŸŸ© Normal";
  if(dTot>0 && ratio < 0.35) signal = "ğŸŸ¥ ZayÄ±f (insert satÄ±ÅŸ dÃ¼ÅŸÃ¼k)";
  else if(dTot>0 && ratio < 0.60) signal = "ğŸŸ§ Orta";

  box.innerHTML = `
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Insert DaÄŸÄ±lÄ±m (+)</div>
        <div class="badge"><b>${fmtInt(dTot)}</b></div>
      </div>
      <div class="rTiny">â€œDaÄŸÄ±lÄ±m (+)â€ iÃ§inde alt kÄ±rÄ±lÄ±mÄ± â€œInsertâ€ olanlar</div>
    </div>
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Insert SatÄ±ÅŸ (-)</div>
        <div class="badge"><b>${fmtInt(sTot)}</b></div>
      </div>
      <div class="rTiny">â€œSatÄ±ÅŸ (-)â€ iÃ§inde alt kÄ±rÄ±lÄ±mÄ± â€œInsert satÄ±ÅŸâ€ olanlar</div>
    </div>
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Insert DÃ¶nÃ¼ÅŸÃ¼m</div>
        <div class="badge">% <b>${Math.round(ratio*100)}</b></div>
      </div>
      <div class="rTiny">${signal} â€¢ Net insert (daÄŸÄ±lÄ±m - satÄ±ÅŸ): ${fmtInt(net)}</div>
    </div>
  `;
}

function renderHQReturns(db, ops, days){
  const box=$("rHQReturns");
  if(!box) return;

  const ret = ops.filter(o=>o.type==="iade");
  const total = sumQty(ret);
  const bd = subBreakdown(ret).slice(0,15);

  box.innerHTML = `
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Toplam Ä°ade</div>
        <div class="badge">adet <b>${fmtInt(total)}</b></div>
      </div>
      <div class="rTiny">AralÄ±k: ${fmtInt(days)} gÃ¼n â€¢ â€œÄ°ade (-)â€ iÅŸlemlerinden</div>
    </div>
    ${
      bd.length ? bd.map(([k,v])=>`
        <div class="miniLine">
          <div class="rRow">
            <div class="rKey">${escapeHTML(k)}</div>
            <div class="badge"><b>${fmtInt(v)}</b></div>
          </div>
        </div>
      `).join("") : `<div class="miniLine"><div class="hint">Ä°ade sebep kÄ±rÄ±lÄ±mÄ± yok.</div></div>`
    }
  `;
}

// reportForDays sonrasÄ± hook (V16 varsa onunla uyumlu)
const _reportForDays_V17 = reportForDays;
reportForDays = function(days){
  _reportForDays_V17(days);
  const db = loadDB();
  const ops = opsInDays(db, days);
  renderHQSales(db, ops, days);
  renderHQInsert(db, ops, days);
  renderHQReturns(db, ops, days);
};

.rGrid2{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
@media(min-width:900px){.rGrid2{grid-template-columns:1fr 1fr}}
.rRow{display:flex;justify-content:space-between;gap:10px;align-items:center}
.rKey{font-weight:950}
.rVal{font-weight:950}
.rTiny{color:var(--muted);font-size:12px;margin-top:4px}
.miniTable{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.miniLine{padding:10px 12px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02)}
.miniLine .rRow{align-items:flex-start}
.badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
.badge b{color:var(--text)}


/* V18_SINGLE_EXPORT_ALERTS */

/* Tek ekran modu: her ÅŸeyi alt alta dizer, rapor daha yÃ¶netici gibi tek sayfa */
body.single .grid{grid-template-columns:1fr !important;}
body.single #cardReport{max-height:none !important; overflow:visible !important;}
body.single header{position:sticky; top:0;}

/* Rapor iÃ§i export bar */
.exportBar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
.badge{display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.03); font-size:12px; color:var(--muted)}
.badge b{color:var(--text)}
.miniTable .miniLine{padding:10px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.03);margin-top:8px}
.miniTable .rRow{display:flex;justify-content:space-between;gap:10px;align-items:center}
.miniTable .rKey{font-weight:900}
.miniTable .rTiny{color:var(--muted);font-size:12px;margin-top:6px}
.alertRed{border-color:rgba(239,68,68,.45)!important;background:rgba(239,68,68,.10)!important}
.alertAmber{border-color:rgba(245,158,11,.45)!important;background:rgba(245,158,11,.10)!important}
.alertGreen{border-color:rgba(22,163,74,.45)!important;background:rgba(22,163,74,.10)!important}

/* Print/PDF: yÃ¶netici Ã§Ä±ktÄ±sÄ± */
@media print{
  header{position:static !important; background:#fff !important; color:#000 !important; border:none !important}
  body{background:#fff !important; color:#000 !important}
  .card{box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important}
  .btn, .chip{display:none !important}
  #modal, #errorGuardBox{display:none !important}
  .wrap{max-width:100% !important; padding:0 !important}
  .grid{grid-template-columns:1fr !important}
  .hint{color:#333 !important}
  .tag, .badge{border:1px solid #ddd !important; background:#fff !important; color:#111 !important}
}


/* V22_UI_DECLUTTER */
/* Kompakt mod: daha az padding, daha az satÄ±r, daha Ã§ok iÅŸ */
body.compact .card{padding:12px}
body.compact .item{padding:10px;border-radius:16px}
body.compact .miniRow{gap:6px}
body.compact .btn{padding:10px 12px;border-radius:14px}
body.compact .smallBtn{padding:9px 10px;border-radius:14px}
body.compact .muted{display:none}
body.compact .hint{font-size:11px}
body.compact .netBig{font-size:22px}

/* Detay kapalÄ± mod: raporda sadece KPI + risk + â€œen Ã§ok Ã¼rÃ¼nlerâ€ gÃ¶rÃ¼nsÃ¼n */
body.hideDetails #rTypes,
body.hideDetails #rBrain,
body.hideDetails #btnSkorTest{display:none !important;}
/* Risk paneli varsa kalsÄ±n; yoksa boÅŸ yere yer kaplamasÄ±n */
body.hideDetails #rRisk:empty{display:none !important;}

/* ÃœrÃ¼n kartÄ±nda etiketleri kÄ±s (Net etiketi gereksiz, zaten bÃ¼yÃ¼k sayÄ± var) */
body.compact .tag{padding:6px 8px;font-size:11px}
body.compact .pill{padding:8px 10px}

/* Header kontrol butonlarÄ± daha â€œbuton gibiâ€ olsun */
#btnCompact, #btnDetails{
  cursor:pointer;
  user-select:none;
}
#btnCompact.on, #btnDetails.on{
  background:rgba(37,99,235,.18);
  border-color:rgba(37,99,235,.35);
  color:var(--text);
}


/* V24_COMPACT_MODE */
.compact .miniRow,
.compact .list,
.compact .actions,
.compact .tag{
  display:none !important;
}
.modeSwitch{
  display:inline-flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  font-weight:800;
}


/* V25_STOCK_COLOR_SPEED_V2 */
.stockGreen{ color:#22c55e; font-weight:1000; }
.stockWarn{ color:#f59e0b; font-weight:1000; }
.stockRed{ color:#ef4444; font-weight:1000; }
.miniSpeed{ font-size:12px; margin-top:6px; opacity:.9; color:var(--muted); }

</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Stok Kontrol Motoru</h1>
        <div class="sub">v1 â€” Ã¼rÃ¼n + iÅŸlemler + rapor + â€œakÄ±lâ€ Ã§ekirdeÄŸi</div>
      </div>
      <div class="chip" id="chipMeta">Local â€¢ HazÄ±r</div>
      <button class="chip" id="btnCompact" type="button">Kompakt</button>
      <button class="chip" id="btnDetails" type="button">Detay</button>

      <button class="btn" id="btnSingle" type="button" style="padding:10px 12px;border-radius:999px">Tek Ekran</button>
    </div>
  </div>

  <div style="margin-top:8px">
    <span class="modeSwitch" onclick="toggleCompact()">
      âš™ Detay Modu AÃ§/Kapat
    </span>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- SOL -->
    <section class="card">
      <h2>ÃœrÃ¼n</h2>
      <div class="hint">ÃœrÃ¼n ekle / ara / stok kartlarÄ±</div>
      <div class="row" style="margin-top:10px">
        <input id="inProd" placeholder="ÃœrÃ¼n adÄ± (Enter = ekle)" />
        <button class="btn btnOK" id="btnAddProd" type="button">Ekle</button>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="inSearch" placeholder="Ara (sabit)" />
        <button class="btn smallBtn" id="btnClearSearch" type="button">Temizle</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="pill">Toplam: <b id="pCount">0</b></div>
        <button class="btn btnBLUE" id="btnAddOp" type="button">Ä°ÅŸlem Ekle</button>
      </div>

      <div class="list" id="prodList"></div>
    </section>

    <!-- SAÄ: RAPOR -->
    <section class="card" id="cardReport">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2 style="margin-bottom:2px">Rapor</h2>
          <div class="hint">Ã–zet ve â€œakÄ±lâ€ (bugÃ¼n / 7 gÃ¼n / 30 gÃ¼n)</div>
        </div>
        <div class="row">
          <button id="btnReportToday" class="btn btnBLUE" type="button">BugÃ¼n</button>
          <button id="btnReport7" class="btn btnBLUE" type="button">7g</button>
          <button id="btnReport30" class="btn btnBLUE" type="button">30g</button>
          <button id="btnUndo" class="btn" type="button">Geri Al</button>
        
          <button id="btnCSV" class="btn" type="button">CSV</button>
        </div>
        <div class="exportBar">
          <span class="badge">AralÄ±k: <b id="rDaysLbl">1</b> gÃ¼n</span>
          <button class="btn" id="btnExportCSV" type="button">CSV Export</button>
          <button class="btn" id="btnExportPDF" type="button">PDF (YazdÄ±r)</button>
        </div>
      </div>

      <div class="kpi">
        <div class="pill">ArtÄ±: <b id="rPlus">0</b></div>
        <div class="pill">Eksi: <b id="rMinus">0</b></div>
        <div class="pill">Net: <b id="rNet">0</b></div>
      </div>

      <div class="hr"></div>
      <div class="hint">En Ã§ok Ã¼rÃ¼nler</div>
      <div class="list" id="rTop"></div>

      <div class="hr"></div>
      <div class="hint">TÃ¼r daÄŸÄ±lÄ±mÄ±</div>
      <div class="list" id="rTypes"></div>
<div class="hr"></div>
<div class="hint">ÃœrÃ¼n BazlÄ± SatÄ±ÅŸ (Merkez ekranÄ±)</div>
<div class="card"><div id="rSalesProducts"></div></div>

<div class="hr"></div>
<div class="hint">Insert PerformansÄ± (Ã¼rÃ¼n bazlÄ±)</div>
<div class="card"><div id="rInsertPerf"></div></div>

<div class="hr"></div>
<div class="hint">Ä°ade Nedenleri</div>
<div class="card"><div id="rReturnReasons"></div></div>


<div class="hr"></div>
<div class="hint">Detay (TÃ¼r bazlÄ±)</div>
<div class="miniTable" id="rTypeTotals"></div>

<div class="hr"></div>
<div class="hint">Alt kÄ±rÄ±lÄ±m (SeÃ§ili aralÄ±k)</div>
<div class="miniTable" id="rSubTotals"></div>

<div class="hr"></div>
<div class="hint">Stok Snapshot (Mevcut net stok)</div>
<div class="miniTable" id="rStockNow"></div>


      <div class="hr"></div>
      <div class="hint">Kritik Alarm</div>
      <div class="miniTable" id="rAlerts"></div>

      <div class="hr"></div>
      <div class="hint">AkÄ±l</div>
      <div class="list" id="rBrain"></div>

<div class="hr"></div>
<div class="hint">Merkez Raporu (seÃ§ili aralÄ±k)</div>

<div class="miniTable" id="rHQSales"></div>

<div class="hr"></div>
<div class="hint">Insert PerformansÄ± (seÃ§ili aralÄ±k)</div>
<div class="miniTable" id="rHQInsert"></div>

<div class="hr"></div>
<div class="hint">Ä°ade Sebepleri (seÃ§ili aralÄ±k)</div>
<div class="miniTable" id="rHQReturns"></div>


      <div class="hr"></div>
      <button class="btn" id="btnSkorTest" type="button">Skor Test (debug)</button>
      <div class="hint" style="margin-top:8px">Sadece test: ilk Ã¼rÃ¼ne gÃ¶re skor/Ã§Ä±ktÄ± verir.</div>
    </section>
  </div>
</main>

<!-- MODAL -->
<div id="modal" style="position:fixed;inset:0;display:none;z-index:9999;background:rgba(0,0,0,.6);padding:14px">
  <div class="card" modalCard style="max-width:720px;margin:0 auto;max-height:85vh;overflow:auto">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="name">Ä°ÅŸlem Ekle</div>
        <div class="hint">ÃœrÃ¼n seÃ§ â†’ tÃ¼r seÃ§ â†’ alt kÄ±rÄ±lÄ±m (varsa) â†’ adet</div>
      </div>
      <button class="btn" id="btnClose" type="button">Kapat</button>
    </div>

    <div class="hr"></div>

    <div class="row">
      <select id="opProd"></select>

      <div class="row" style="gap:8px">
        <button class="btn modeBtn modeBtnOn" id="btnModeAdet" type="button">Adet</button>
        <button class="btn modeBtn" id="btnModeKoli" type="button">Koli</button>
      </div>
    </div>

    <!-- ADET MODU -->
    <div id="wrapAdet">
      <div class="row" style="margin-top:10px">
        <input id="opQty" inputmode="numeric" placeholder="Adet (Ã¶rn 3)" />
      </div>
      <div class="hint">HÄ±zlÄ± adet</div>
      <div class="miniRow" id="quickQtyRow"></div>
    </div>

    <!-- KOLÄ° MODU -->
    <div id="wrapKoli" style="display:none">
      <div class="row" style="margin-top:10px">
        <input id="opPackCount" inputmode="numeric" placeholder="Koli sayÄ±sÄ± (Ã¶rn 2)" />
        <input id="opPackSize" inputmode="numeric" placeholder="Koli iÃ§i adet (Ã¶rn 12)" />
      </div>

      <div class="hint">HÄ±zlÄ± koli sayÄ±sÄ±</div>
      <div class="miniRow" id="quickPackRow"></div>

      <div class="modeHint">Toplam adet: <b id="opPackTotal">0</b> (koliÃ—iÃ§ adet)</div>
      <div class="modeHint">Not: Koli iÃ§i adet girersen sistem bunu bu Ã¼rÃ¼ne hatÄ±rlar.</div>
    </div>

    <div class="hint">HÄ±zlÄ± adet / koli</div>
    <div class="miniRow" id="quickQtyRow"></div>


    <div class="miniRow" id="qtyRow" style="margin-top:8px"></div>

    <div class="hint">HÄ±zlÄ± tÃ¼r (tek dokunuÅŸ)</div>
    <div class="fastTypeRow" id="fastTypeRow"></div>

    <div class="row">
      <select id="opType"></select>
      <select id="opSub"></select>
    </div>

    <div class="row">
      <input id="opNote" placeholder="Not (opsiyonel)" />
    </div>

    <div class="onehandBar">
      <button class="btn btnOK" id="btnSaveOp" type="button">Kaydet</button>
    </div>

    <div class="hr"></div>
    <div class="hint">HÄ±zlÄ± seÃ§im (tek dokunuÅŸ)</div>
    <div class="miniRow" id="quickRow"></div>
  </div>
</div>

<div id="errorGuardBox"><b>Sistem HatasÄ±:</b><br><div id="errorGuardText"></div></div>

<script>
/* FAST_OPS_V1 */
/* MODAL_ONEHAND_V1 */
/* QUICK_QTY_V1 */
/* V12_KOLI_MODE_MODAL_OPAQUE_V2 */
/* V14_FASTOPS_SOLID */
/* V15_UNDO_DELETE_OPS */
/* V16_REPORT_DETAIL_STOCK_CSV */
/* V17_HQ_REPORTS */
/* V18_SINGLE_EXPORT_ALERTS */
/* V19_MANAGER_REPORTS_SAFE */
/* V20_FORECAST_ENGINE */
/* V21_RISK_ENGINE */
/* V22_UI_DECLUTTER */
/* V24_COMPACT_MODE */
/* V25_STOCK_COLOR_SPEED_V2 */
/* ====== CORE DB ====== */
// V15: Undo / Delete altyapÄ±sÄ±
function ensureMeta(db){
  if(!db.meta || typeof db.meta!=="object") db.meta={};
  if(!Array.isArray(db.meta.undoStack)) db.meta.undoStack=[];
  return db;
}

function rememberUndo(db){
  ensureMeta(db);
  try{
    const last = (db.ops && db.ops.length) ? db.ops[db.ops.length-1] : null;
    if(last && last.id){
      db.meta.undoStack.push(last.id);
      // ÅŸiÅŸmesin
      if(db.meta.undoStack.length>60) db.meta.undoStack = db.meta.undoStack.slice(-60);
      db.meta.lastOpId = last.id;
    }
  }catch(e){}
}

function removeOpById(db, opId){
  if(!opId) return False
  let idx = -1
  for(let i=0;i<(db.ops||[]).length;i++){
    if(db.ops[i] && db.ops[i].id===opId){ idx=i; break; }
  }
  if(idx<0) return false;

  db.ops.splice(idx,1);

  // undoStackâ€™ten de temizle (tÃ¼m kopyalar)
  ensureMeta(db);
  db.meta.undoStack = (db.meta.undoStack||[]).filter(x=>x!==opId);
  if(db.meta.lastOpId===opId) db.meta.lastOpId = db.meta.undoStack.length ? db.meta.undoStack[db.meta.undoStack.length-1] : null;
  return true;
}

function undoLast(){
  const db=ensureMeta(loadDB());
  const st=db.meta.undoStack||[];
  if(!st.length){
    alert("Geri alÄ±nacak iÅŸlem yok.");
    return;
  }
  const opId = st.pop();
  const ok = removeOpById(db, opId);
  saveDB(db);
  renderProducts();
  if(!ok) alert("Ä°ÅŸlem bulunamadÄ± (zaten silinmiÅŸ olabilir).");
}

function deleteOp(opId, pid){
  const db=ensureMeta(loadDB());
  const ok = removeOpById(db, opId);
  saveDB(db);
  renderProducts();
  // aynÄ± Ã¼rÃ¼nÃ¼n geÃ§miÅŸini tekrar aÃ§ (tek dokunuÅŸla geri dÃ¶nsÃ¼n)
  try{ if(pid) toggleHistory(pid); }catch(e){}
  if(!ok) alert("Silme baÅŸarÄ±sÄ±z (iÅŸlem bulunamadÄ±).");
}


const KEY="stok_kontrol_db_v1";
const $=id=>document.getElementById(id);

function loadDB(){
  let db=null;
  try{ db=JSON.parse(localStorage.getItem(KEY)||"null"); }catch(e){}
  if(!db || typeof db!=="object") db={products:[], ops:[], meta:{v:1}};
  if(!Array.isArray(db.products)) db.products=[];
  if(!Array.isArray(db.ops)) db.ops=[];
  if(!db.meta) db.meta={v:1};
  return db;
}
function saveDB(db){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Date.now().toString(16)+Math.random().toString(16).slice(2); }
function todayISO(){ return new Date().toISOString().slice(0,10); }

/* ====== TYPES (Senin mantÄ±ÄŸÄ±n) ====== */
/*
Artma tetikleri:
- SipariÅŸ (Firma/Depo altÄ±)  -> + (opsiyonel detay)
- DaÄŸÄ±lÄ±m (Normal/Ä°skonto/Insert + kaynak) -> +
Eksilme tetikleri:
- SatÄ±ÅŸ -> -
- SKT -> -
- Ä°ade (MÃ¼ÅŸteri/Tarihi geÃ§miÅŸ/Fabrika/Raf) -> -
*/
const TYPE_DEF = [
  {k:"siparis",  label:"SipariÅŸ (+)", dir:"+", subs:[
    "Firma â€¢ Ziyaret aldÄ±",
    "Firma â€¢ Telefon geldi",
    "Firma â€¢ Telefon ettik",
    "Depo â€¢ Merkez depoya",
    "Depo â€¢ ÅarkÃ¼teri depoya"
  ]},
  {k:"dagilim",  label:"DaÄŸÄ±lÄ±m (+)", dir:"+", subs:[
    "Merkez â€¢ Normal",
    "Merkez â€¢ Ä°skonto",
    "Merkez â€¢ Insert",
    "Insert â€¢ (isim/tarih not'a)"
  ]},
  {k:"satis",    label:"SatÄ±ÅŸ (-)",   dir:"-", subs:[
    "Normal satÄ±ÅŸ",
    "Insert satÄ±ÅŸ",
    "Ä°skonto satÄ±ÅŸ"
  ]},
  {k:"skt",      label:"SKT (-)",     dir:"-", subs:[
    "Tarihi yaklaÅŸan kontrol",
    "Tarihi geÃ§miÅŸ ayrÄ±ldÄ±"
  ]},
  {k:"iade",     label:"Ä°ade (-)",    dir:"-", subs:[
    "MÃ¼ÅŸteri iadesi",
    "Tarihi geÃ§miÅŸ",
    "Fabrika kaynaklÄ±",
    "Raf kaynaklÄ±"
  ]},
];

/* V14_FASTOPS_SOLID */
function getProdById(db, pid){
  return (db.products||[]).find(x=>x.id===pid) || null;
}

function pickTypeByDir(dir, preferredKey){
  if(preferredKey){
    const t0 = TYPE_DEF.find(t=>t.k===preferredKey && t.dir===dir);
    if(t0) return t0;
  }
  return TYPE_DEF.find(t=>t.dir===dir) || null;
}

function rememberLastSelection(pid, dir, typeKey, sub){
  const db=loadDB();
  const prod=getProdById(db,pid);
  if(!prod) return;

  if(dir==="+"){
    prod.lastPlusType = typeKey || prod.lastPlusType;
    prod.lastPlusSub  = (sub!==undefined) ? sub : (prod.lastPlusSub||"");
  }else{
    prod.lastMinusType = typeKey || prod.lastMinusType;
    prod.lastMinusSub  = (sub!==undefined) ? sub : (prod.lastMinusSub||"");
  }
  rememberLastSelection(pid, t.dir, t.k, sub);
  saveDB(db);
}

function fastOp(pid, dir, unitMode, qty, packCount, packSize){
  const db=loadDB();
  const prod=getProdById(db,pid);
  if(!prod) return;

  const preferred = (dir==="+") ? prod.lastPlusType : prod.lastMinusType;
  const t = pickTypeByDir(dir, preferred);
  if(!t){ alert("TÃ¼r bulunamadÄ± (TYPE_DEF)."); return; }

  const sub = (dir==="+") ? (prod.lastPlusSub||"") : (prod.lastMinusSub||"");

  db.ops.push({
    id: uid(),
    pid,
    dir: t.dir,
    type: t.k,
    typeLabel: t.label,
    sub: sub,
    note: "",
    qty: qty,
    unitMode: unitMode,
    packCount: packCount || 0,
    packSize: packSize || 0,
    ts: Date.now(),
    day: todayISO()
  });

  
  rememberUndo(db);
rememberLastSelection(pid, dir, t.k, sub);

  saveDB(db);
  renderProducts();
}


/* V12_KOLI_MODE_MODAL_OPAQUE_V2 */
let OP_MODE = "adet"; // "adet" | "koli"

function setMode(mode){
  OP_MODE = mode;

  const bA = $("btnModeAdet"), bK = $("btnModeKoli");
  const wA = $("wrapAdet"), wK = $("wrapKoli");
  if(!bA||!bK||!wA||!wK) return;

  if(mode==="adet"){
    bA.classList.add("modeBtnOn");
    bK.classList.remove("modeBtnOn");
    wA.style.display="";
    wK.style.display="none";
    setTimeout(()=>{ try{$("opQty").focus({preventScroll:true});}catch(e){} }, 60);
  }else{
    bK.classList.add("modeBtnOn");
    bA.classList.remove("modeBtnOn");
    wK.style.display="";
    wA.style.display="none";
    syncPackDefaultsFromProduct();
    buildQuickPackRow();
    updatePackTotal();
    setTimeout(()=>{ try{$("opPackCount").focus({preventScroll:true});}catch(e){} }, 60);
  }
}

function updatePackTotal(){
  const c = parseInt(($("opPackCount")?.value || "0").trim(), 10) || 0;
  const s = parseInt(($("opPackSize")?.value  || "0").trim(), 10) || 0;
  const tot = Math.max(0, c) * Math.max(0, s);
  const out = $("opPackTotal");
  if(out) out.textContent = String(tot);
}

function buildQuickPackRow(){
  const wrap = $("quickPackRow");
  if(!wrap) return;
  wrap.innerHTML="";
  const presets=[1,2,3,4,5];
  for(const n of presets){
    const b=document.createElement("button");
    b.type="button";
    b.className="btn smallBtn";
    b.textContent=String(n)+" koli";
    b.addEventListener("click", ()=>{
      $("opPackCount").value = String(n);
      updatePackTotal();
      try{$("opPackCount").focus({preventScroll:true});}catch(e){}
    });
    wrap.appendChild(b);
  }
}

function syncPackDefaultsFromProduct(){
  const db = loadDB();
  const pid = $("opProd")?.value;
  if(!pid) return;
  const prod = db.products.find(x=>x.id===pid);
  if(!prod) return;

  if(prod.packDefault && !String($("opPackSize")?.value||"").trim()){
    $("opPackSize").value = String(prod.packDefault);
  }
}

function learnPackDefaultToProduct(packSize){
  const n = parseInt(String(packSize||"").trim(),10) || 0;
  if(n<=0) return;

  const db = loadDB();
  const pid = $("opProd")?.value;
  if(!pid) return;
  const prod = db.products.find(x=>x.id===pid);
  if(!prod) return;

  prod.packDefault = n;
  saveDB(db);
}


function computeStock(db, pid){
  let net=0;
  for(const o of db.ops){
    if(o.pid!==pid) continue;
    const qty = Number(o.qty||0);
    if(!qty) continue;
    net += (o.dir==="+" ? qty : -qty);
  }
  return net;
}

/* ====== RENDER PRODUCTS ====== */

/* V24_COMPACT_MODE */
let COMPACT_MODE = true;

function applyCompact(){
  const root=document.body;
  if(COMPACT_MODE){
    root.classList.add("compact");
  }else{
    root.classList.remove("compact");
  }
}

function toggleCompact(){
  COMPACT_MODE=!COMPACT_MODE;
  applyCompact();
}

document.addEventListener("DOMContentLoaded", ()=>{
  applyCompact();
});

/* V25_STOCK_COLOR_SPEED_V2 */
function computeLightCrit(db, pid){
  const net = computeStock(db, pid);

  // son 7 gÃ¼n eksi akÄ±ÅŸ: satis+iade+skt
  const ops7 = (db.ops||[]).filter(o=>{
    if(o.pid!==pid) return false;
    const t = new Date(o.ts||0).getTime();
    return t >= (Date.now() - 7*24*3600*1000);
  });

  let out7=0;
  for(const o of ops7){
    const q=Number(o.qty||0);
    if(!q) continue;
    if(o.dir==="-" && (o.type==="satis" || o.type==="iade" || o.type==="skt")) out7 += q;
  }

  const avg = out7/7;
  const daysLeft = (avg>0) ? (net/avg) : Infinity;

  let level="ok";
  if(net<0) level="red";
  else if(net===0 && avg>0) level="red";
  else if(daysLeft<=3) level="red";
  else if(daysLeft<=7) level="warn";

  return {net, avgDailyOut: avg, daysLeft, level};
}

function stockClassByLevel(level){
  if(level==="red") return "stockRed";
  if(level==="warn") return "stockWarn";
  return "stockGreen";
}

function speedHTMLLight(meta){
  if(!meta) return "";
  if(!meta.avgDailyOut || meta.avgDailyOut<=0) return "";
  return '<div class="miniSpeed">GÃ¼nlÃ¼k Ã§Ä±kÄ±ÅŸ ort: <b>'+meta.avgDailyOut.toFixed(1)+'</b></div>';
}
function renderProducts(){
  const db=loadDB();
  const q=($("inSearch").value||"").trim().toLowerCase();
  const list=$("prodList");
  list.innerHTML="";
  $("pCount").textContent=String(db.products.length);

  const filtered = db.products.filter(p=>!q || (p.name||"").toLowerCase().includes(q));

  if(!filtered.length){
    list.innerHTML = `<div class="item"><div class="hint">ÃœrÃ¼n yok / arama sonucu boÅŸ.</div></div>`;
    fillProdSelect(); // modal select gÃ¼ncel kalsÄ±n
    reportToday();
    return;
  }

  const __crit = {};
  for(const p of filtered){
    try{ __crit[p.id]=computeLightCrit(db,p.id); }catch(e){ __crit[p.id]=null; }
    const net = computeStock(db, p.id);
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`
      <div class="itemTop">
        <div style="flex:1">
          <div class="name">${escapeHTML(p.name||"")}</div>
          <div class="muted">ID: ${p.id.slice(0,8)} â€¢ Son: ${new Date(p.ts||Date.now()).toLocaleString("tr-TR")}</div>
        </div>
        <div class="netBox">
          <div class="netBig" title="Net Stok"><span class="${stockClassByLevel((__crit[p.id]&&__crit[p.id].level)||'ok')}">${net}</span></div>
        </div>
      </div>
      <div class="miniRow">
        <span class="tag">Net: <b>${net}</b></span>
        <button class="btn smallBtn" data-act="qplus" data-pid="${p.id}" type="button">+1</button>
        <button class="btn smallBtn" data-act="qminus" data-pid="${p.id}" type="button">-1</button>
        <button class="btn smallBtn btnOK" data-act="plus" data-pid="${p.id}" type="button">+ Ä°ÅŸlem</button>
        <button class="btn smallBtn btnBAD" data-act="minus" data-pid="${p.id}" type="button">- Ä°ÅŸlem</button>
        
        <!-- V14 fast ops -->
        <button class="btn smallBtn btnOK" data-act="aPlus1" data-pid="${p.id}" type="button">+1</button>
        <button class="btn smallBtn btnBAD" data-act="aMinus1" data-pid="${p.id}" type="button">-1</button>
        ${p.packDefault ? `
          <button class="btn smallBtn btnOK" data-act="kPlus1" data-pid="${p.id}" type="button">+1 koli</button>
          <button class="btn smallBtn btnBAD" data-act="kMinus1" data-pid="${p.id}" type="button">-1 koli</button>
          <span class="tag">koli iÃ§i: <b>${p.packDefault}</b></span>
        ` : ``}
<button class="btn smallBtn" data-act="hist" data-pid="${p.id}" type="button">GeÃ§miÅŸ</button>
      </div>
      <div class="list" id="hist_${p.id}" style="display:none;margin-top:10px"></div>
    `;
    list.appendChild(el);
  }

  // Ã¼rÃ¼n kart aksiyonlarÄ±
  list.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act=btn.getAttribute("data-act");
      const pid=btn.getAttribute("data-pid");
      if(act==="hist"){ toggleHistory(pid); return; }
      if(act==="qplus"){ quickOp(pid, "+", 1); return; }
      if(act==="qminus"){ quickOp(pid, "-", 1); return; }
      
      // V14 fast ops
      if(act==="aPlus1"){ fastOp(pid, "+", "adet", 1, 0, 0); return; }
      if(act==="aMinus1"){ fastOp(pid, "-", "adet", 1, 0, 0); return; }

      if(act==="kPlus1"){
        const db=loadDB();
        const prod=(db.products||[]).find(x=>x.id===pid);
        const ps = prod && prod.packDefault ? Number(prod.packDefault) : 0;
        if(!ps){ alert("Bu Ã¼rÃ¼nde koli iÃ§i adet yok. Koli modunda bir kez gir ki Ã¶ÄŸrensin."); return; }
        fastOp(pid, "+", "koli", ps, 1, ps);
        return;
      }
      if(act==="kMinus1"){
        const db=loadDB();
        const prod=(db.products||[]).find(x=>x.id===pid);
        const ps = prod && prod.packDefault ? Number(prod.packDefault) : 0;
        if(!ps){ alert("Bu Ã¼rÃ¼nde koli iÃ§i adet yok. Koli modunda bir kez gir ki Ã¶ÄŸrensin."); return; }
        fastOp(pid, "-", "koli", ps, 1, ps);
        return;
      }

openModal(pid, act==="plus" ? "+" : "-");
    });
  });

  fillProdSelect();
  reportToday();
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ====== HISTORY (ÃœrÃ¼n bazlÄ± detay) ====== */
function toggleHistory(pid){
  const db=loadDB();
  const box=$("hist_"+pid);
  if(!box) return;
  const visible = box.style.display!=="none";
  if(visible){ box.style.display="none"; return; }
  box.style.display="block";

  const ops = db.ops.filter(o=>o.pid===pid).sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,60);
  if(!ops.length){
    box.innerHTML = `<div class="item"><div class="hint">Bu Ã¼rÃ¼nde iÅŸlem yok.</div></div>`;
    return;
  }
  box.innerHTML = ops.map(o=>{
    const dt=new Date(o.ts||Date.now()).toLocaleString("tr-TR");
    const sign = o.dir==="+" ? "+" : "-";
    return `
      <div class="item" style="background:rgba(255,255,255,.02)">
        <div class="row" style="justify-content:space-between">
          <div class="name">${sign}${o.qty} â€¢ ${escapeHTML(o.typeLabel||o.type||"")}</div>
          <div class="row" style="gap:8px;align-items:center">
            <div class="tag">${escapeHTML(dt)}</div>
            <button class="btn btnMini btnDel" type="button" data-del="${o.id}" data-pid="${o.pid}">Sil</button>
          </div>
        </div>
        <div class="muted">${escapeHTML(o.sub||"")} ${o.note?(" â€¢ "+escapeHTML(o.note)):""}</div>
      </div>
    `;
  }).join("");

    // V15: Sil butonlarÄ±
    box.querySelectorAll("button[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const opId = b.getAttribute("data-del");
        const pid2 = b.getAttribute("data-pid");
        if(!opId) return;
        if(confirm("Bu iÅŸlemi silmek istiyor musun?")){
          deleteOp(opId, pid2);
        }
      });
    });
}

/* ====== MODAL ====== */
function fillProdSelect(){
  const db=loadDB();
  const sel=$("opProd");
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML="";
  for(const p of db.products){
    const net=computeStock(db,p.id);
    const opt=document.createElement("option");
    opt.value=p.id;
    opt.textContent=`${p.name}  (net:${net})`;
    sel.appendChild(opt);
  }
  if(cur && [...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

function fillTypeSelect(dirHint){
  const tSel=$("opType");
  tSel.innerHTML="";
  for(const t of TYPE_DEF){
    // dirHint varsa filtrele (kart Ã¼zerindeki + / -)
    if(dirHint && t.dir!==dirHint) continue;
    const opt=document.createElement("option");
    opt.value=t.k;
    opt.textContent=t.label;
    tSel.appendChild(opt);
  }
  // default ilk
  tSel.selectedIndex=0;
  fillSubSelect();
  buildQuickRow();
}

function fillSubSelect(){
  const tSel=$("opType");
  const sSel=$("opSub");
  const t=TYPE_DEF.find(x=>x.k===tSel.value);
  sSel.innerHTML="";
  // opsiyonel: boÅŸ seÃ§enek (hÄ±z iÃ§in)
  const none=document.createElement("option");
  none.value="";
  none.textContent="Alt kÄ±rÄ±lÄ±m (opsiyonel)";
  sSel.appendChild(none);

  if(t && Array.isArray(t.subs)){
    for(const sub of t.subs){
      const opt=document.createElement("option");
      opt.value=sub;
      opt.textContent=sub;
      sSel.appendChild(opt);
    }
  }
  sSel.selectedIndex=0;
}

function buildQuickRow(){
  const wrap=$("quickRow");
  wrap.innerHTML="";
  const tSel=$("opType");
  const t=TYPE_DEF.find(x=>x.k===tSel.value);
  if(!t) return;

  // hÄ±zlÄ± alt kÄ±rÄ±lÄ±m chip'leri (tek dokunuÅŸ)
  const arr=(t.subs||[]).slice(0,6);
  for(const sub of arr){
    const b=document.createElement("button");
    b.className="btn smallBtn";
    b.type="button";
    b.textContent=sub.split("â€¢")[0].trim();
    b.title=sub;
    b.addEventListener("click", ()=>{
      $("opSub").value=sub;
    });
    wrap.appendChild(b);
  }
}

/* QUICK_QTY_V1 */
function buildQuickQtyRow(){
  const wrap = $("quickQtyRow");
  if(!wrap) return;
  wrap.innerHTML="";

  const presets = [1,2,3,5,6,10,12,15,20];

  for(const n of presets){
    const b=document.createElement("button");
    b.type="button";
    b.className="btn smallBtn";
    b.textContent = String(n);
    b.title = "Adet = " + n;
    b.addEventListener("click", ()=>{
      $("opQty").value = String(n);
      try{$("opQty").focus({preventScroll:true});}catch(e){}
    });
    wrap.appendChild(b);
  }

  // kÃ¼Ã§Ã¼k dÃ¼zeltme: -1 / +1
  const bMinus=document.createElement("button");
  bMinus.type="button";
  bMinus.className="btn smallBtn btnBAD";
  bMinus.textContent="-1";
  bMinus.title="Adet -1";
  bMinus.addEventListener("click", ()=>{
    const cur = parseInt(($("opQty").value||"0").trim(),10) || 0;
    const next = Math.max(0, cur-1);
    $("opQty").value = String(next);
    try{$("opQty").focus({preventScroll:true});}catch(e){}
  });
  wrap.appendChild(bMinus);

  const bPlus=document.createElement("button");
  bPlus.type="button";
  bPlus.className="btn smallBtn btnOK";
  bPlus.textContent="+1";
  bPlus.title="Adet +1";
  bPlus.addEventListener("click", ()=>{
    const cur = parseInt(($("opQty").value||"0").trim(),10) || 0;
    $("opQty").value = String(cur+1);
    try{$("opQty").focus({preventScroll:true});}catch(e){}
  });
  wrap.appendChild(bPlus);
}



/* FAST_OPS_V1 */
function showToast(msg){
  let t=document.getElementById("toastBox");
  if(!t){
    t=document.createElement("div");
    t.id="toastBox";
    t.style.position="fixed";
    t.style.left="50%";
    t.style.bottom="72px";
    t.style.transform="translateX(-50%)";
    t.style.background="rgba(2,6,23,.92)";
    t.style.border="1px solid rgba(255,255,255,.12)";
    t.style.color="#e5e7eb";
    t.style.padding="10px 12px";
    t.style.borderRadius="14px";
    t.style.fontSize="12px";
    t.style.zIndex="99998";
    t.style.display="none";
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(window.__toastT);
  window.__toastT=setTimeout(()=>{ t.style.display="none"; }, 1200);
}

function buildQtyRow(){
  const wrap=$("qtyRow");
  if(!wrap) return;
  wrap.innerHTML="";
  const nums=[1,2,3,5,10];
  for(const n of nums){
    const b=document.createElement("button");
    b.className="btn smallBtn";
    b.type="button";
    b.textContent=String(n);
    b.addEventListener("click", ()=>{
      $("opQty").value=String(n);
      try{ $("opQty").focus({preventScroll:true}); }catch(e){}
    });
    wrap.appendChild(b);
  }
  // Enter = kaydet (modal iÃ§indeyken)
  const q=$("opQty");
  if(q && !q.__fastBound){
    q.__fastBound=true;
    q.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); addOp(); }
    });
  }
}

// modal her aÃ§Ä±ldÄ±ÄŸÄ±nda qty row hazÄ±r olsun
const __openModal0 = openModal;
openModal = function(pid, dirHint){
  __openModal0(pid, dirHint);
  buildQtyRow();
};

// Kart Ã¼stÃ¼ +1 / -1 hÄ±zlÄ± iÅŸlem
function quickOp(pid, dir, qty){
  const db=loadDB();
  const lc = (db.meta && db.meta.lastChoice) ? db.meta.lastChoice[dir] : null;

  // Ä°lk kezse: kullanÄ±cÄ±ya modal aÃ§tÄ±rÄ±p â€œÅŸablonu Ã¶ÄŸretâ€
  if(!lc || !lc.typeKey){
    showToast("Ä°lk kez: tÃ¼r seÃ§elim");
    openModal(pid, dir);
    return;
  }

  const t=TYPE_DEF.find(x=>x.k===lc.typeKey && x.dir===dir);
  if(!t){
    showToast("Åablon yok: tÃ¼r seÃ§elim");
    openModal(pid, dir);
    return;
  }

  db.ops.push({
    id:uid(),
    pid,
    dir:t.dir,
    type:t.k,
    typeLabel:t.label,
    sub:(lc.sub||""),
    note:"",
    qty:qty,
    unitMode: OP_MODE,
    packCount: packCount,
    packSize: packSize,
    ts:Date.now(),
    day: todayISO()
  });
  
  rememberUndo(db);
saveDB(db);
  renderProducts();
  showToast((dir==="+"?"+":"-")+qty+" kaydedildi");
}


function openModal(pid, dirHint){
  $("modal").style.display="block";
  fillProdSelect();
  if(pid) $("opProd").value=pid;
  fillTypeSelect(dirHint);
  try{ buildQuickQtyRow(); }catch(e){}

  // MODAL_ONEHAND_V1: son seÃ§imleri geri yÃ¼kle
  try{
    const db=loadDB();
    const lc = (db.meta && db.meta.lastChoice) ? db.meta.lastChoice[dirHint] : null;

    // pid yoksa son Ã¼rÃ¼nÃ¼ seÃ§
    if(!pid && db.meta && db.meta.lastPid){
      const lp = db.meta.lastPid;
      if($("opProd") && [...$("opProd").options].some(o=>o.value===lp)) $("opProd").value = lp;
    }

    // tÃ¼r/sub otomatik (dirHint'e gÃ¶re)
    if(lc && lc.typeKey){
      if($("opType") && [...$("opType").options].some(o=>o.value===lc.typeKey)){
        $("opType").value = lc.typeKey;
        fillSubSelect();
        if(lc.sub) $("opSub").value = lc.sub;
        buildQuickRow();
      }
    }
  }catch(e){}

  // MODAL_ONEHAND_V1: hÄ±zlÄ± tÃ¼r butonlarÄ±
  try{
    const row=$("fastTypeRow");
    if(row){
      row.innerHTML="";
      const dir=dirHint; // "+" veya "-"
      const list = TYPE_DEF.filter(t=>!dir || t.dir===dir);
      for(const t of list){
        const b=document.createElement("button");
        b.type="button";
        b.className="btn smallBtn " + (t.dir==="+" ? "btnOK" : "btnBAD");
        // kÄ±sa isim:
        const short = t.label.replace(" (+)","").replace(" (-)","").trim();
        b.textContent = (t.dir==="+"?"+ ":"- ") + short;
        b.addEventListener("click", ()=>{
          $("opType").value = t.k;
          fillSubSelect();
          buildQuickRow();
        });
        row.appendChild(b);
      }
    }
  }catch(e){}


  $("opQty").value="";
  if($("opPackCount")) $("opPackCount").value="";
  if($("opPackSize")) $("opPackSize").value="";
  $("opNote").value="";
  try{ setMode("adet"); }catch(e){}
  // flicker Ã¶ldÃ¼rmek iÃ§in agresif autofocus yok:
  setTimeout(()=>{ try{$("opQty").focus({preventScroll:true});}catch(e){} }, 60);
}

function closeModal(){
  $("modal").style.display="none";
}

function addProduct(){
  const name=($("inProd").value||"").trim();
  if(!name){ alert("ÃœrÃ¼n adÄ± yaz."); return; }
  const db=loadDB();
  db.products.push({id:uid(), name, ts:Date.now()});
  saveDB(db);
  $("inProd").value="";
  renderProducts();
  try{$("inProd").focus({preventScroll:true});}catch(e){}
}

function addOp(){
  const pid=$("opProd").value;
  let qty = 0;
  let packCount = 0;
  let packSize = 0;

  if(OP_MODE==="adet"){
    qty = Math.abs(parseInt(($("opQty").value||"").trim(),10))||0;
  }else{
    packCount = Math.abs(parseInt(($("opPackCount").value||"").trim(),10))||0;
    packSize  = Math.abs(parseInt(($("opPackSize").value||"").trim(),10))||0;
    qty = packCount * packSize;
    if(packSize>0) learnPackDefaultToProduct(packSize);
  }
  if(!pid){ alert("ÃœrÃ¼n seÃ§."); return; }
  if(!qty){
    if(OP_MODE==="adet"){
      alert("Adet gir (Ã¶rn 3).");
      $("opQty").focus();
    }else{
      alert("Koli sayÄ±sÄ± ve koli iÃ§i adet gir (Ã¶rn 2 koli Ã— 12).");
      try{$("opPackCount").focus();}catch(e){}
    }
    return;
  }

  const tKey=$("opType").value;
  const t=TYPE_DEF.find(x=>x.k===tKey);
  if(!t){ alert("TÃ¼r seÃ§."); return; }

  const db=loadDB();
  const sub=($("opSub").value||"").trim();
  const note=($("opNote").value||"").trim();

  db.ops.push({
    id:uid(),
    pid,
    dir:t.dir,
    type:t.k,
    typeLabel:t.label,
    sub:sub,
    note:note,
    qty:qty,
    unitMode: OP_MODE,
    packCount: packCount,
    packSize: packSize,
    ts:Date.now(),
    day: todayISO()
  });
  
  
  rememberUndo(db);
// FAST_OPS_V1: son seÃ§im (dir/type/sub) hafÄ±zasÄ±
  try{
    if(!db.meta) db.meta={v:1};
    if(!db.meta.lastChoice) db.meta.lastChoice={};
    const dir = t.dir; // "+" / "-"
    db.meta.lastChoice[dir] = { typeKey: t.k, sub: sub || "" };
  }catch(e){}

  // MODAL_ONEHAND_V1: son Ã¼rÃ¼n (pid) hafÄ±zasÄ±
  try{
    if(!db.meta) db.meta={v:1};
    db.meta.lastPid = pid;
  }catch(e){}

saveDB(db);
  closeModal();
  renderProducts();
}

/* ====== REPORT / ANALYTICS ====== */
function opsInDays(db, days){
  const now = new Date();
  const from = new Date(now.getTime() - days*24*3600*1000);
  return db.ops.filter(o=>{
    const d = new Date(o.ts||0);
    return d>=from;
  });
}
function reportForDays(days){
  const db=loadDB();
  const ops=opsInDays(db, days);
  let plus=0, minus=0;
  for(const o of ops){
    const q=Number(o.qty||0);
    if(o.dir==="+") plus+=q; else minus+=q;
  }
  $("rPlus").textContent=String(plus);
  $("rMinus").textContent=String(minus);
  $("rNet").textContent=String(plus - minus);

  // Top Ã¼rÃ¼nler
  const m=new Map();
  for(const o of ops){
    const p=db.products.find(x=>x.id===o.pid);
    if(!p) continue;
    const key=p.id;
    const cur=m.get(key)||{name:p.name, score:0, plus:0, minus:0};
    if(o.dir==="+"){cur.plus+=Number(o.qty||0)}else{cur.minus+=Number(o.qty||0)}
    cur.score += Number(o.qty||0);
    m.set(key,cur);
  }
  const top=[...m.values()].sort((a,b)=>(b.plus+b.minus)-(a.plus+a.minus)).slice(0,8);
  $("rTop").innerHTML = top.length ? top.map(x=>`
    <div class="item">
      <div class="row" style="justify-content:space-between">
        <div class="name">${escapeHTML(x.name)}</div>
        <div class="tag">net ${x.plus-x.minus}</div>
      </div>
      <div class="muted">+${x.plus} / -${x.minus}</div>
    </div>
  `).join("") : `<div class="item"><div class="hint">Bu aralÄ±kta veri yok.</div></div>`;

  // TÃ¼r daÄŸÄ±lÄ±mÄ±
  const tm=new Map();
  for(const o of ops){
    const k=o.typeLabel||o.type||"";
    tm.set(k, (tm.get(k)||0) + Number(o.qty||0));
  }
  const trows=[...tm.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
  $("rTypes").innerHTML = trows.length ? trows.map(([k,v])=>`
    <div class="item">
      <div class="row" style="justify-content:space-between">
        <div class="name">${escapeHTML(k)}</div>
        <div class="tag">${v}</div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="hint">TÃ¼r verisi yok.</div></div>`;

  // â€œAkÄ±lâ€ (basit, donmayan)
  const brain=[];
  if(ops.length===0) brain.push("Veri yok: Ã¶nce iÅŸlem gir.");
  if(minus>plus) brain.push("ğŸŸ¥ Eksilme artÄ±dan fazla: satÄ±ÅŸ/skt/iade baskÄ±n.");
  if(plus>0 && minus===0) brain.push("ğŸŸ§ Sadece artÄ±ÅŸ var: daÄŸÄ±lÄ±m/sipariÅŸ girilmiÅŸ, satÄ±ÅŸ yok.");
  if(plus-minus<0) brain.push("ğŸŸ¥ Net negatif: stok aÃ§Ä±ÄŸÄ±/yanlÄ±ÅŸ kayÄ±t ihtimali.");
  if(brain.length===0) brain.push("ğŸŸ© Stabil: kritik sinyal yok.");
  $("rBrain").innerHTML = brain.map(t=>`<div class="item"><div class="name">${escapeHTML(t)}</div></div>`).join("");
}

/* V16_REPORT_DETAIL_STOCK_CSV */
let REPORT_LAST_DAYS = 1;

function fmtInt(n){
  try{ return String(Math.trunc(Number(n)||0)); }catch(e){ return "0"; }
}

function typeLabelByKey(k){
  const t = (typeof TYPE_DEF!=="undefined") ? TYPE_DEF.find(x=>x.k===k) : null;
  return t ? (t.label || k) : k;
}

function computeTypeTotals(db, ops){
  // tÃ¼r bazlÄ± + / - ve net
  const out = new Map(); // typeKey -> {label, dirPlus, dirMinus}
  for(const o of ops){
    const k = o.type || "";
    if(!k) continue;
    const cur = out.get(k) || {label: (o.typeLabel||typeLabelByKey(k)||k), plus:0, minus:0};
    const q = Number(o.qty||0);
    if(o.dir==="+") cur.plus += q; else cur.minus += q;
    out.set(k, cur);
  }
  return [...out.entries()].map(([k,v])=>({k, ...v, net:(v.plus-v.minus)}))
    .sort((a,b)=> (Math.abs(b.plus)+Math.abs(b.minus)) - (Math.abs(a.plus)+Math.abs(a.minus)));
}

function computeSubTotals(db, ops){
  // alt kÄ±rÄ±lÄ±m: typeLabel + sub
  const out = new Map(); // key -> qty
  for(const o of ops){
    const t = (o.typeLabel||typeLabelByKey(o.type)||o.type||"TÃ¼r");
    const sub = (o.sub||"").trim() || "Alt yok";
    const key = t + " :: " + sub;
    out.set(key, (out.get(key)||0) + Number(o.qty||0));
  }
  return [...out.entries()].map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
}

function renderTypeTotals(rows){
  const box = $("rTypeTotals");
  if(!box) return;
  if(!rows.length){
    box.innerHTML = `<div class="miniLine"><div class="hint">Detay veri yok.</div></div>`;
    return;
  }
  box.innerHTML = rows.slice(0,12).map(r=>`
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">${escapeHTML(r.label||r.k)}</div>
        <div class="badge">net <b>${fmtInt(r.net)}</b></div>
      </div>
      <div class="rTiny">+${fmtInt(r.plus)} / -${fmtInt(r.minus)}</div>
    </div>
  `).join("");
}

function renderSubTotals(rows){
  const box = $("rSubTotals");
  if(!box) return;
  if(!rows.length){
    box.innerHTML = `<div class="miniLine"><div class="hint">Alt kÄ±rÄ±lÄ±m veri yok.</div></div>`;
    return;
  }
  box.innerHTML = rows.slice(0,18).map(r=>{
    const parts = String(r.k).split(" :: ");
    const t = parts[0] || "TÃ¼r";
    const sub = parts.slice(1).join(" :: ") || "Alt yok";
    return `
      <div class="miniLine">
        <div class="rRow">
          <div style="flex:1">
            <div class="rKey">${escapeHTML(sub)}</div>
            <div class="rTiny">${escapeHTML(t)}</div>
          </div>
          <div class="badge"><b>${fmtInt(r.v)}</b></div>
        </div>
      </div>
    `;
  }).join("");
}

function renderStockNow(){
  const box = $("rStockNow");
  if(!box) return;

  const db = loadDB();
  const arr = (db.products||[]).map(p=>{
    const net = computeStock(db, p.id);
    return {name:p.name||"", id:p.id, net};
  }).sort((a,b)=> b.net - a.net);

  if(!arr.length){
    box.innerHTML = `<div class="miniLine"><div class="hint">ÃœrÃ¼n yok.</div></div>`;
    return;
  }

  box.innerHTML = arr.slice(0,25).map(x=>`
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">${escapeHTML(x.name)}</div>
        <div class="badge">stok <b>${fmtInt(x.net)}</b></div>
      </div>
      <div class="rTiny">ID: ${escapeHTML(String(x.id||"").slice(0,8))}</div>
    </div>
  `).join("");
}

function exportOpsCSV(days){
  const db = loadDB();
  const ops = opsInDays(db, days).sort((a,b)=>(b.ts||0)-(a.ts||0));

  const header = ["ts","date","product","dir","type","sub","qty","unitMode","packCount","packSize","note"];
  const lines = [header.join(",")];

  const pmap = new Map((db.products||[]).map(p=>[p.id, p.name||""]));

  function esc(v){
    const s = String(v??"").replace(/"/g,'""');
    return `"${s}"`;
  }

  for(const o of ops){
    const dt = new Date(o.ts||0);
    const row = [
      dt.toISOString(),
      (o.day||dt.toISOString().slice(0,10)),
      (pmap.get(o.pid)||""),
      (o.dir||""),
      (o.typeLabel||o.type||""),
      (o.sub||""),
      (o.qty||0),
      (o.unitMode||""),
      (o.packCount||0),
      (o.packSize||0),
      (o.note||""),
    ].map(esc);
    lines.push(row.join(","));
  }

  const csv = lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `stok_kontrol_ops_${days}g_${todayISO()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(e){} }, 2000);
}

// reportForDays'e â€œdetay renderâ€ hook
const _reportForDays_V16 = reportForDays;
reportForDays = function(days){
  REPORT_LAST_DAYS = days;
  _reportForDays_V16(days);
  const db = loadDB();
  const ops = opsInDays(db, days);
  renderTypeTotals(computeTypeTotals(db, ops));
  renderSubTotals(computeSubTotals(db, ops));
  renderStockNow();
};

document.addEventListener("DOMContentLoaded", ()=>{
  if($("btnCSV")){
    $("btnCSV").onclick = ()=> exportOpsCSV(REPORT_LAST_DAYS || 1);
  }
});


function reportToday(){ reportForDays(1); }

/* ====== ERROR GUARD ====== */
(function(){
  function showError(msg){
    const box=$("errorGuardBox");
    const txt=$("errorGuardText");
    if(!box||!txt) return;
    box.style.display="block";
    txt.textContent=msg;
  }
  window.addEventListener("error", e=> showError((e.message||"Hata") + " @ " + (e.filename||"") + ":" + (e.lineno||"")));
  window.addEventListener("unhandledrejection", e=> showError("Promise Error: " + (e.reason?.message || e.reason)));
})();

/* ====== EVENTS ====== */
$("btnAddProd").onclick=addProduct;
$("inProd").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addProduct(); }});
$("btnAddOp").onclick=()=>openModal(null,null);
$("btnClose").onclick=closeModal;
$("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal(); });

$("opType").addEventListener("change", ()=>{ fillSubSelect(); buildQuickRow(); });
$("btnSaveOp").onclick=addOp;

$("btnClearSearch").onclick=()=>{ $("inSearch").value=""; renderProducts(); };
$("inSearch").addEventListener("input", ()=>renderProducts());

$("btnReportToday").onclick=()=>reportToday();
$("btnReport7").onclick=()=>reportForDays(7);
$("btnReport30").onclick=()=>reportForDays(30);

// Skor test (debug): kritik deÄŸilse â€œ0â€ gibi davranÄ±r â†’ burada basit Ã§Ä±ktÄ± gÃ¶steriyoruz
$("btnSkorTest").onclick=()=>{
  const db=loadDB();
  if(!db.products.length){ alert("Ã–nce Ã¼rÃ¼n ekle."); return; }
  const pid=db.products[0].id;
  const net=computeStock(db,pid);
  alert("Skor Test âœ…\n\nÄ°lk Ã¼rÃ¼n: "+db.products[0].name+"\nNet: "+net+"\n\nNot: Skor sistemi kritik sinyal yoksa 'stabil' sayar.");
};

(function boot(){
  $("chipMeta").textContent = "LocalStorage â€¢ " + KEY;
  renderProducts();
  reportToday();
  // agresif autofocus yok: flicker riskini azaltÄ±r
})();

/* V12_BINDINGS */
document.addEventListener("DOMContentLoaded", ()=>{
    if($("btnUndo")) $("btnUndo").onclick = undoLast;
if($("btnModeAdet")) $("btnModeAdet").onclick = ()=> setMode("adet");
  if($("btnModeKoli")) $("btnModeKoli").onclick = ()=> setMode("koli");

  if($("opPackCount")) $("opPackCount").addEventListener("input", updatePackTotal);
  if($("opPackSize"))  $("opPackSize").addEventListener("input", updatePackTotal);

  if($("opProd")) $("opProd").addEventListener("change", ()=>{
    if(OP_MODE==="koli") syncPackDefaultsFromProduct();
    updatePackTotal();
  });

  // aÃ§Ä±lÄ±ÅŸta adet modu
  try{ setMode("adet"); }catch(e){}
});



/* V18_SINGLE_EXPORT_ALERTS */
let REPORT_DAYS = 1;

function fmtInt(n){ try{return String(Math.trunc(Number(n)||0));}catch(e){return "0";} }

function csvEsc(v){
  const s = String(v==null? "" : v);
  if(/[,"\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}

function exportCSV(){
  const db = loadDB();
  const ops = opsInDays(db, REPORT_DAYS);

  const headerOps = ["ts","day","product","dir","type","sub","qty","unitMode","packCount","packSize","note"];
  const rowsOps = [headerOps.join(",")];

  for(const o of ops){
    const prod = (db.products||[]).find(p=>p.id===o.pid);
    const name = prod ? prod.name : ("#"+String(o.pid||"").slice(0,8));
    const ts = new Date(o.ts||Date.now()).toISOString();
    const day = o.day || ts.slice(0,10);
    rowsOps.push([
      csvEsc(ts),
      csvEsc(day),
      csvEsc(name),
      csvEsc(o.dir||""),
      csvEsc(o.typeLabel||o.type||""),
      csvEsc(o.sub||""),
      csvEsc(o.qty||0),
      csvEsc(o.unitMode||""),
      csvEsc(o.packCount||0),
      csvEsc(o.packSize||0),
      csvEsc(o.note||"")
    ].join(","));
  }

  // stok snapshot
  const headerP = ["product","net","packDefault"];
  const rowsP = [headerP.join(",")];
  for(const p of (db.products||[])){
    const net = computeStock(db, p.id);
    rowsP.push([csvEsc(p.name||""), csvEsc(net), csvEsc(p.packDefault||"")].join(","));
  }

  const stamp = new Date().toISOString().replace(/[:.]/g,"-");
  downloadText("stok_kontrol_ops_"+REPORT_DAYS+"g_"+stamp+".csv", rowsOps.join("\n"));
  downloadText("stok_kontrol_stok_"+stamp+".csv", rowsP.join("\n"));
}

function exportPDFPrint(){
  // PDF iÃ§in en stabil yol: tarayÄ±cÄ± yazdÄ±r (Firefox/Chrome -> PDF kaydet)
  document.body.classList.add("single"); // Ã§Ä±ktÄ±da tek sayfa dÃ¼zeni
  setTimeout(()=>window.print(), 60);
}

function setSingleMode(on){
  if(on) document.body.classList.add("single");
  else document.body.classList.remove("single");
  try{
    localStorage.setItem("stok_kontrol_single_mode", on ? "1" : "0");
  }catch(e){}
}

function initSingleMode(){
  try{
    const v = localStorage.getItem("stok_kontrol_single_mode");
    setSingleMode(v==="1");
  }catch(e){}
}

function computeAlerts(db, ops, days){
  const alerts=[];

  // 1) Net stok negatif olan Ã¼rÃ¼nler (tÃ¼mÃ¼)
  for(const p of (db.products||[])){
    const net = computeStock(db, p.id);
    if(net < 0){
      alerts.push({lvl:"red", text:`ğŸŸ¥ Stok aÃ§Ä±ÄŸÄ±: ${p.name} (net ${net})`});
    }
  }

  // 2) Insert dÃ¶nÃ¼ÅŸÃ¼m dÃ¼ÅŸÃ¼k (seÃ§ili aralÄ±k)
  const insD = ops.filter(o=>o.type==="dagilim" && String(o.sub||"").toLowerCase().includes("insert"));
  const insS = ops.filter(o=>o.type==="satis"   && String(o.sub||"").toLowerCase().includes("insert"));
  const dTot = insD.reduce((a,o)=>a+Number(o.qty||0),0);
  const sTot = insS.reduce((a,o)=>a+Number(o.qty||0),0);
  if(dTot>0){
    const ratio = sTot/dTot;
    if(ratio < 0.35) alerts.push({lvl:"red", text:`ğŸŸ¥ Insert zayÄ±f: dÃ¶nÃ¼ÅŸÃ¼m %${Math.round(ratio*100)} (daÄŸÄ±lÄ±m ${dTot} / satÄ±ÅŸ ${sTot})`});
    else if(ratio < 0.60) alerts.push({lvl:"amber", text:`ğŸŸ§ Insert orta: dÃ¶nÃ¼ÅŸÃ¼m %${Math.round(ratio*100)} (daÄŸÄ±lÄ±m ${dTot} / satÄ±ÅŸ ${sTot})`});
  }

  // 3) Ä°ade yÃ¼ksek (seÃ§ili aralÄ±k) â€” satÄ±ÅŸa oranla kaba sinyal
  const ret = ops.filter(o=>o.type==="iade").reduce((a,o)=>a+Number(o.qty||0),0);
  const sal = ops.filter(o=>o.type==="satis").reduce((a,o)=>a+Number(o.qty||0),0);
  if(ret>0 && sal>0){
    const r = ret/sal;
    if(r >= 0.20) alerts.push({lvl:"red", text:`ğŸŸ¥ Ä°ade oranÄ± yÃ¼ksek: %${Math.round(r*100)} (iade ${ret} / satÄ±ÅŸ ${sal})`});
    else if(r >= 0.10) alerts.push({lvl:"amber", text:`ğŸŸ§ Ä°ade dikkat: %${Math.round(r*100)} (iade ${ret} / satÄ±ÅŸ ${sal})`});
  }else if(ret>0 && sal==0){
    alerts.push({lvl:"amber", text:`ğŸŸ§ Ä°ade var ama satÄ±ÅŸ yok (iade ${ret}). KayÄ±t/akÄ±ÅŸ kontrol.`});
  }

  // 4) Sadece artÄ±ÅŸ var (daÄŸÄ±lÄ±m/sipariÅŸ) ama satÄ±ÅŸ yok
  const plus = ops.filter(o=>o.dir==="+").reduce((a,o)=>a+Number(o.qty||0),0);
  const minus= ops.filter(o=>o.dir==="-").reduce((a,o)=>a+Number(o.qty||0),0);
  if(plus>0 && minus==0) alerts.push({lvl:"amber", text:`ğŸŸ§ Sadece artÄ±ÅŸ var (sipariÅŸ/daÄŸÄ±lÄ±m). SatÄ±ÅŸ kaydÄ± yok.`});

  // 5) Her ÅŸey sakin
  if(alerts.length==0) alerts.push({lvl:"green", text:"ğŸŸ© Kritik alarm yok (ÅŸimdilik)."});
  return alerts.slice(0,10);
}

function renderAlerts(db, ops, days){
  const box = $("rAlerts");
  if(!box) return;
  const arr = computeAlerts(db, ops, days);

  box.innerHTML = arr.map(a=>{
    const cls = a.lvl==="red" ? "alertRed" : (a.lvl==="amber" ? "alertAmber" : "alertGreen");
    return `<div class="miniLine ${cls}"><div class="rRow"><div class="rKey">${escapeHTML(a.text)}</div></div></div>`;
  }).join("");
}

// reportForDays hook: gÃ¼n etiketi + alarm render
const _reportForDays_V18 = reportForDays;
reportForDays = function(days){
  REPORT_DAYS = Number(days)||1;
  _reportForDays_V18(days);

  const lbl = $("rDaysLbl");
  if(lbl) lbl.textContent = String(REPORT_DAYS);

  const db = loadDB();
  const ops = opsInDays(db, REPORT_DAYS);
  renderAlerts(db, ops, REPORT_DAYS);
};

// UI baÄŸlama
document.addEventListener("DOMContentLoaded", ()=>{
  initSingleMode();

  const btn = $("btnSingle");
  if(btn){
    btn.addEventListener("click", ()=>{
      const on = !document.body.classList.contains("single");
      setSingleMode(on);
      btn.textContent = on ? "Ã‡ift Kolon" : "Tek Ekran";
    });
    // ilk yazÄ±
    btn.textContent = document.body.classList.contains("single") ? "Ã‡ift Kolon" : "Tek Ekran";
  }

  if($("btnExportCSV")) $("btnExportCSV").addEventListener("click", exportCSV);
  if($("btnExportPDF")) $("btnExportPDF").addEventListener("click", exportPDFPrint);

  // sayfa aÃ§Ä±lÄ±r aÃ§Ä±lmaz: alarm + gÃ¼n etiketi doÄŸru olsun
  try{ const db=loadDB(); const ops=opsInDays(db, REPORT_DAYS); renderAlerts(db, ops, REPORT_DAYS); }catch(e){}
});


/* V19_MANAGER_REPORTS_SAFE */

function renderManagerPanels(days){
  const db = loadDB();
  const ops = opsInDays(db, days);

  const salesBox = $("rSalesProducts");
  const insertBox = $("rInsertPerf");
  const returnBox = $("rReturnReasons");

  if(salesBox){
    const map = {};
    ops.forEach(o=>{
      if(o.type==="satis"){
        map[o.pid] = (map[o.pid]||0) + Number(o.qty||0);
      }
    });

    const rows = Object.entries(map)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,10)
      .map(([pid,qty])=>{
        const p = (db.products||[]).find(x=>x.id===pid);
        const name = p ? p.name : pid;
        return "<div>"+name+" â†’ <b>"+qty+"</b></div>";
      }).join("");

    salesBox.innerHTML = rows || "<div class='hint'>SatÄ±ÅŸ yok</div>";
  }

  if(insertBox){
    const map = {};
    ops.forEach(o=>{
      if(o.type==="dagilim" && String(o.sub||"").toLowerCase().includes("insert")){
        map[o.pid] = map[o.pid] || {d:0,s:0};
        map[o.pid].d += Number(o.qty||0);
      }
      if(o.type==="satis" && String(o.sub||"").toLowerCase().includes("insert")){
        map[o.pid] = map[o.pid] || {d:0,s:0};
        map[o.pid].s += Number(o.qty||0);
      }
    });

    const rows = Object.entries(map)
      .map(([pid,obj])=>{
        const p = (db.products||[]).find(x=>x.id===pid);
        const name = p ? p.name : pid;
        const ratio = obj.d>0 ? Math.round((obj.s/obj.d)*100) : 0;
        return "<div>"+name+" â†’ %"+ratio+" ("+obj.s+"/"+obj.d+")</div>";
      }).join("");

    insertBox.innerHTML = rows || "<div class='hint'>Insert verisi yok</div>";
  }

  if(returnBox){
    const map = {};
    ops.forEach(o=>{
      if(o.type==="iade"){
        const sub = o.sub || "DiÄŸer";
        map[sub] = (map[sub]||0) + Number(o.qty||0);
      }
    });

    const rows = Object.entries(map)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,10)
      .map(([sub,qty])=>{
        return "<div>"+sub+" â†’ <b>"+qty+"</b></div>";
      }).join("");

    returnBox.innerHTML = rows || "<div class='hint'>Ä°ade yok</div>";
  }
}

const _reportForDays_V19_SAFE = reportForDays;
reportForDays = function(days){
  _reportForDays_V19_SAFE(days);
  try{ renderManagerPanels(days); }catch(e){}
};

document.addEventListener("DOMContentLoaded", ()=>{
  try{ renderManagerPanels(1); }catch(e){}
});



/* V20_FORECAST_ENGINE */

function getLastNDaysOps(db, pid, n){
  const now = new Date();
  const arr=[];
  for(let i=0;i<n;i++){
    const d = new Date(now.getTime()-i*24*3600*1000);
    const key = d.toISOString().slice(0,10);
    const total = db.ops
      .filter(o=>o.pid===pid && o.type==="satis")
      .filter(o=>{
        const day = o.day || new Date(o.ts||0).toISOString().slice(0,10);
        return day===key;
      })
      .reduce((a,o)=>a+Number(o.qty||0),0);
    arr.push(total);
  }
  return arr;
}

function computeForecast(){
  const db = loadDB();
  const result = [];

  for(const p of (db.products||[])){

    const net = computeStock(db, p.id);

    const last7 = getLastNDaysOps(db, p.id, 7);
    const avg7 = last7.reduce((a,b)=>a+b,0)/7;
    const dailyAvg = avg7;

    const daysLeft = dailyAvg>0 ? (net/dailyAvg) : 999;

    const insertDist = db.ops.filter(o=>o.pid===p.id && o.type==="dagilim" && String(o.sub||"").toLowerCase().includes("insert"));
    const insertSales = db.ops.filter(o=>o.pid===p.id && o.type==="satis" && String(o.sub||"").toLowerCase().includes("insert"));

    const insD = insertDist.reduce((a,o)=>a+Number(o.qty||0),0);
    const insS = insertSales.reduce((a,o)=>a+Number(o.qty||0),0);

    const insertRatio = insD>0 ? (insS/insD) : 0;

    const returns = db.ops.filter(o=>o.pid===p.id && o.type==="iade")
      .reduce((a,o)=>a+Number(o.qty||0),0);

    const totalSales = db.ops.filter(o=>o.pid===p.id && o.type==="satis")
      .reduce((a,o)=>a+Number(o.qty||0),0);

    const returnRate = totalSales>0 ? (returns/totalSales) : 0;

    result.push({
      name: p.name,
      net,
      avg7: Math.round(avg7),
      daysLeft: Math.round(daysLeft),
      insertRatio: Math.round(insertRatio*100),
      returnRate: Math.round(returnRate*100)
    });
  }

  renderForecast(result);
}

function renderForecast(rows){
  let box = document.getElementById("rForecast");
  if(!box){
    const container = document.createElement("div");
    container.innerHTML = `
      <div class="hr"></div>
      <div class="hint">Tahmin Motoru (Forecast + Risk)</div>
      <div id="rForecast" class="card"></div>
    `;
    document.getElementById("cardReport").appendChild(container);
    box = document.getElementById("rForecast");
  }

  if(rows.length===0){
    box.innerHTML="<div class='hint'>Veri yok</div>";
    return;
  }

  box.innerHTML = rows.map(r=>`
    <div style="padding:10px;border-bottom:1px solid var(--line)">
      <b>${r.name}</b><br>
      Stok: ${r.net} |
      7g Ort: ${r.avg7} |
      Tahmini bitiÅŸ: ${r.daysLeft} gÃ¼n |
      Insert %: ${r.insertRatio} |
      Ä°ade %: ${r.returnRate}
    </div>
  `).join("");
}

const _reportForDays_V20 = reportForDays;
reportForDays = function(days){
  _reportForDays_V20(days);
  try{ computeForecast(); }catch(e){}
};

document.addEventListener("DOMContentLoaded", ()=>{
  try{ computeForecast(); }catch(e){}
});



/* V21_RISK_ENGINE */

function computeRiskScore(row){
  let score = 0;

  if(row.daysLeft <= 3) score += 40;
  else if(row.daysLeft <= 7) score += 20;

  if(row.insertRatio < 40) score += 20;

  if(row.returnRate > 15) score += 20;

  if(row.avg7 === 0 && row.net > 0) score += 10;

  return score;
}

function renderRiskPanel(rows){

  let box = document.getElementById("rRisk");
  if(!box){
    const container = document.createElement("div");
    container.innerHTML = `
      <div class="hr"></div>
      <div class="hint">Risk Motoru</div>
      <div id="rRisk" class="card"></div>
    `;
    document.getElementById("cardReport").appendChild(container);
    box = document.getElementById("rRisk");
  }

  if(rows.length===0){
    box.innerHTML = "<div class='hint'>Risk verisi yok</div>";
    return;
  }

  box.innerHTML = rows.map(r=>{
    const score = computeRiskScore(r);

    let level = "ğŸŸ¢ Stabil";
    if(score >= 60) level = "ğŸ”´ Kritik";
    else if(score >= 30) level = "ğŸŸ  Dikkat";

    return `
      <div style="padding:10px;border-bottom:1px solid var(--line)">
        <b>${r.name}</b><br>
        Risk Skor: <b>${score}</b> â€” ${level}
      </div>
    `;
  }).join("");
}

const _computeForecast_V21 = computeForecast;
computeForecast = function(){
  _computeForecast_V21();
  try{
    const db = loadDB();
    const rows = [];
    for(const p of (db.products||[])){
      const net = computeStock(db, p.id);
      const last7 = getLastNDaysOps(db, p.id, 7);
      const avg7 = last7.reduce((a,b)=>a+b,0)/7;
      const dailyAvg = avg7;
      const daysLeft = dailyAvg>0 ? (net/dailyAvg) : 999;

      const insertDist = db.ops.filter(o=>o.pid===p.id && o.type==="dagilim" && String(o.sub||"").toLowerCase().includes("insert"));
      const insertSales = db.ops.filter(o=>o.pid===p.id && o.type==="satis" && String(o.sub||"").toLowerCase().includes("insert"));
      const insD = insertDist.reduce((a,o)=>a+Number(o.qty||0),0);
      const insS = insertSales.reduce((a,o)=>a+Number(o.qty||0),0);
      const insertRatio = insD>0 ? (insS/insD)*100 : 0;

      const returns = db.ops.filter(o=>o.pid===p.id && o.type==="iade")
        .reduce((a,o)=>a+Number(o.qty||0),0);

      const totalSales = db.ops.filter(o=>o.pid===p.id && o.type==="satis")
        .reduce((a,o)=>a+Number(o.qty||0),0);

      const returnRate = totalSales>0 ? (returns/totalSales)*100 : 0;

      rows.push({
        name: p.name,
        net,
        avg7: Math.round(avg7),
        daysLeft: Math.round(daysLeft),
        insertRatio: Math.round(insertRatio),
        returnRate: Math.round(returnRate)
      });
    }

    renderRiskPanel(rows);
  }catch(e){}
};



/* V22_UI_DECLUTTER */
(function(){
  const KEY_COMPACT = "stok_view_compact_v1";
  const KEY_DETAILS = "stok_view_details_v1"; // 1=detay aÃ§Ä±k

  function setBodyFlags(){
    const compact = localStorage.getItem(KEY_COMPACT) === "1";
    const details = localStorage.getItem(KEY_DETAILS) === "1";

    document.body.classList.toggle("compact", compact);
    document.body.classList.toggle("hideDetails", !details);

    const bC = document.getElementById("btnCompact");
    const bD = document.getElementById("btnDetails");
    if(bC) bC.classList.toggle("on", compact);
    if(bD) bD.classList.toggle("on", details);

    if(bC) bC.textContent = compact ? "Kompakt âœ“" : "Kompakt";
    if(bD) bD.textContent = details ? "Detay âœ“" : "Detay";
  }

  function toggleCompact(){
    const cur = localStorage.getItem(KEY_COMPACT) === "1";
    localStorage.setItem(KEY_COMPACT, cur ? "0" : "1");
    setBodyFlags();
  }

  function toggleDetails(){
    const cur = localStorage.getItem(KEY_DETAILS) === "1";
    localStorage.setItem(KEY_DETAILS, cur ? "0" : "1");
    setBodyFlags();
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    // default: kompakt aÃ§Ä±k, detay kapalÄ±
    if(localStorage.getItem(KEY_COMPACT) === null) localStorage.setItem(KEY_COMPACT, "1");
    if(localStorage.getItem(KEY_DETAILS) === null) localStorage.setItem(KEY_DETAILS, "0");

    const bC = document.getElementById("btnCompact");
    const bD = document.getElementById("btnDetails");
    if(bC) bC.addEventListener("click", toggleCompact);
    if(bD) bD.addEventListener("click", toggleDetails);

    setBodyFlags();
  });
})();

</script>
</body>
</html>
