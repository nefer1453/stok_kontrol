<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stok Kontrol Motoru</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:#1f2a44;
      --ok:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --btn:#1d4ed8;
      --chip:#111c33;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b1220,#070b14);color:var(--text)}
    header{
      position:sticky; top:0; z-index:50;
      padding:14px 14px 10px;
      background:rgba(11,18,32,.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(31,42,68,.6);
    }
    .brand{display:flex;align-items:baseline;justify-content:space-between;gap:10px}
    .brand .t{font-weight:950;font-size:18px;letter-spacing:.2px}
    .brand .v{color:var(--muted);font-size:12px}
    main{max-width:620px;margin:0 auto;padding:14px;padding-bottom:120px}
    .card{
      background:rgba(15,23,42,.92);
      border:1px solid rgba(31,42,68,.8);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center}
    .between{justify-content:space-between}
    .hint{color:var(--muted);font-size:12px;line-height:1.2}
    input,select,textarea{
      width:100%;
      background:#0b1326;
      border:1px solid rgba(31,42,68,.9);
      color:var(--text);
      border-radius:16px;
      padding:14px 14px;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:90px;resize:none}
    input:focus,select:focus,textarea:focus{border-color:rgba(29,78,216,.8)}
    .btn{
      border:0;
      border-radius:16px;
      padding:14px 14px;
      font-weight:900;
      color:white;
      background:var(--btn);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#0b1326;border:1px solid rgba(31,42,68,.9);color:var(--text)}
    .btn.ok{background:var(--ok)}
    .btn.bad{background:var(--bad)}
    .btn.warn{background:var(--warn);color:#111827}
    .btn:disabled{opacity:.45;cursor:not-allowed;transform:none}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background:rgba(17,28,51,.85);
      border:1px solid rgba(31,42,68,.8);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:18px;
      border:1px solid rgba(31,42,68,.8);
      background:rgba(11,19,38,.65);
    }
    .name{font-weight:950}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:7px 10px;border-radius:999px;
      background:rgba(17,28,51,.9);
      border:1px solid rgba(31,42,68,.8);
      font-size:12px;color:var(--muted);
    }
    .pill.ok{color:#bbf7d0;border-color:rgba(22,163,74,.35)}
    .pill.bad{color:#fecaca;border-color:rgba(239,68,68,.35)}
    .hr{height:1px;background:rgba(31,42,68,.75);margin:10px 0}

    /* Bottom controls (sabit) */
    #bottom{
      position:fixed;left:0;right:0;bottom:0;z-index:9999;
      background:rgba(7,11,20,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(31,42,68,.7);
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
    }
    #bottom .wrap{
      max-width:620px;margin:0 auto;
      display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px;
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div>
      <div class="t">Stok Kontrol Motoru</div>
      <div class="v" id="ver">v1.0 • ürün + işlem</div>
    </div>
    <div class="hint" id="topInfo"></div>
  </div>
</header>

<main class="grid">
  <!-- ÜRÜN EKLE -->
  <section class="card">
    <div class="row between">
      <div>
        <div style="font-weight:950">Ürün</div>
        <div class="hint">Sadece isim. Sonra işlem gir.</div>
      </div>
      <span class="pill" id="pCount">0 ürün</span>
    </div>
    <div class="hr"></div>
    <div class="grid">
      <input id="prodName" placeholder="Ürün adı (örn: Kaşar 600g)" autocomplete="off">
      <button id="btnAddProd" class="btn ok">Ürün Ekle</button>
      <div class="hint">Enter = ürün ekler.</div>
    </div>
  </section>

  <!-- İŞLEM EKLE -->
  <section class="card" id="opCard">
    <div class="row between">
      <div>
        <div style="font-weight:950">İşlem</div>
        <div class="hint">Artış / Azalış ve alt tür.</div>
      </div>
      <span class="pill" id="opCount">0 işlem</span>
    </div>
    <div class="hr"></div>
    <div class="grid">
      <select id="selProd"></select>

      <div class="row">
        <button id="btnInc" class="btn ok" style="flex:1">+ Artış</button>
        <button id="btnDec" class="btn bad" style="flex:1">− Azalış</button>
      </div>

      <select id="selKind"></select>

      <div class="row">
        <input id="qty" type="number" min="1" step="1" placeholder="Adet">
        <button id="btnSaveOp" class="btn" style="min-width:140px">İşlem Ekle</button>
      </div>

      <textarea id="note" placeholder="Not (opsiyonel)"></textarea>

      <div class="chips" id="quick"></div>

      <div class="hint">
        Mantık: Ürün ekledikten sonra işlem girilir. İşlem = stok hareketi. <br>
        Artış: sipariş / dağılım… • Azalış: satış / SKT / iade…
      </div>
    </div>
  </section>

  <!-- LİSTE -->
  <section class="card">
    <div class="row between">
      <div style="font-weight:950">Kayıtlar</div>
      <input id="q" type="search" placeholder="Ara (sabit)..." style="max-width:220px">
    </div>
    <div class="hint" id="info" style="margin-top:8px"></div>
    <div class="hr"></div>
    <div class="list" id="list"></div>
  </section>
</main>

<!-- ALT SABİT KONTROLLER -->
<div id="bottom" role="navigation" aria-label="Alt kontrol">
  <div class="wrap">
    <button class="btn secondary" id="btnModeProducts">Ürünler</button>
    <button class="btn secondary" id="btnModeOps">İşlemler</button>
    <button class="btn warn" id="btnClear">Temizle</button>
  </div>
</div>

<script>
(() => {
  const KEY="stok_kontrol_v10";
  const $=id=>document.getElementById(id);
  const LS={
    get:(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)||"null") ?? d }catch(_){ return d } },
    set:(k,v)=>localStorage.setItem(k, JSON.stringify(v))
  };
  const uid=()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
  const esc=s=>String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  // DB
  let db=LS.get(KEY,{products:[], ops:[]});
  function save(){ LS.set(KEY, db); }

  // Kinds
  const INC_KINDS = [
    {v:"Siparis.Firma.Ziyaret",  t:"Sipariş • Firma • Ziyaret"},
    {v:"Siparis.Firma.GelenTel", t:"Sipariş • Firma • Telefon geldi"},
    {v:"Siparis.Firma.Aranan",   t:"Sipariş • Firma • Telefon edildi"},
    {v:"Siparis.Depo.Merkez",    t:"Sipariş • Depo • Merkez depoya"},
    {v:"Siparis.Depo.Sarkuteri", t:"Sipariş • Depo • Şarküteri depoya"},
    {v:"Dagitim.Merkez.Normal",  t:"Dağılım • Merkez • Normal"},
    {v:"Dagitim.Merkez.Iskonto", t:"Dağılım • Merkez • İskonto"},
    {v:"Dagitim.Merkez.Insert",  t:"Dağılım • Merkez • Insert"},
    {v:"Dagitim.Insert",         t:"Dağılım • Insert (kampanya)"}
  ];
  const DEC_KINDS = [
    {v:"Satis.Normal",           t:"Satış • Normal"},
    {v:"Satis.Insert",           t:"Satış • Insert"},
    {v:"SKT",                    t:"Azalış • SKT"},
    {v:"Iade.Musteri",           t:"İade • Müşteri iadesi"},
    {v:"Iade.TarihiGecmis",      t:"İade • Tarihi geçmiş"},
    {v:"Iade.Fabrika",           t:"İade • Fabrika kaynaklı"},
    {v:"Iade.Raf",               t:"İade • Raf kaynaklı"}
  ];

  let mode="ops"; // ops or products

  function setMode(m){
    mode=m;
    $("btnModeProducts").className = "btn secondary";
    $("btnModeOps").className = "btn secondary";
    if(m==="products") $("btnModeProducts").className = "btn";
    if(m==="ops") $("btnModeOps").className = "btn";
    render();
  }

  function syncSelects(){
    // product select
    const sel=$("selProd");
    sel.innerHTML="";
    if(!db.products.length){
      sel.innerHTML = `<option value="">Önce ürün ekle</option>`;
      sel.disabled=true;
      $("btnInc").disabled=true;
      $("btnDec").disabled=true;
      $("btnSaveOp").disabled=true;
      $("selKind").disabled=true;
      $("qty").disabled=true;
      $("note").disabled=true;
      $("quick").innerHTML="";
      return;
    }
    sel.disabled=false;
    $("btnInc").disabled=false;
    $("btnDec").disabled=false;
    $("btnSaveOp").disabled=false;
    $("selKind").disabled=false;
    $("qty").disabled=false;
    $("note").disabled=false;

    for(const p of db.products){
      const o=document.createElement("option");
      o.value=p.id;
      o.textContent=p.name;
      sel.appendChild(o);
    }
    if(!sel.value) sel.value=db.products[0].id;
  }

  function setKindList(type){
    const kinds = type==="inc" ? INC_KINDS : DEC_KINDS;
    const sel=$("selKind");
    sel.innerHTML="";
    for(const k of kinds){
      const o=document.createElement("option");
      o.value=k.v;
      o.textContent=k.t;
      sel.appendChild(o);
    }
    // quick chips
    const quick = $("quick");
    quick.innerHTML="";
    const picks = kinds.slice(0,5);
    for(const k of picks){
      const b=document.createElement("button");
      b.className="chip";
      b.type="button";
      b.textContent=k.t.split("•").slice(0,2).join("•").trim();
      b.onclick=()=>{ sel.value=k.v; };
      quick.appendChild(b);
    }
    $("btnSaveOp").dataset.type = type;
  }

  function addProduct(){
    const name=($("prodName").value||"").trim();
    if(!name){ alert("Ürün adı yaz."); $("prodName").focus(); return; }
    db.products.unshift({id:uid(), name, ts:Date.now()});
    save();
    $("prodName").value="";
    $("prodName").focus();
    syncSelects();
    render();
  }

  function addOp(){
    if(!db.products.length){ alert("Önce ürün ekle."); return; }
    const pid=$("selProd").value;
    const p=db.products.find(x=>x.id===pid);
    if(!p){ alert("Ürün seç."); return; }

    const type = $("btnSaveOp").dataset.type || "dec"; // default azalış
    const kind = $("selKind").value || "";
    const qty = parseInt(($("qty").value||"").trim(),10);
    const note = ($("note").value||"").trim() || null;
    if(!qty || qty<1){ alert("Adet yaz (>=1)."); $("qty").focus(); return; }
    if(!kind){ alert("Tür seç."); return; }

    db.ops.unshift({
      id:uid(),
      ts:Date.now(),
      pid:p.id,
      name:p.name,
      type, // inc / dec
      kind,
      qty,
      note
    });
    // limit
    if(db.ops.length>5000) db.ops.length=5000;
    save();

    // reset fast
    $("qty").value="";
    $("note").value="";
    $("qty").focus();
    render();
  }

  function fmtTs(ts){
    try{ return new Date(ts).toLocaleString("tr-TR"); }catch(_){ return ""; }
  }

  function render(){
    $("pCount").textContent = `${db.products.length} ürün`;
    $("opCount").textContent = `${db.ops.length} işlem`;
    $("topInfo").textContent = mode==="products" ? "Ürün modu" : "İşlem modu";

    syncSelects();

    const q=($("q").value||"").trim().toLowerCase();

    const box=$("list");
    box.innerHTML="";

    if(mode==="products"){
      const rows = db.products
        .filter(p=>!q || p.name.toLowerCase().includes(q))
        .slice();

      $("info").textContent = rows.length ? `${rows.length} ürün` : "Ürün yok.";

      if(!rows.length){
        box.innerHTML = `<div class="hint">Henüz ürün yok.</div>`;
        return;
      }
      for(const p of rows){
        const el=document.createElement("div");
        el.className="item";
        const used = db.ops.filter(o=>o.pid===p.id).length;
        el.innerHTML = `
          <div style="flex:1">
            <div class="name">${esc(p.name)}</div>
            <div style="margin-top:8px" class="row" style="gap:8px">
              <span class="pill">${fmtTs(p.ts)}</span>
              <span class="pill">İşlem: ${used}</span>
            </div>
          </div>
          <div>
            <button class="btn secondary" data-del="${p.id}" style="padding:10px 12px">Sil</button>
          </div>
        `;
        el.querySelector("[data-del]").onclick=()=>{
          if(!confirm("Ürün silinsin mi? (İşlemleri de siler)")) return;
          db.products=db.products.filter(x=>x.id!==p.id);
          db.ops=db.ops.filter(o=>o.pid!==p.id);
          save();
          syncSelects();
          render();
        };
        box.appendChild(el);
      }
      return;
    }

    // ops mode
    const rows = db.ops
      .filter(o=>{
        if(!q) return true;
        const s = (o.name+" "+o.kind+" "+(o.note||"")).toLowerCase();
        return s.includes(q);
      })
      .slice();

    $("info").textContent = rows.length ? `${rows.length} işlem` : "İşlem yok.";

    if(!rows.length){
      box.innerHTML = `<div class="hint">Henüz işlem yok. Ürün ekle → işlem gir.</div>`;
      return;
    }

    for(const o of rows){
      const el=document.createElement("div");
      el.className="item";
      const pillCls = o.type==="inc" ? "pill ok" : "pill bad";
      const sign = o.type==="inc" ? "+" : "−";
      el.innerHTML = `
        <div style="flex:1">
          <div class="name">${esc(o.name)}</div>
          <div class="hint" style="margin-top:6px">${esc(o.kind)}${o.note?` • ${esc(o.note)}`:""}</div>
          <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap">
            <span class="${pillCls}">${sign}${o.qty}</span>
            <span class="pill">${esc(fmtTs(o.ts))}</span>
          </div>
        </div>
        <div>
          <button class="btn secondary" data-delop="${o.id}" style="padding:10px 12px">Sil</button>
        </div>
      `;
      el.querySelector("[data-delop]").onclick=()=>{
        if(!confirm("İşlem silinsin mi?")) return;
        db.ops=db.ops.filter(x=>x.id!==o.id);
        save();
        render();
      };
      box.appendChild(el);
    }
  }

  // Events
  $("btnAddProd").onclick=addProduct;
  $("prodName").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); addProduct(); }});

  $("btnInc").onclick=()=>{ setKindList("inc"); $("qty").focus(); };
  $("btnDec").onclick=()=>{ setKindList("dec"); $("qty").focus(); };

  $("btnSaveOp").onclick=addOp;
  $("qty").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); addOp(); }});

  $("q").addEventListener("input", render);

  $("btnModeProducts").onclick=()=>setMode("products");
  $("btnModeOps").onclick=()=>setMode("ops");

  $("btnClear").onclick=()=>{
    if(!confirm("Tüm veriler silinsin mi? (ürün+işlem)")) return;
    db={products:[],ops:[]};
    save();
    syncSelects();
    render();
    $("prodName").focus();
  };

  // Boot
  // default: azalış listesi gelsin (çoğu kullanımda satış/skt hızlı)
  setKindList("dec");
  syncSelects();
  setMode("ops");
  render();
  $("prodName").focus();
})();
</script>
</body>
</html>
