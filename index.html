<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stok Kontrol Motoru</title>
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{
      --bg:#070b14; --card:#0b1220; --card2:#0d1730;
      --text:#e5e7eb; --muted:#94a3b8; --line:rgba(255,255,255,.08);
      --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b; --blue:#2563eb;
      --r:20px; --pad:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070b14,#05070f);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(7,11,20,.72);backdrop-filter: blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:920px;margin:0 auto;padding:14px 14px 18px}
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.15fr .85fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px;font-size:15px}
    .hint{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    input,select,textarea{
      width:100%; background:rgba(255,255,255,.03); color:var(--text);
      border:1px solid var(--line); border-radius:16px; padding:12px 12px;
      outline:none; font-size:14px;
    }
    input::placeholder,textarea::placeholder{color:rgba(148,163,184,.7)}
    .btn{
      border:0; border-radius:16px; padding:12px 14px; font-weight:900;
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer;
      border:1px solid rgba(255,255,255,.08);
      user-select:none;
    }
    .btnOK{background:rgba(22,163,74,.18); border-color:rgba(22,163,74,.35)}
    .btnBAD{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.35)}
    .btnBLUE{background:rgba(37,99,235,.16); border-color:rgba(37,99,235,.35)}
    .btn:active{transform:translateY(1px)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);font-size:12px}
    .kpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .kpi .pill{justify-content:center;font-weight:900}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{padding:12px;border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.03)}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .name{font-weight:950}
    .muted{color:var(--muted);font-size:12px;margin-top:4px}
    .miniRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted)}
    .netBig{font-size:26px;font-weight:1000;letter-spacing:.3px}
    .netBox{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .smallBtn{padding:10px 12px;border-radius:14px}
    .danger{color:#fecaca}
    /* REPORT_COMPACT_V2 */
    #cardReport{max-height: calc(100vh - 150px); overflow:auto; -webkit-overflow-scrolling: touch;}
    #cardReport .row:first-of-type{position: sticky; top:0; z-index:5; background: var(--card, #fff); padding-top:10px; padding-bottom:10px;}
    #cardReport .hr{margin:10px 0}
    /* ERROR_GUARD */
    #errorGuardBox{position:fixed;left:0;right:0;bottom:0;background:#7f1d1d;color:#fff;padding:12px;font-size:12px;display:none;z-index:99999;max-height:40vh;overflow:auto;border-top:2px solid #ef4444}
  
/* MODAL_ONEHAND_V1 */
#modal .card{
  position:relative;
}
#modal .onehandBar{
  position: sticky;
  bottom: 0;
  z-index: 20;
  background: rgba(11,18,32,.92);
  backdrop-filter: blur(8px);
  border-top: 1px solid rgba(255,255,255,.08);
  padding-top: 10px;
  padding-bottom: 10px;
  margin-top: 12px;
}
#modal .onehandBar .btn{ width: 100%; padding: 14px 16px; border-radius: 18px; }
#modal .fastTypeRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
#modal .fastTypeRow .btn{
  padding:10px 12px;
  border-radius: 999px;
  font-weight: 900;
}
#modal #opQty{
  font-size: 16px;
  font-weight: 900;
}


/* QUICK_QTY_V1 */
#quickQtyRow .btn{
  padding:10px 12px;
  border-radius:999px;
  font-weight:950;
}


/* V12_KOLI_MODE_MODAL_OPAQUE_V2 */
#modal{background:rgba(0,0,0,.78) !important;}
.modalCard{
  background: var(--card) !important;
  border: 1px solid var(--line) !important;
  box-shadow: 0 18px 50px rgba(0,0,0,.55) !important;
}
.modeBtn{padding:10px 12px;border-radius:999px}
.modeBtnOn{background:rgba(37,99,235,.22);border-color:rgba(37,99,235,.45)}
.modeHint{color:var(--muted);font-size:12px;margin-top:6px}


/* V15_UNDO_DELETE_OPS */
.btnMini{
  padding:8px 10px;
  border-radius:12px;
  font-size:12px;
  font-weight:900;
}
.btnDel{
  background:rgba(239,68,68,.14);
  border-color:rgba(239,68,68,.35);
}


/* V16_REPORT_DETAIL_STOCK_CSV */

/* V17_HQ_REPORTS */
function sumQty(list){
  let n=0;
  for(const o of list){ n += Number(o.qty||0); }
  return n;
}

function filterType(ops, typeKey){
  return ops.filter(o => (o.type===typeKey) || (String(o.typeLabel||"").toLowerCase().includes(typeKey)));
}

function subBreakdown(list){
  const m=new Map();
  for(const o of list){
    const k=(o.sub||"").trim() || "Alt yok";
    m.set(k, (m.get(k)||0) + Number(o.qty||0));
  }
  return [...m.entries()].sort((a,b)=>b[1]-a[1]);
}

function dailySeries(ops, typeKey, days){
  // son N gÃ¼n (bugÃ¼n dahil) typeKey toplamÄ±
  const out=[];
  const now=new Date();
  for(let i=days-1;i>=0;i--){
    const d=new Date(now.getTime()-i*24*3600*1000);
    const key=d.toISOString().slice(0,10);
    let total=0;
    for(const o of ops){
      const day=o.day || (new Date(o.ts||0).toISOString().slice(0,10));
      if(day!==key) continue;
      if(typeKey && o.type!==typeKey) continue;
      total += Number(o.qty||0);
    }
    out.push([key,total]);
  }
  return out;
}

function renderHQSales(db, ops, days){
  const box=$("rHQSales");
  if(!box) return;

  const sales = ops.filter(o=>o.type==="satis");
  const total = sumQty(sales);

  const bd = subBreakdown(sales).slice(0,10);
  const series = dailySeries(ops, "satis", Math.min(7, Math.max(1, days)));

  const bdHtml = bd.length ? bd.map(([k,v])=>`
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">${escapeHTML(k)}</div>
        <div class="badge"><b>${fmtInt(v)}</b></div>
          ${speedHTMLLight(__crit[p.id])}
      </div>
    </div>
  `).join("") : `<div class="miniLine"><div class="hint">SatÄ±ÅŸ alt kÄ±rÄ±lÄ±m yok.</div></div>`;

  const serHtml = series.map(([d,v])=>`
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">${escapeHTML(d.slice(5))}</div>
        <div class="badge"><b>${fmtInt(v)}</b></div>
      </div>
    </div>
  `).join("");

  box.innerHTML = `
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Toplam SatÄ±ÅŸ</div>
        <div class="badge">adet <b>${fmtInt(total)}</b></div>
      </div>
      <div class="rTiny">AralÄ±k: ${fmtInt(days)} gÃ¼n â€¢ â€œSatÄ±ÅŸ (-)â€ iÅŸlemlerinden</div>
    </div>
    <div class="rTiny" style="margin-top:8px">SatÄ±ÅŸ alt kÄ±rÄ±lÄ±m</div>
    ${bdHtml}
    <div class="rTiny" style="margin-top:8px">GÃ¼nlÃ¼k satÄ±ÅŸ (son ${Math.min(7, Math.max(1, days))} gÃ¼n)</div>
    ${serHtml}
  `;
}

function renderHQInsert(db, ops, days){
  const box=$("rHQInsert");
  if(!box) return;

  const dist = ops.filter(o=>o.type==="dagilim").filter(o=>String(o.sub||"").toLowerCase().includes("insert"));
  const sales = ops.filter(o=>o.type==="satis").filter(o=>String(o.sub||"").toLowerCase().includes("insert"));

  const dTot = sumQty(dist);
  const sTot = sumQty(sales);
  const ratio = dTot>0 ? (sTot/dTot) : 0;
  const net = dTot - sTot;

  let signal = "ğŸŸ© Normal";
  if(dTot>0 && ratio < 0.35) signal = "ğŸŸ¥ ZayÄ±f (insert satÄ±ÅŸ dÃ¼ÅŸÃ¼k)";
  else if(dTot>0 && ratio < 0.60) signal = "ğŸŸ§ Orta";

  box.innerHTML = `
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Insert DaÄŸÄ±lÄ±m (+)</div>
        <div class="badge"><b>${fmtInt(dTot)}</b></div>
      </div>
      <div class="rTiny">â€œDaÄŸÄ±lÄ±m (+)â€ iÃ§inde alt kÄ±rÄ±lÄ±mÄ± â€œInsertâ€ olanlar</div>
    </div>
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Insert SatÄ±ÅŸ (-)</div>
        <div class="badge"><b>${fmtInt(sTot)}</b></div>
      </div>
      <div class="rTiny">â€œSatÄ±ÅŸ (-)â€ iÃ§inde alt kÄ±rÄ±lÄ±mÄ± â€œInsert satÄ±ÅŸâ€ olanlar</div>
    </div>
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Insert DÃ¶nÃ¼ÅŸÃ¼m</div>
        <div class="badge">% <b>${Math.round(ratio*100)}</b></div>
      </div>
      <div class="rTiny">${signal} â€¢ Net insert (daÄŸÄ±lÄ±m - satÄ±ÅŸ): ${fmtInt(net)}</div>
    </div>
  `;
}

function renderHQReturns(db, ops, days){
  const box=$("rHQReturns");
  if(!box) return;

  const ret = ops.filter(o=>o.type==="iade");
  const total = sumQty(ret);
  const bd = subBreakdown(ret).slice(0,15);

  box.innerHTML = `
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">Toplam Ä°ade</div>
        <div class="badge">adet <b>${fmtInt(total)}</b></div>
      </div>
      <div class="rTiny">AralÄ±k: ${fmtInt(days)} gÃ¼n â€¢ â€œÄ°ade (-)â€ iÅŸlemlerinden</div>
    </div>
    ${
      bd.length ? bd.map(([k,v])=>`
        <div class="miniLine">
          <div class="rRow">
            <div class="rKey">${escapeHTML(k)}</div>
            <div class="badge"><b>${fmtInt(v)}</b></div>
          </div>
        </div>
      `).join("") : `<div class="miniLine"><div class="hint">Ä°ade sebep kÄ±rÄ±lÄ±mÄ± yok.</div></div>`
    }
  `;
}

// reportForDays sonrasÄ± hook (V16 varsa onunla uyumlu)
const _reportForDays_V17 = reportForDays;
reportForDays = function(days){
  _reportForDays_V17(days);
  const db = loadDB();
  try{ const __PID=(typeof getActivePid==='function')?getActivePid():''; if(__PID) db.ops=(db.ops||[]).filter(o=>o.pid===__PID); }catch(e){}
  const ops = opsInDays(db, days);
  renderHQSales(db, ops, days);
  renderHQInsert(db, ops, days);
  renderHQReturns(db, ops, days);
};

.rGrid2{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
@media(min-width:900px){.rGrid2{grid-template-columns:1fr 1fr}}
.rRow{display:flex;justify-content:space-between;gap:10px;align-items:center}
.rKey{font-weight:950}
.rVal{font-weight:950}
.rTiny{color:var(--muted);font-size:12px;margin-top:4px}
.miniTable{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.miniLine{padding:10px 12px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02)}
.miniLine .rRow{align-items:flex-start}
.badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
.badge b{color:var(--text)}


/* V18_SINGLE_EXPORT_ALERTS */

/* Tek ekran modu: her ÅŸeyi alt alta dizer, rapor daha yÃ¶netici gibi tek sayfa */
body.single .grid{grid-template-columns:1fr !important;}
body.single #cardReport{max-height:none !important; overflow:visible !important;}
body.single header{position:sticky; top:0;}

/* Rapor iÃ§i export bar */
.exportBar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
.badge{display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.03); font-size:12px; color:var(--muted)}
.badge b{color:var(--text)}
.miniTable .miniLine{padding:10px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.03);margin-top:8px}
.miniTable .rRow{display:flex;justify-content:space-between;gap:10px;align-items:center}
.miniTable .rKey{font-weight:900}
.miniTable .rTiny{color:var(--muted);font-size:12px;margin-top:6px}
.alertRed{border-color:rgba(239,68,68,.45)!important;background:rgba(239,68,68,.10)!important}
.alertAmber{border-color:rgba(245,158,11,.45)!important;background:rgba(245,158,11,.10)!important}
.alertGreen{border-color:rgba(22,163,74,.45)!important;background:rgba(22,163,74,.10)!important}

/* Print/PDF: yÃ¶netici Ã§Ä±ktÄ±sÄ± */
@media print{
  header{position:static !important; background:#fff !important; color:#000 !important; border:none !important}
  body{background:#fff !important; color:#000 !important}
  .card{box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important}
  .btn, .chip{display:none !important}
  #modal, #errorGuardBox{display:none !important}
  .wrap{max-width:100% !important; padding:0 !important}
  .grid{grid-template-columns:1fr !important}
  .hint{color:#333 !important}
  .tag, .badge{border:1px solid #ddd !important; background:#fff !important; color:#111 !important}
}


/* V22_UI_DECLUTTER */
/* Kompakt mod: daha az padding, daha az satÄ±r, daha Ã§ok iÅŸ */
body.compact .card{padding:12px}
body.compact .item{padding:10px;border-radius:16px}
body.compact .miniRow{gap:6px}
body.compact .btn{padding:10px 12px;border-radius:14px}
body.compact .smallBtn{padding:9px 10px;border-radius:14px}
body.compact .muted{display:none}
body.compact .hint{font-size:11px}
body.compact .netBig{font-size:22px}

/* Detay kapalÄ± mod: raporda sadece KPI + risk + â€œen Ã§ok Ã¼rÃ¼nlerâ€ gÃ¶rÃ¼nsÃ¼n */
body.hideDetails #rTypes,
body.hideDetails #rBrain,
body.hideDetails #btnSkorTest{display:none !important;}
/* Risk paneli varsa kalsÄ±n; yoksa boÅŸ yere yer kaplamasÄ±n */
body.hideDetails #rRisk:empty{display:none !important;}

/* ÃœrÃ¼n kartÄ±nda etiketleri kÄ±s (Net etiketi gereksiz, zaten bÃ¼yÃ¼k sayÄ± var) */
body.compact .tag{padding:6px 8px;font-size:11px}
body.compact .pill{padding:8px 10px}

/* Header kontrol butonlarÄ± daha â€œbuton gibiâ€ olsun */
#btnCompact, #btnDetails{
  cursor:pointer;
  user-select:none;
}
#btnCompact.on, #btnDetails.on{
  background:rgba(37,99,235,.18);
  border-color:rgba(37,99,235,.35);
  color:var(--text);
}


/* V24_COMPACT_MODE */
.compact .miniRow,
.compact .list,
.compact .actions,
.compact .tag{
  display:none !important;
}
.modeSwitch{
  display:inline-flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  font-weight:800;
}


/* V25_STOCK_COLOR_SPEED_V2 */
.stockGreen{ color:#22c55e; font-weight:1000; }
.stockWarn{ color:#f59e0b; font-weight:1000; }
.stockRed{ color:#ef4444; font-weight:1000; }
.miniSpeed{ font-size:12px; margin-top:6px; opacity:.9; color:var(--muted); }


/* V26_TABS_DECLUTTER */
.tabsBar{
  position: sticky;
  top: 0;
  z-index: 60;
  margin-top: 10px;
  padding: 10px;
  border-radius: 18px;
  border: 1px solid var(--line);
  background: rgba(11,18,32,.78);
  backdrop-filter: blur(10px);
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.tabBtn{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  color: var(--muted);
  padding: 10px 12px;
  border-radius: 999px;
  font-weight: 950;
  cursor: pointer;
  user-select:none;
}
.tabBtnOn{
  color: var(--text);
  border-color: rgba(37,99,235,.45);
  background: rgba(37,99,235,.20);
}
.tabHint{
  color: var(--muted);
  font-size: 12px;
  margin-top: 8px;
}
.hiddenPanel{ display:none !important; }


/* V27_DECLUTTER_PRODUCTS_MOVE_HISTORY */
.actBar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
.actMain{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.actMoreWrap{display:none;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
.showMore .actMoreWrap{display:flex}
.btnGhost{background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.08);color:var(--muted)}
.opsFilterBar{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
  padding:10px 12px;border:1px solid var(--line);border-radius:18px;
  background:rgba(255,255,255,.03);
  margin-bottom:10px;
}
.opsFilterBar .name{font-weight:950}


/* V28_ALARM_TAB */
.alarmRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.alarmBtn{padding:10px 12px;border-radius:999px}
.alarmBtnOn{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.35)}
.alarmKpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.alarmKpi .pill{justify-content:center;font-weight:950}
.alarmList{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.alarmItem{padding:12px;border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.03)}
.alarmTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.alarmName{font-weight:950}
.alarmMeta{color:var(--muted);font-size:12px;margin-top:6px}
.badgeRed{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(239,68,68,.45);background:rgba(239,68,68,.14);color:#fecaca;font-size:12px;font-weight:900}
.badgeWarn{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fde68a;font-size:12px;font-weight:900}


/* V29_CENTER_KPI_REPORT_FILTER */
.centerKpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
.centerKpi .pill{justify-content:center;font-weight:950}
.reportFilterRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
.reportFilterRow select{min-width:220px}
.reportMiniTitle{color:var(--muted);font-size:12px;margin-top:10px}


/* V291_MINT_LIGHT_UI */
/* AÃ§Ä±k, ferah tema: motor aynÄ±, sadece kabuk deÄŸiÅŸiyor */
:root{
  --mint:#10b981;
  --mint2:#14b8a6;
  --bg:#f4f7fb;
  --card:#ffffff;
  --text:#0b1220;
  --muted:#5b667a;
  --line:rgba(15,23,42,.12);
  --shadow:0 10px 30px rgba(2,6,23,.08);
}

/* genel zemin */
body{
  background:var(--bg) !important;
  color:var(--text) !important;
}

/* eski koyu header'Ä± â€œmint barâ€ gibi hissettir */
header{
  background: linear-gradient(90deg, var(--mint), var(--mint2)) !important;
  color:#ffffff !important;
  border-bottom:1px solid rgba(255,255,255,.25) !important;
}

/* kartlar */
.card, section.card, .panel, .box, .pill, .kpi, .row, .item, .prodCard{
  background:var(--card) !important;
  border:1px solid var(--line) !important;
  box-shadow:var(--shadow) !important;
}

/* metin tonlarÄ± */
.muted, .hint, .sub, .small, .desc, .smallKpiTitle{
  color:var(--muted) !important;
}

/* butonlar: mint aÄŸÄ±rlÄ±klÄ±, sade */
button, .btn{
  border-radius:14px !important;
}
button.primary, .btnPrimary{
  background: linear-gradient(90deg, var(--mint), var(--mint2)) !important;
  color:#fff !important;
  border:0 !important;
}
button.ghost, .btnGhost{
  background: rgba(16,185,129,.10) !important;
  border:1px solid rgba(16,185,129,.25) !important;
  color:var(--text) !important;
}

/* iÃ§erik altta navâ€™a Ã§arpmasÄ±n */
main{ padding-bottom: 92px !important; }

/* bottom nav */
.bottomNav{
  position:fixed;
  left:0; right:0; bottom:0;
  z-index:9999;
  padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  background:rgba(255,255,255,.92);
  backdrop-filter: blur(10px);
  border-top:1px solid var(--line);
}
.bottomNav .navRow{
  display:flex;
  gap:10px;
}
.navBtn{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 10px;
  border-radius:16px;
  border:1px solid var(--line);
  background:#fff;
  color:var(--muted);
  font-weight:950;
  cursor:pointer;
}
.navBtnOn{
  color:var(--text);
  border-color: rgba(16,185,129,.45);
  background: rgba(16,185,129,.14);
}

/* panel gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ */
.v291Panel{ display:none; }
.v291PanelOn{ display:block; }

/* Ã¼stteki eski sekmeler kalabalÄ±k yapÄ±yorsa hafiflet */
.tabs, .tabRow, #tabsBar{
  opacity:.70;
}


/* V293_TOP_TABS_REMOVED */

/* V292FIX_V291_NAV_VISIBILITY */
/* v291 panel gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ kesinle */
.v291Panel{ display:none !important; }
.v291PanelOn{ display:block !important; }

/* eski tab/panel mimarisi kalÄ±ntÄ±larÄ± varsa onlarÄ± nÃ¶trle (v3.x / v30 vb) */
.panel{ display:block !important; }
.panelActive{ display:block !important; }
#tabsBar, .tabsBar, .tabs, .tabRow{ display:none !important; }


/* V32_GLOBAL_ACTIVE_PRODUCT */
.globalProdBar{
  position: sticky;
  top: 0;
  z-index: 120;
  margin: 10px 0 14px;
  padding: 10px;
  border-radius: 18px;
  border: 1px solid var(--line);
  background: rgba(11,18,32,.78);
  backdrop-filter: blur(8px);
}
.globalProdBar .row{ gap:8px; flex-wrap:wrap; }
.globalProdBar select{
  flex: 1;
  min-width: 180px;
}
.globalTag{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px;
  border:1px solid rgba(37,99,235,.35);
  background:rgba(37,99,235,.14);
  color: #c7d2fe;
  font-size:12px; font-weight:950;
}


/* V44_ALARM_7_15_30 */
.alarmBar{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  margin-top:10px;
}
.alarmBar .hint{margin:0}


/* V47_ACTIVE_BADGE_AND_ALARM_FOLLOW */
.activeBadge{
  margin-top:8px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(16,185,129,.35);
  background: rgba(16,185,129,.10);
  color: var(--text);
  font-weight: 950;
  font-size: 12px;
}
.activeBadge .mut{ color: var(--muted); font-weight: 800; }
.activeBadge .xBtn{
  margin-left:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: var(--muted);
  font-weight: 950;
}


/* V48B_ALARM_7_15_30_SAFE */
.alarmBar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin:10px 0;
}
.alarmBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  color: var(--muted);
  padding: 9px 12px;
  border-radius: 999px;
  font-weight: 950;
  cursor:pointer;
}
.alarmBtnOn{
  color: var(--text);
  border-color: rgba(239,68,68,.35);
  background: rgba(239,68,68,.16);
}


/* V50_FOCUS_MODE_ACTIVE_PRODUCT */
.focusPill{
  display:inline-flex; align-items:center; gap:8px;
  padding:7px 12px;
  border-radius:999px;
  border:1px solid rgba(37,99,235,.35);
  background:rgba(37,99,235,.12);
  color:#dbeafe;
  font-weight:950;
  font-size:12px;
}
.focusPill b{ color:#fff; }


/* V56_OPS_VIRTUAL_RENDER */
.opsMiniRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.opsMiniMeta{
  font-size:12px;
  opacity:.85;
}
.opsLoadBtn{
  width:100%;
  margin-top:10px;
  border-radius:999px;
  font-weight:950;
}


/* V57_OPS_RICHER_REAL */
.opsFilterChip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  font-size:12px;
}
.opsSubLine{
  font-size:12px;
  opacity:.85;
  margin-top:4px;
}


/* V59_FOCUS_TOGGLE_CLEAR_ACTIVE */
.focusBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: var(--text);
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 950;
  cursor:pointer;
  white-space:nowrap;
}
.focusBtnOff{
  color: var(--muted);
  background: rgba(255,255,255,.04);
}

</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Stok Kontrol Motoru</h1>
        <div class="sub">v1 â€” Ã¼rÃ¼n + iÅŸlemler + rapor + â€œakÄ±lâ€ Ã§ekirdeÄŸi</div>
      </div>
      <div class="chip" id="chipMeta">Local â€¢ HazÄ±r</div>
      <button class="chip" id="btnCompact" type="button">Kompakt</button>
      <button class="chip" id="btnDetails" type="button">Detay</button>

      <button class="btn" id="btnSingle" type="button" style="padding:10px 12px;border-radius:999px">Tek Ekran</button>
    </div>
  </div>

  <div style="margin-top:8px">
    <span class="modeSwitch" onclick="toggleCompact()">
      âš™ Detay Modu AÃ§/Kapat
    </span>
  </div>
</header>

<main class="wrap">
  <!-- V32: Global aktif Ã¼rÃ¼n seÃ§imi -->
  <div class="globalProdBar" id="globalProdBar">
    <div class="row">
      <span class="globalTag">ğŸ¯ Aktif ÃœrÃ¼n</span>
      <select id="globalProdSelect"></select>
      <button class="focusBtn" id="btnFocusToggle" type="button" title="Odak: AÃ§Ä±k/kapalÄ±">ğŸ¯ Odak</button>
      <button class="btn smallBtn" id="btnGlobalProdClear" type="button">Temizle</button>
    </div>
    <div class="hint" id="globalProdHint" style="margin-top:8px">
      Ä°pucu: ÃœrÃ¼n seÃ§ersen Ä°ÅŸlem/Alarm/Rapor otomatik o Ã¼rÃ¼ne gÃ¶re filtrelenir.
    </div>
  </div>

  <!-- V26: Sekmeli dÃ¼zen (ekran kalabalÄ±ÄŸÄ±nÄ± bÃ¶l) -->
  <!-- TOP_TABS_REMOVED
<div class="tabsBar" id="tabsBar">
    <button class="tabBtn tabBtnOn" data-tab="products" type="button">ÃœrÃ¼n</button>
    <button class="tabBtn" data-tab="report" type="button">Rapor</button>
    <button class="tabBtn" data-tab="ops" type="button">Ä°ÅŸlemler</button>
    <button class="tabBtn" data-tab="alarm" type="button">Alarm</button>
  </div>
-->
  <div class="tabHint" id="tabHint">ÃœrÃ¼n ekranÄ±: Ã¼rÃ¼n ekle/ara + stok kartlarÄ± + hÄ±zlÄ± iÅŸlem</div>

  <div class="grid">
    <!-- SOL -->
    <section class="card" id="cardProducts">
      <h2>ÃœrÃ¼n</h2>
      <div class="hint">ÃœrÃ¼n ekle / ara / stok kartlarÄ±</div>
      <div class="row" style="margin-top:10px">
        <input id="inProd" placeholder="ÃœrÃ¼n adÄ± (Enter = ekle)" />
        <button class="btn btnOK" id="btnAddProd" type="button">Ekle</button>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="inSearch" placeholder="Ara (sabit)" />
        <button class="btn smallBtn" id="btnClearSearch" type="button">Temizle</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="pill">Toplam: <b id="pCount">0</b></div>
        <button class="btn btnBLUE" id="btnAddOp" type="button">Ä°ÅŸlem Ekle</button>
      </div>

      <div class="list" id="prodList"></div>
    </section>

    <!-- SAÄ: RAPOR -->
    <section class="card" id="cardReport">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2 style="margin-bottom:2px">Rapor</h2>
          <div class="hint">Ã–zet ve â€œakÄ±lâ€ (bugÃ¼n / 7 gÃ¼n / 30 gÃ¼n)</div>
        </div>
        <div class="row">
          <button id="btnReportToday" class="btn btnBLUE" type="button">BugÃ¼n</button>
          <button id="btnReport7" class="btn btnBLUE" type="button">7g</button>
          <button id="btnReport30" class="btn btnBLUE" type="button">30g</button>
          <button id="btnUndo" class="btn" type="button">Geri Al</button>
        
          <button id="btnCSV" class="btn" type="button">CSV</button>
        </div>
        <div class="exportBar">
          <span class="badge">AralÄ±k: <b id="rDaysLbl">1</b> gÃ¼n</span>
          <button class="btn" id="btnExportCSV" type="button">CSV Export</button>
          <button class="btn" id="btnExportPDF" type="button">PDF (YazdÄ±r)</button>
        </div>
      </div>

      <div class="kpi">
        <div class="pill">ArtÄ±: <b id="rPlus">0</b></div>
        <div class="pill">Eksi: <b id="rMinus">0</b></div>
        <div class="pill">Net: <b id="rNet">0</b></div>
      </div>
      <!-- V29: Ã¼rÃ¼n filtresi -->
      <div class="reportFilterRow">
        <span class="pill">Filtre</span>
        <select id="reportProdFilter"></select>
        <span class="tag" id="reportFilterHint">TÃ¼mÃ¼</span>
      </div>

      <div class="reportMiniTitle">Merkez BakÄ±ÅŸÄ± (seÃ§ili aralÄ±k)</div>
      <div class="centerKpi">
        <div class="pill">DaÄŸÄ±lÄ±m(+): <b id="rDist">0</b></div>
        <div class="pill">SatÄ±ÅŸ(-): <b id="rSales">0</b></div>
        <div class="pill">Ä°ade(-): <b id="rReturn">0</b></div>
      </div>


      <div class="hr"></div>
      <div class="hint">En Ã§ok Ã¼rÃ¼nler</div>
      <div class="list" id="rTop"></div>

      <div class="hr"></div>
      <div class="hint">TÃ¼r daÄŸÄ±lÄ±mÄ±</div>
      <div class="list" id="rTypes"></div>
<div class="hr"></div>
<div class="hint">ÃœrÃ¼n BazlÄ± SatÄ±ÅŸ (Merkez ekranÄ±)</div>
<div class="card"><div id="rSalesProducts"></div></div>

<div class="hr"></div>
<div class="hint">Insert PerformansÄ± (Ã¼rÃ¼n bazlÄ±)</div>
<div class="card"><div id="rInsertPerf"></div></div>

<div class="hr"></div>
<div class="hint">Ä°ade Nedenleri</div>
<div class="card"><div id="rReturnReasons"></div></div>


<div class="hr"></div>
<div class="hint">Detay (TÃ¼r bazlÄ±)</div>
<div class="miniTable" id="rTypeTotals"></div>

<div class="hr"></div>
<div class="hint">Alt kÄ±rÄ±lÄ±m (SeÃ§ili aralÄ±k)</div>
<div class="miniTable" id="rSubTotals"></div>

<div class="hr"></div>
<div class="hint">Stok Snapshot (Mevcut net stok)</div>
<div class="miniTable" id="rStockNow"></div>


      <div class="hr"></div>
      <div class="hint">Kritik Alarm</div>
      <div class="miniTable" id="rAlerts"></div>

      <div class="hr"></div>
      <div class="hint">AkÄ±l</div>
      <div class="list" id="rBrain"></div>

<div class="hr"></div>
<div class="hint">Merkez Raporu (seÃ§ili aralÄ±k)</div>

<div class="miniTable" id="rHQSales"></div>

<div class="hr"></div>
<div class="hint">Insert PerformansÄ± (seÃ§ili aralÄ±k)</div>
<div class="miniTable" id="rHQInsert"></div>

<div class="hr"></div>
<div class="hint">Ä°ade Sebepleri (seÃ§ili aralÄ±k)</div>
<div class="miniTable" id="rHQReturns"></div>


      <div class="hr"></div>
      <button class="btn" id="btnSkorTest" type="button">Skor Test (debug)</button>
      <div class="hint" style="margin-top:8px">Sadece test: ilk Ã¼rÃ¼ne gÃ¶re skor/Ã§Ä±ktÄ± verir.</div>
    </section>
  </div>

  <!-- V26: Ops panel -->
  <section class="card hiddenPanel" id="cardOps" style="margin-top:14px">
    <h2>Ä°ÅŸlemler</h2>
    <div class="activeBadge" id="activeBadgeOps" style="display:none"></div>
    <div class="hint">Son iÅŸlemler (en yeni Ã¼stte). HÄ±zlÄ± kontrol iÃ§in.</div>
    <div class="hr"></div>
    <div class="row">
      <button class="btn smallBtn" id="btnOpsRefresh" type="button">Yenile</button>
      <button class="btn smallBtn btnBAD" id="btnOpsClear" type="button">TÃ¼m iÅŸlemleri sil (dikkat)</button>
    </div>
    <div class="hr"></div>
    <div class="list" id="opsList"></div>
  </section>

  <!-- V26: Alarm panel -->
  <section class="card hiddenPanel" id="cardAlarm" style="margin-top:14px">
    <h2>Alarm</h2>
    <div class="activeBadge" id="activeBadgeAlarm" style="display:none"></div>
    <div class="hint">Bu ekran â€œkritik stok / hÄ±z / riskâ€ gibi sinyaller iÃ§in ayrÄ±ldÄ±. Åimdilik sade.</div>
    <div class="hr"></div>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      <button class="btn smallBtn alarmBtnOn" id="btnAlarm7" type="button">7g</button>
      <button class="btn smallBtn" id="btnAlarm15" type="button">15g</button>
      <button class="btn smallBtn" id="btnAlarm30" type="button">30g</button>
      <span class="tag" style="margin-left:auto">Kritik: <b id="aCritCount">0</b> â€¢ Neg: <b id="aNegCount">0</b> â€¢ Zero: <b id="aZeroCount">0</b></span>
    </div>

    <div class="hr"></div>
    <div class="list" id="alarmList"></div>

    <div class="item">
      <div class="name">Plan</div>
      <div class="muted">
        â€¢ Kritik Ã¼rÃ¼n pinleme (varsa) burada toplanacak<br/>
        â€¢ Insert/iskonto/verim alarmÄ± burada olacak<br/>
        â€¢ â€œMerkez bakÄ±ÅŸÄ±â€ Ã¶zetleri burada bÃ¼yÃ¼tÃ¼lecek
      </div>
    </div>
  </section>

</main>

<!-- MODAL -->
<div id="modal" style="position:fixed;inset:0;display:none;z-index:9999;background:rgba(0,0,0,.6);padding:14px">
  <div class="card" modalCard style="max-width:720px;margin:0 auto;max-height:85vh;overflow:auto">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="name">Ä°ÅŸlem Ekle</div>
        <div class="hint">ÃœrÃ¼n seÃ§ â†’ tÃ¼r seÃ§ â†’ alt kÄ±rÄ±lÄ±m (varsa) â†’ adet</div>
      </div>
      <button class="btn" id="btnClose" type="button">Kapat</button>
    </div>

    <div class="hr"></div>

    <div class="row">
      <select id="opProd"></select>

      <div class="row" style="gap:8px">
        <button class="btn modeBtn modeBtnOn" id="btnModeAdet" type="button">Adet</button>
        <button class="btn modeBtn" id="btnModeKoli" type="button">Koli</button>
      </div>
    </div>

    <!-- ADET MODU -->
    <div id="wrapAdet">
      <div class="row" style="margin-top:10px">
        <input id="opQty" inputmode="numeric" placeholder="Adet (Ã¶rn 3)" />
      </div>
      <div class="hint">HÄ±zlÄ± adet</div>
      <div class="miniRow" id="quickQtyRow"></div>
    </div>

    <!-- KOLÄ° MODU -->
    <div id="wrapKoli" style="display:none">
      <div class="row" style="margin-top:10px">
        <input id="opPackCount" inputmode="numeric" placeholder="Koli sayÄ±sÄ± (Ã¶rn 2)" />
        <input id="opPackSize" inputmode="numeric" placeholder="Koli iÃ§i adet (Ã¶rn 12)" />
      </div>

      <div class="hint">HÄ±zlÄ± koli sayÄ±sÄ±</div>
      <div class="miniRow" id="quickPackRow"></div>

      <div class="modeHint">Toplam adet: <b id="opPackTotal">0</b> (koliÃ—iÃ§ adet)</div>
      <div class="modeHint">Not: Koli iÃ§i adet girersen sistem bunu bu Ã¼rÃ¼ne hatÄ±rlar.</div>
    </div>

    <div class="hint">HÄ±zlÄ± adet / koli</div>
    


    <div class="miniRow" id="qtyRow" style="margin-top:8px"></div>

    <div class="hint">HÄ±zlÄ± tÃ¼r (tek dokunuÅŸ)</div>
    <div class="fastTypeRow" id="fastTypeRow"></div>

    <div class="row">
      <select id="opType"></select>
      <select id="opSub"></select>
    </div>

    <div class="row">
      <input id="opNote" placeholder="Not (opsiyonel)" />
    </div>

    <div class="onehandBar">
      <button class="btn btnOK" id="btnSaveOp" type="button">Kaydet</button>
    </div>

    <div class="hr"></div>
    <div class="hint">HÄ±zlÄ± seÃ§im (tek dokunuÅŸ)</div>
    <div class="miniRow" id="quickRow"></div>
  </div>
</div>

<div id="errorGuardBox"><b>Sistem HatasÄ±:</b><br><div id="errorGuardText"></div></div>

<script>
/* FAST_OPS_V1 */
/* MODAL_ONEHAND_V1 */
/* QUICK_QTY_V1 */
/* V12_KOLI_MODE_MODAL_OPAQUE_V2 */
/* V14_FASTOPS_SOLID */
/* V15_UNDO_DELETE_OPS */
/* V16_REPORT_DETAIL_STOCK_CSV */
/* V17_HQ_REPORTS */
/* V18_SINGLE_EXPORT_ALERTS */
/* V19_MANAGER_REPORTS_SAFE */
/* V20_FORECAST_ENGINE */
/* V21_RISK_ENGINE */
/* V22_UI_DECLUTTER */
/* V24_COMPACT_MODE */
/* V25_STOCK_COLOR_SPEED_V2 */
/* V26_TABS_DECLUTTER */
/* V27_DECLUTTER_PRODUCTS_MOVE_HISTORY */
/* V28_ALARM_TAB */
/* V29_CENTER_KPI_REPORT_FILTER */
/* V291_MINT_LIGHT_UI */
/* V292FIX_V291_NAV_VISIBILITY */
/* B_ALARM_7_15_30_V3 */
/* V32_GLOBAL_ACTIVE_PRODUCT */
/* V32_REPORT_FILTER_ACTIVE_PRODUCT + FIX_B15 */
/* V43_SYNC_SELECTS_OPS_FILTER */
/* V44_ALARM_7_15_30 */
/* V45_ALARM_FOLLOWS_ACTIVE_PRODUCT */
/* V46_OPS_FOLLOWS_ACTIVE_PRODUCT */
/* V47_ACTIVE_BADGE_AND_ALARM_FOLLOW */
/* V48B_ALARM_7_15_30_SAFE */
/* V49_ACTIVE_PRODUCT_MASTER */
/* V50_FOCUS_MODE_ACTIVE_PRODUCT */
/* V51_FOCUS_SYNC_BUGFIX */
/* V53_STOP_AUTO_REPORT_AND_TAB_REFRESH */

/* V53_STOP_AUTO_REPORT_AND_TAB_REFRESH */
// ÃœrÃ¼n listesi render olurken raporu otomatik tetikleme (donma Ã¶nleyici)
try{
  if(typeof window.__AUTO_REPORT === "undefined") window.__AUTO_REPORT = false;
}catch(e){}

/* V56_OPS_VIRTUAL_RENDER */
/* V58_ACTIVE_PRODUCT_DRIVES_ALL */
/* V59_FOCUS_TOGGLE_CLEAR_ACTIVE */
/* ====== CORE DB ====== */
// V15: Undo / Delete altyapÄ±sÄ±
function ensureMeta(db){
  if(!db.meta || typeof db.meta!=="object") db.meta={};
  if(!Array.isArray(db.meta.undoStack)) db.meta.undoStack=[];
  return db;
}

function rememberUndo(db){
  ensureMeta(db);
  try{
    const last = (db.ops && db.ops.length) ? db.ops[db.ops.length-1] : null;
    if(last && last.id){
      db.meta.undoStack.push(last.id);
      // ÅŸiÅŸmesin
      if(db.meta.undoStack.length>60) db.meta.undoStack = db.meta.undoStack.slice(-60);
      db.meta.lastOpId = last.id;
    }
  }catch(e){}
}

function removeOpById(db, opId){
  if(!opId) return False
  let idx = -1
  for(let i=0;i<(db.ops||[]).length;i++){
    if(db.ops[i] && db.ops[i].id===opId){ idx=i; break; }
  }
  if(idx<0) return false;

  db.ops.splice(idx,1);

  // undoStackâ€™ten de temizle (tÃ¼m kopyalar)
  ensureMeta(db);
  db.meta.undoStack = (db.meta.undoStack||[]).filter(x=>x!==opId);
  if(db.meta.lastOpId===opId) db.meta.lastOpId = db.meta.undoStack.length ? db.meta.undoStack[db.meta.undoStack.length-1] : null;
  return true;
}

function undoLast(){
  const db=ensureMeta(loadDB());
  const st=db.meta.undoStack||[];
  if(!st.length){
    alert("Geri alÄ±nacak iÅŸlem yok.");
    return;
  }
  const opId = st.pop();
  const ok = removeOpById(db, opId);
  saveDB(db);
  renderProducts();
  if(!ok) alert("Ä°ÅŸlem bulunamadÄ± (zaten silinmiÅŸ olabilir).");
}

function deleteOp(opId, pid){
  const db=ensureMeta(loadDB());
  const ok = removeOpById(db, opId);
  saveDB(db);
  renderProducts();
  // aynÄ± Ã¼rÃ¼nÃ¼n geÃ§miÅŸini tekrar aÃ§ (tek dokunuÅŸla geri dÃ¶nsÃ¼n)
  try{ if(pid) toggleHistory(pid); }catch(e){}
  if(!ok) alert("Silme baÅŸarÄ±sÄ±z (iÅŸlem bulunamadÄ±).");
}


const KEY="stok_kontrol_db_v1";
const $=id=>document.getElementById(id);

function loadDB(){
  let db=null;
  try{ db=JSON.parse(localStorage.getItem(KEY)||"null"); }catch(e){}
  if(!db || typeof db!=="object") db={products:[], ops:[], meta:{v:1}};
  if(!Array.isArray(db.products)) db.products=[];
  if(!Array.isArray(db.ops)) db.ops=[];
  if(!db.meta) db.meta={v:1};
  return db;
}
function saveDB(db){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Date.now().toString(16)+Math.random().toString(16).slice(2); }
function todayISO(){ return new Date().toISOString().slice(0,10); }

/* ====== TYPES (Senin mantÄ±ÄŸÄ±n) ====== */
/*
Artma tetikleri:
- SipariÅŸ (Firma/Depo altÄ±)  -> + (opsiyonel detay)
- DaÄŸÄ±lÄ±m (Normal/Ä°skonto/Insert + kaynak) -> +
Eksilme tetikleri:
- SatÄ±ÅŸ -> -
- SKT -> -
- Ä°ade (MÃ¼ÅŸteri/Tarihi geÃ§miÅŸ/Fabrika/Raf) -> -
*/
const TYPE_DEF = [
  {k:"siparis",  label:"SipariÅŸ (+)", dir:"+", subs:[
    "Firma â€¢ Ziyaret aldÄ±",
    "Firma â€¢ Telefon geldi",
    "Firma â€¢ Telefon ettik",
    "Depo â€¢ Merkez depoya",
    "Depo â€¢ ÅarkÃ¼teri depoya"
  ]},
  {k:"dagilim",  label:"DaÄŸÄ±lÄ±m (+)", dir:"+", subs:[
    "Merkez â€¢ Normal",
    "Merkez â€¢ Ä°skonto",
    "Merkez â€¢ Insert",
    "Insert â€¢ (isim/tarih not'a)"
  ]},
  {k:"satis",    label:"SatÄ±ÅŸ (-)",   dir:"-", subs:[
    "Normal satÄ±ÅŸ",
    "Insert satÄ±ÅŸ",
    "Ä°skonto satÄ±ÅŸ"
  ]},
  {k:"skt",      label:"SKT (-)",     dir:"-", subs:[
    "Tarihi yaklaÅŸan kontrol",
    "Tarihi geÃ§miÅŸ ayrÄ±ldÄ±"
  ]},
  {k:"iade",     label:"Ä°ade (-)",    dir:"-", subs:[
    "MÃ¼ÅŸteri iadesi",
    "Tarihi geÃ§miÅŸ",
    "Fabrika kaynaklÄ±",
    "Raf kaynaklÄ±"
  ]},
];

/* V29_CENTER_KPI_REPORT_FILTER */
let REPORT_PID = ""; // "" => tÃ¼m Ã¼rÃ¼nler

function fillReportFilter(){
  const sel = document.getElementById("reportProdFilter");
  if(!sel) return;

  const db = loadDB();
  const cur = sel.value;

  sel.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "TÃ¼mÃ¼ (genel rapor)";
  sel.appendChild(optAll);

  const __PID = (typeof getActivePid==="function") ? getActivePid() : "";
  const __PRODS = __PID ? (db.products||[]).filter(x=>x.id===__PID) : (db.products||[]);
  for(const p of __PRODS){
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = (p.name||"ÃœrÃ¼n") + "  (id:" + String(p.id||"").slice(0,6) + ")";
    sel.appendChild(opt);
  }

  // mevcut seÃ§imi koru
  if(cur && [...sel.options].some(o=>o.value===cur)){
    sel.value = cur;
    REPORT_PID = cur;
  }else{
    sel.value = "";
    REPORT_PID = "";
  }

  const hint = document.getElementById("reportFilterHint");
  if(hint){
    hint.textContent = REPORT_PID ? "SeÃ§ili Ã¼rÃ¼n" : "TÃ¼mÃ¼";
  }
}

function setCenterKPIs(ops){
  let dist=0, sales=0, ret=0;
  for(const o of (ops||[])){
    const q = Number(o.qty||0);
    if(!q) continue;

    if(o.type==="dagilim" && o.dir==="+") dist += q;
    if(o.type==="satis"   && o.dir==="-" ) sales += q;
    if(o.type==="iade"    && o.dir==="-" ) ret += q;
  }
  const a=document.getElementById("rDist");   if(a) a.textContent=String(dist);
  const b=document.getElementById("rSales");  if(b) b.textContent=String(sales);
  const c=document.getElementById("rReturn"); if(c) c.textContent=String(ret);
}

document.addEventListener("DOMContentLoaded", ()=>{

  /* V48B_ALARM_7_15_30_SAFE */
  try{
    const b7  = document.getElementById("btnAlarm7");
    const b15 = document.getElementById("btnAlarm15");
    const b30 = document.getElementById("btnAlarm30");
    if(b7)  b7.onclick  = ()=> setAlarmDays(7);
    if(b15) b15.onclick = ()=> setAlarmDays(15);
    if(b30) b30.onclick = ()=> setAlarmDays(30);

    let d = 7;
    try{ d = Number(localStorage.getItem("stok_alarm_days")||"7"); }catch(e){ d=7; }
    if(d!==7 && d!==15 && d!==30) d=7;
    setAlarmDays(d);
  }catch(e){}
  // rapor filtresi baÄŸla
  fillReportFilter();

  const sel = document.getElementById("reportProdFilter");
  if(sel){
    sel.addEventListener("change", ()=>{
      REPORT_PID = sel.value || "";
      const hint = document.getElementById("reportFilterHint");
      if(hint) hint.textContent = REPORT_PID ? "SeÃ§ili Ã¼rÃ¼n" : "TÃ¼mÃ¼";

      // son seÃ§ilen pencereye gÃ¶re raporu tazele (btnReport... zaten var)
      try{
        // mevcut butonlarÄ±n state'ini tutmuyoruz; en gÃ¼venlisi: 7g yoksa today Ã§alÄ±ÅŸÄ±r.
        if(document.getElementById("btnReport30") && document.getElementById("btnReport30").classList.contains("alarmBtnOn")) reportForDays(30);
        else reportToday();
      }catch(e){
        try{ reportToday(); }catch(_){}
      }
    });
  }
});


/* V14_FASTOPS_SOLID */
function getProdById(db, pid){
  return (db.products||[]).find(x=>x.id===pid) || null;
}

function pickTypeByDir(dir, preferredKey){
  if(preferredKey){
    const t0 = TYPE_DEF.find(t=>t.k===preferredKey && t.dir===dir);
    if(t0) return t0;
  }
  return TYPE_DEF.find(t=>t.dir===dir) || null;
}

function rememberLastSelection(pid, dir, typeKey, sub){
  const db=loadDB();
  const prod=getProdById(db,pid);
  if(!prod) return;

  if(dir==="+"){
    prod.lastPlusType = typeKey || prod.lastPlusType;
    prod.lastPlusSub  = (sub!==undefined) ? sub : (prod.lastPlusSub||"");
  }else{
    prod.lastMinusType = typeKey || prod.lastMinusType;
    prod.lastMinusSub  = (sub!==undefined) ? sub : (prod.lastMinusSub||"");
  }
  rememberLastSelection(pid, t.dir, t.k, sub);
  saveDB(db);
}

function fastOp(pid, dir, unitMode, qty, packCount, packSize){
  const db=loadDB();
  const prod=getProdById(db,pid);
  if(!prod) return;

  const preferred = (dir==="+") ? prod.lastPlusType : prod.lastMinusType;
  const t = pickTypeByDir(dir, preferred);
  if(!t){ alert("TÃ¼r bulunamadÄ± (TYPE_DEF)."); return; }

  const sub = (dir==="+") ? (prod.lastPlusSub||"") : (prod.lastMinusSub||"");

  db.ops.push({
    id: uid(),
    pid,
    dir: t.dir,
    type: t.k,
    typeLabel: t.label,
    sub: sub,
    note: "",
    qty: qty,
    unitMode: unitMode,
    packCount: packCount || 0,
    packSize: packSize || 0,
    ts: Date.now(),
    day: todayISO()
  });

  
  rememberUndo(db);
rememberLastSelection(pid, dir, t.k, sub);

  saveDB(db);
  renderProducts();
}


/* V12_KOLI_MODE_MODAL_OPAQUE_V2 */
let OP_MODE = "adet"; // "adet" | "koli"

function setMode(mode){
  OP_MODE = mode;

  const bA = $("btnModeAdet"), bK = $("btnModeKoli");
  const wA = $("wrapAdet"), wK = $("wrapKoli");
  if(!bA||!bK||!wA||!wK) return;

  if(mode==="adet"){
    bA.classList.add("modeBtnOn");
    bK.classList.remove("modeBtnOn");
    wA.style.display="";
    wK.style.display="none";
    setTimeout(()=>{ try{$("opQty").focus({preventScroll:true});}catch(e){} }, 60);
  }else{
    bK.classList.add("modeBtnOn");
    bA.classList.remove("modeBtnOn");
    wK.style.display="";
    wA.style.display="none";
    syncPackDefaultsFromProduct();
    buildQuickPackRow();
    updatePackTotal();
    setTimeout(()=>{ try{$("opPackCount").focus({preventScroll:true});}catch(e){} }, 60);
  }
}

function updatePackTotal(){
  const c = parseInt(($("opPackCount")?.value || "0").trim(), 10) || 0;
  const s = parseInt(($("opPackSize")?.value  || "0").trim(), 10) || 0;
  const tot = Math.max(0, c) * Math.max(0, s);
  const out = $("opPackTotal");
  if(out) out.textContent = String(tot);
}

function buildQuickPackRow(){
  const wrap = $("quickPackRow");
  if(!wrap) return;
  wrap.innerHTML="";
  const presets=[1,2,3,4,5];
  for(const n of presets){
    const b=document.createElement("button");
    b.type="button";
    b.className="btn smallBtn";
    b.textContent=String(n)+" koli";
    b.addEventListener("click", ()=>{
      $("opPackCount").value = String(n);
      updatePackTotal();
      try{$("opPackCount").focus({preventScroll:true});}catch(e){}
    });
    wrap.appendChild(b);
  }
}

function syncPackDefaultsFromProduct(){
  const db = loadDB();
  const pid = $("opProd")?.value;
  if(!pid) return;
  const prod = db.products.find(x=>x.id===pid);
  if(!prod) return;

  if(prod.packDefault && !String($("opPackSize")?.value||"").trim()){
    $("opPackSize").value = String(prod.packDefault);
  }
}

function learnPackDefaultToProduct(packSize){
  const n = parseInt(String(packSize||"").trim(),10) || 0;
  if(n<=0) return;

  const db = loadDB();
  const pid = $("opProd")?.value;
  if(!pid) return;
  const prod = db.products.find(x=>x.id===pid);
  if(!prod) return;

  prod.packDefault = n;
  saveDB(db);
}


function computeStock(db, pid){
  let net=0;
  for(const o of db.ops){
    if(o.pid!==pid) continue;
    const qty = Number(o.qty||0);
    if(!qty) continue;
    net += (o.dir==="+" ? qty : -qty);
  }
  return net;
}

/* ====== RENDER PRODUCTS ====== */

/* V24_COMPACT_MODE */
let COMPACT_MODE = true;

function applyCompact(){
  const root=document.body;
  if(COMPACT_MODE){
    root.classList.add("compact");
  }else{
    root.classList.remove("compact");
  }
}

function toggleCompact(){
  COMPACT_MODE=!COMPACT_MODE;
  applyCompact();
}

document.addEventListener("DOMContentLoaded", ()=>{
  applyCompact();
});

/* V25_STOCK_COLOR_SPEED_V2 */
function computeLightCrit(db, pid){
  const net = computeStock(db, pid);

  // son 7 gÃ¼n eksi akÄ±ÅŸ: satis+iade+skt
  const ops7 = (db.ops||[]).filter(o=>{
    if(o.pid!==pid) return false;
    const t = new Date(o.ts||0).getTime();
    return t >= (Date.now() - 7*24*3600*1000);
  });

  let out7=0;
  for(const o of ops7){
    const q=Number(o.qty||0);
    if(!q) continue;
    if(o.dir==="-" && (o.type==="satis" || o.type==="iade" || o.type==="skt")) out7 += q;
  }

  const avg = out7/7;
  const daysLeft = (avg>0) ? (net/avg) : Infinity;

  let level="ok";
  if(net<0) level="red";
  else if(net===0 && avg>0) level="red";
  else if(daysLeft<=3) level="red";
  else if(daysLeft<=7) level="warn";

  return {net, avgDailyOut: avg, daysLeft, level};
}

function stockClassByLevel(level){
  if(level==="red") return "stockRed";
  if(level==="warn") return "stockWarn";
  return "stockGreen";
}

function speedHTMLLight(meta){
  if(!meta) return "";
  if(!meta.avgDailyOut || meta.avgDailyOut<=0) return "";
  return '<div class="miniSpeed">GÃ¼nlÃ¼k Ã§Ä±kÄ±ÅŸ ort: <b>'+meta.avgDailyOut.toFixed(1)+'</b></div>';
}
function renderProducts(){
  const db=loadDB();
  const q=($("inSearch").value||"").trim().toLowerCase();
  const list=$("prodList");
  list.innerHTML="";
  $("pCount").textContent=String(db.products.length);

  let filtered = db.products.filter(p=>!q || (p.name||"").toLowerCase().includes(q));

  
  // V50: odak modunda sadece seÃ§ili Ã¼rÃ¼n
  try{
    const ap = (window.getActivePid ? window.getActivePid() : "");
    if(ap){
      filtered = filtered.filter(x => x && x.id === ap);
    }
  }catch(e){}
if(!filtered.length){
    list.innerHTML = `<div class="item"><div class="hint">ÃœrÃ¼n yok / arama sonucu boÅŸ.</div></div>`;
    fillProdSelect(); // modal select gÃ¼ncel kalsÄ±n
    try{ if(window.__AUTO_REPORT) reportToday(); }catch(e){}
    return;
  }

  const __crit = {};
  for(const p of filtered){
    try{ __crit[p.id]=computeLightCrit(db,p.id); }catch(e){ __crit[p.id]=null; }
    const net = computeStock(db, p.id);
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`
      <div class="itemTop">
        <div style="flex:1">
          <div class="name">${escapeHTML(p.name||"")}</div>
          <div class="muted">ID: ${p.id.slice(0,8)} â€¢ Son: ${new Date(p.ts||Date.now()).toLocaleString("tr-TR")}</div>
        </div>
        <div class="netBox">
          <div class="netBig" title="Net Stok"><span class="${stockClassByLevel((__crit[p.id]&&__crit[p.id].level)||'ok')}">${net}</span></div>
        </div>
      </div>
      <div class="actBar" id="act_${p.id}">
        <div class="actMain">
          <button class="btn smallBtn btnOK" data-act="plus" data-pid="${p.id}" type="button">+ Ä°ÅŸlem</button>
          <button class="btn smallBtn btnBAD" data-act="minus" data-pid="${p.id}" type="button">- Ä°ÅŸlem</button>
          <button class="btn smallBtn" data-act="ops" data-pid="${p.id}" type="button">Ä°ÅŸlemler</button>
          <button class="btn smallBtn btnGhost" data-act="more" data-pid="${p.id}" type="button">â‹¯</button>
        </div>

        <!-- Gizli hÄ±zlÄ± tuÅŸlar (kalabalÄ±ÄŸÄ± bitir) -->
        <div class="actMoreWrap" id="more_${p.id}">
          <button class="btn smallBtn btnOK" data-act="qplus" data-pid="${p.id}" type="button">+1</button>
          <button class="btn smallBtn btnBAD" data-act="qminus" data-pid="${p.id}" type="button">-1</button>

          ${p.packDefault ? `
            <button class="btn smallBtn btnOK" data-act="kPlus1" data-pid="${p.id}" type="button">+1 koli</button>
            <button class="btn smallBtn btnBAD" data-act="kMinus1" data-pid="${p.id}" type="button">-1 koli</button>
            <span class="tag">koli iÃ§i: <b>${p.packDefault}</b></span>
          ` : ``}
        </div>
      </div>

      <!-- V27: History artÄ±k ÃœrÃ¼n kartÄ±nda gÃ¶sterilmeyecek (Ops sekmesine taÅŸÄ±ndÄ±) -->
      <div class="list" id="hist_${p.id}" style="display:none;margin-top:10px"></div>
    `;
    list.appendChild(el);
  }

  // Ã¼rÃ¼n kart aksiyonlarÄ±
  list.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act=btn.getAttribute("data-act");
      const pid=btn.getAttribute("data-pid");
      // V27: geÃ§miÅŸ Ops sekmesine taÅŸÄ±ndÄ±
        if(act==="ops"){
          try{ window.__OPS_FILTER_PID = pid; }catch(e){}
          // Ops sekmesine tÄ±kla
          const b = document.querySelector('#tabsBar .tabBtn[data-tab="ops"]');
          if(b) b.click();
          try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){}
          return;
        }
        if(act==="more"){
          const wrap = document.getElementById("act_"+pid);
          if(wrap) wrap.classList.toggle("showMore");
          return;
        }
      if(act==="qplus"){ quickOp(pid, "+", 1); return; }
      if(act==="qminus"){ quickOp(pid, "-", 1); return; }
      
      // V14 fast ops
      if(act==="aPlus1"){ fastOp(pid, "+", "adet", 1, 0, 0); return; }
      if(act==="aMinus1"){ fastOp(pid, "-", "adet", 1, 0, 0); return; }

      if(act==="kPlus1"){
        const db=loadDB();
        const prod=(db.products||[]).find(x=>x.id===pid);
        const ps = prod && prod.packDefault ? Number(prod.packDefault) : 0;
        if(!ps){ alert("Bu Ã¼rÃ¼nde koli iÃ§i adet yok. Koli modunda bir kez gir ki Ã¶ÄŸrensin."); return; }
        fastOp(pid, "+", "koli", ps, 1, ps);
        return;
      }
      if(act==="kMinus1"){
        const db=loadDB();
        const prod=(db.products||[]).find(x=>x.id===pid);
        const ps = prod && prod.packDefault ? Number(prod.packDefault) : 0;
        if(!ps){ alert("Bu Ã¼rÃ¼nde koli iÃ§i adet yok. Koli modunda bir kez gir ki Ã¶ÄŸrensin."); return; }
        fastOp(pid, "-", "koli", ps, 1, ps);
        return;
      }

openModal(pid, act==="plus" ? "+" : "-");
    });
  });

  fillProdSelect();
  reportToday();
  try{ fillReportFilter(); }catch(e){}
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ====== HISTORY (ÃœrÃ¼n bazlÄ± detay) ====== */
function toggleHistory(pid){
  const db=loadDB();
  const box=$("hist_"+pid);
  if(!box) return;
  const visible = box.style.display!=="none";
  if(visible){ box.style.display="none"; return; }
  box.style.display="block";

  const ops = db.ops.filter(o=>o.pid===pid).sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,60);
  if(!ops.length){
    box.innerHTML = `<div class="item"><div class="hint">Bu Ã¼rÃ¼nde iÅŸlem yok.</div></div>`;
    return;
  }
  box.innerHTML = ops.map(o=>{
    const dt=new Date(o.ts||Date.now()).toLocaleString("tr-TR");
    const sign = o.dir==="+" ? "+" : "-";
    return `
      <div class="item" style="background:rgba(255,255,255,.02)">
        <div class="row" style="justify-content:space-between">
          <div class="name">${sign}${o.qty} â€¢ ${escapeHTML(o.typeLabel||o.type||"")}</div>
          <div class="row" style="gap:8px;align-items:center">
            <div class="tag">${escapeHTML(dt)}</div>
            <button class="btn btnMini btnDel" type="button" data-del="${o.id}" data-pid="${o.pid}">Sil</button>
          </div>
        </div>
        <div class="muted">${escapeHTML(o.sub||"")} ${o.note?(" â€¢ "+escapeHTML(o.note)):""}</div>
      </div>
    `;
  }).join("");

    // V15: Sil butonlarÄ±
    box.querySelectorAll("button[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const opId = b.getAttribute("data-del");
        const pid2 = b.getAttribute("data-pid");
        if(!opId) return;
        if(confirm("Bu iÅŸlemi silmek istiyor musun?")){
          deleteOp(opId, pid2);
        }
      });
    });
}

/* ====== MODAL ====== */
function fillProdSelect(){
  const db=loadDB();
  const sel=$("opProd");
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML="";
  for(const p of db.products){
    const net=computeStock(db,p.id);
    const opt=document.createElement("option");
    opt.value=p.id;
    opt.textContent=`${p.name}  (net:${net})`;
    sel.appendChild(opt);
  }
  if(cur && [...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

function fillTypeSelect(dirHint){
  const tSel=$("opType");
  tSel.innerHTML="";
  for(const t of TYPE_DEF){
    // dirHint varsa filtrele (kart Ã¼zerindeki + / -)
    if(dirHint && t.dir!==dirHint) continue;
    const opt=document.createElement("option");
    opt.value=t.k;
    opt.textContent=t.label;
    tSel.appendChild(opt);
  }
  // default ilk
  tSel.selectedIndex=0;
  fillSubSelect();
  buildQuickRow();
}

function fillSubSelect(){
  const tSel=$("opType");
  const sSel=$("opSub");
  const t=TYPE_DEF.find(x=>x.k===tSel.value);
  sSel.innerHTML="";
  // opsiyonel: boÅŸ seÃ§enek (hÄ±z iÃ§in)
  const none=document.createElement("option");
  none.value="";
  none.textContent="Alt kÄ±rÄ±lÄ±m (opsiyonel)";
  sSel.appendChild(none);

  if(t && Array.isArray(t.subs)){
    for(const sub of t.subs){
      const opt=document.createElement("option");
      opt.value=sub;
      opt.textContent=sub;
      sSel.appendChild(opt);
    }
  }
  sSel.selectedIndex=0;
}

function buildQuickRow(){
  const wrap=$("quickRow");
  wrap.innerHTML="";
  const tSel=$("opType");
  const t=TYPE_DEF.find(x=>x.k===tSel.value);
  if(!t) return;

  // hÄ±zlÄ± alt kÄ±rÄ±lÄ±m chip'leri (tek dokunuÅŸ)
  const arr=(t.subs||[]).slice(0,6);
  for(const sub of arr){
    const b=document.createElement("button");
    b.className="btn smallBtn";
    b.type="button";
    b.textContent=sub.split("â€¢")[0].trim();
    b.title=sub;
    b.addEventListener("click", ()=>{
      $("opSub").value=sub;
    });
    wrap.appendChild(b);
  }
}

/* QUICK_QTY_V1 */
function buildQuickQtyRow(){
  const wrap = $("quickQtyRow");
  if(!wrap) return;
  wrap.innerHTML="";

  const presets = [1,2,3,5,6,10,12,15,20];

  for(const n of presets){
    const b=document.createElement("button");
    b.type="button";
    b.className="btn smallBtn";
    b.textContent = String(n);
    b.title = "Adet = " + n;
    b.addEventListener("click", ()=>{
      $("opQty").value = String(n);
      try{$("opQty").focus({preventScroll:true});}catch(e){}
    });
    wrap.appendChild(b);
  }

  // kÃ¼Ã§Ã¼k dÃ¼zeltme: -1 / +1
  const bMinus=document.createElement("button");
  bMinus.type="button";
  bMinus.className="btn smallBtn btnBAD";
  bMinus.textContent="-1";
  bMinus.title="Adet -1";
  bMinus.addEventListener("click", ()=>{
    const cur = parseInt(($("opQty").value||"0").trim(),10) || 0;
    const next = Math.max(0, cur-1);
    $("opQty").value = String(next);
    try{$("opQty").focus({preventScroll:true});}catch(e){}
  });
  wrap.appendChild(bMinus);

  const bPlus=document.createElement("button");
  bPlus.type="button";
  bPlus.className="btn smallBtn btnOK";
  bPlus.textContent="+1";
  bPlus.title="Adet +1";
  bPlus.addEventListener("click", ()=>{
    const cur = parseInt(($("opQty").value||"0").trim(),10) || 0;
    $("opQty").value = String(cur+1);
    try{$("opQty").focus({preventScroll:true});}catch(e){}
  });
  wrap.appendChild(bPlus);
}



/* FAST_OPS_V1 */
function showToast(msg){
  let t=document.getElementById("toastBox");
  if(!t){
    t=document.createElement("div");
    t.id="toastBox";
    t.style.position="fixed";
    t.style.left="50%";
    t.style.bottom="72px";
    t.style.transform="translateX(-50%)";
    t.style.background="rgba(2,6,23,.92)";
    t.style.border="1px solid rgba(255,255,255,.12)";
    t.style.color="#e5e7eb";
    t.style.padding="10px 12px";
    t.style.borderRadius="14px";
    t.style.fontSize="12px";
    t.style.zIndex="99998";
    t.style.display="none";
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(window.__toastT);
  window.__toastT=setTimeout(()=>{ t.style.display="none"; }, 1200);
}

function buildQtyRow(){
  const wrap=$("qtyRow");
  if(!wrap) return;
  wrap.innerHTML="";
  const nums=[1,2,3,5,10];
  for(const n of nums){
    const b=document.createElement("button");
    b.className="btn smallBtn";
    b.type="button";
    b.textContent=String(n);
    b.addEventListener("click", ()=>{
      $("opQty").value=String(n);
      try{ $("opQty").focus({preventScroll:true}); }catch(e){}
    });
    wrap.appendChild(b);
  }
  // Enter = kaydet (modal iÃ§indeyken)
  const q=$("opQty");
  if(q && !q.__fastBound){
    q.__fastBound=true;
    q.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); addOp(); }
    });
  }
}

// modal her aÃ§Ä±ldÄ±ÄŸÄ±nda qty row hazÄ±r olsun
const __openModal0 = openModal;
openModal = function(pid, dirHint){
  __openModal0(pid, dirHint);
  buildQtyRow();
};

// Kart Ã¼stÃ¼ +1 / -1 hÄ±zlÄ± iÅŸlem
function quickOp(pid, dir, qty){
  const db=loadDB();
  const lc = (db.meta && db.meta.lastChoice) ? db.meta.lastChoice[dir] : null;

  // Ä°lk kezse: kullanÄ±cÄ±ya modal aÃ§tÄ±rÄ±p â€œÅŸablonu Ã¶ÄŸretâ€
  if(!lc || !lc.typeKey){
    showToast("Ä°lk kez: tÃ¼r seÃ§elim");
    openModal(pid, dir);
    return;
  }

  const t=TYPE_DEF.find(x=>x.k===lc.typeKey && x.dir===dir);
  if(!t){
    showToast("Åablon yok: tÃ¼r seÃ§elim");
    openModal(pid, dir);
    return;
  }

  db.ops.push({
    id:uid(),
    pid,
    dir:t.dir,
    type:t.k,
    typeLabel:t.label,
    sub:(lc.sub||""),
    note:"",
    qty:qty,
    unitMode: OP_MODE,
    packCount: packCount,
    packSize: packSize,
    ts:Date.now(),
    day: todayISO()
  });
  
  rememberUndo(db);
saveDB(db);
  renderProducts();
  showToast((dir==="+"?"+":"-")+qty+" kaydedildi");
}


function openModal(pid, dirHint){

  /* V51_SYNC_ACTIVE_TO_MODAL */
  try{
    const g = document.getElementById("globalProdSelect");
    const op = document.getElementById("opProd");
    if(g && op && g.value){
      // EÄŸer openModal pid ile gelmediyse veya pid boÅŸsa, aktif Ã¼rÃ¼nÃ¼ modal'a bas
      if(!pid){
        op.value = g.value;
        pid = g.value;
      }
    }
  }catch(e){}

  $("modal").style.display="block";
  fillProdSelect();
  if(pid) $("opProd").value=pid;
  fillTypeSelect(dirHint);
  try{ buildQuickQtyRow(); }catch(e){}

  // MODAL_ONEHAND_V1: son seÃ§imleri geri yÃ¼kle
  try{
    const db=loadDB();
    const lc = (db.meta && db.meta.lastChoice) ? db.meta.lastChoice[dirHint] : null;

    // pid yoksa son Ã¼rÃ¼nÃ¼ seÃ§
    if(!pid && db.meta && db.meta.lastPid){
      const lp = db.meta.lastPid;
      if($("opProd") && [...$("opProd").options].some(o=>o.value===lp)) $("opProd").value = lp;
    }

    // tÃ¼r/sub otomatik (dirHint'e gÃ¶re)
    if(lc && lc.typeKey){
      if($("opType") && [...$("opType").options].some(o=>o.value===lc.typeKey)){
        $("opType").value = lc.typeKey;
        fillSubSelect();
        if(lc.sub) $("opSub").value = lc.sub;
        buildQuickRow();
      }
    }
  }catch(e){}

  // MODAL_ONEHAND_V1: hÄ±zlÄ± tÃ¼r butonlarÄ±
  try{
    const row=$("fastTypeRow");
    if(row){
      row.innerHTML="";
      const dir=dirHint; // "+" veya "-"
      const list = TYPE_DEF.filter(t=>!dir || t.dir===dir);
      for(const t of list){
        const b=document.createElement("button");
        b.type="button";
        b.className="btn smallBtn " + (t.dir==="+" ? "btnOK" : "btnBAD");
        // kÄ±sa isim:
        const short = t.label.replace(" (+)","").replace(" (-)","").trim();
        b.textContent = (t.dir==="+"?"+ ":"- ") + short;
        b.addEventListener("click", ()=>{
          $("opType").value = t.k;
          fillSubSelect();
          buildQuickRow();
        });
        row.appendChild(b);
      }
    }
  }catch(e){}


  $("opQty").value="";
  if($("opPackCount")) $("opPackCount").value="";
  if($("opPackSize")) $("opPackSize").value="";
  $("opNote").value="";
  try{ setMode("adet"); }catch(e){}
  // flicker Ã¶ldÃ¼rmek iÃ§in agresif autofocus yok:
  setTimeout(()=>{ try{$("opQty").focus({preventScroll:true});}catch(e){} }, 60);
}

function closeModal(){
  $("modal").style.display="none";
}

function addProduct(){
  const name=($("inProd").value||"").trim();
  if(!name){ alert("ÃœrÃ¼n adÄ± yaz."); return; }
  const db=loadDB();
  db.products.push({id:uid(), name, ts:Date.now()});
  saveDB(db);
  $("inProd").value="";
  renderProducts();
  try{$("inProd").focus({preventScroll:true});}catch(e){}
}

function addOp(){
  const pid=$("opProd").value;
  let qty = 0;
  let packCount = 0;
  let packSize = 0;

  if(OP_MODE==="adet"){
    qty = Math.abs(parseInt(($("opQty").value||"").trim(),10))||0;
  }else{
    packCount = Math.abs(parseInt(($("opPackCount").value||"").trim(),10))||0;
    packSize  = Math.abs(parseInt(($("opPackSize").value||"").trim(),10))||0;
    qty = packCount * packSize;
    if(packSize>0) learnPackDefaultToProduct(packSize);
  }
  if(!pid){ alert("ÃœrÃ¼n seÃ§."); return; }
  if(!qty){
    if(OP_MODE==="adet"){
      alert("Adet gir (Ã¶rn 3).");
      $("opQty").focus();
    }else{
      alert("Koli sayÄ±sÄ± ve koli iÃ§i adet gir (Ã¶rn 2 koli Ã— 12).");
      try{$("opPackCount").focus();}catch(e){}
    }
    return;
  }

  const tKey=$("opType").value;
  const t=TYPE_DEF.find(x=>x.k===tKey);
  if(!t){ alert("TÃ¼r seÃ§."); return; }

  const db=loadDB();
  const sub=($("opSub").value||"").trim();
  const note=($("opNote").value||"").trim();

  db.ops.push({
    id:uid(),
    pid,
    dir:t.dir,
    type:t.k,
    typeLabel:t.label,
    sub:sub,
    note:note,
    qty:qty,
    unitMode: OP_MODE,
    packCount: packCount,
    packSize: packSize,
    ts:Date.now(),
    day: todayISO()
  });
  
  
  rememberUndo(db);
// FAST_OPS_V1: son seÃ§im (dir/type/sub) hafÄ±zasÄ±
  try{
    if(!db.meta) db.meta={v:1};
    if(!db.meta.lastChoice) db.meta.lastChoice={};
    const dir = t.dir; // "+" / "-"
    db.meta.lastChoice[dir] = { typeKey: t.k, sub: sub || "" };
  }catch(e){}

  // MODAL_ONEHAND_V1: son Ã¼rÃ¼n (pid) hafÄ±zasÄ±
  try{
    if(!db.meta) db.meta={v:1};
    db.meta.lastPid = pid;
  }catch(e){}

saveDB(db);
  closeModal();
  renderProducts();
}

/* ====== REPORT / ANALYTICS ====== */
function opsInDays(db, days){
  const now = new Date();
  const from = new Date(now.getTime() - days*24*3600*1000);
  return db.ops.filter(o=>{
    const d = new Date(o.ts||0);
    return d>=from;
  });
}
/* V55_REPORT_OPTIMIZED */
function reportForDays(days){
  let db = loadDB();
  if(window.applyActivePidFilter) db = window.applyActivePidFilter(db);
  let ops=opsInDays(db, days);

// V55: Ã¼rÃ¼n map (find() maliyetini dÃ¼ÅŸÃ¼r)
const __prodMap = new Map();
for(const pp of (db.products||[])){
  if(pp && pp.id) __prodMap.set(pp.id, pp);
}
  // V29: Ã¼rÃ¼n filtresi
  if(typeof REPORT_PID==='string' && REPORT_PID){ ops = ops.filter(o=>o.pid===REPORT_PID); }
  try{ setCenterKPIs(ops); }catch(e){}
  let plus=0, minus=0;
  for(const o of ops){
    const q=Number(o.qty||0);
    if(o.dir==="+") plus+=q; else minus+=q;
  }
  $("rPlus").textContent=String(plus);
  $("rMinus").textContent=String(minus);
  $("rNet").textContent=String(plus - minus);

  // Top Ã¼rÃ¼nler
  const m=new Map();
  for(const o of ops){
    const p=__prodMap.get(o.pid);
    if(!p) continue;
    const key=p.id;
    const cur=m.get(key)||{name:p.name, score:0, plus:0, minus:0};
    if(o.dir==="+"){cur.plus+=Number(o.qty||0)}else{cur.minus+=Number(o.qty||0)}
    cur.score += Number(o.qty||0);
    m.set(key,cur);
  }
  const top=[...m.values()].sort((a,b)=>(b.plus+b.minus)-(a.plus+a.minus)).slice(0,60);
  $("rTop").innerHTML = top.length ? top.map(x=>`
    <div class="item">
      <div class="row" style="justify-content:space-between">
        <div class="name">${escapeHTML(x.name)}</div>
        <div class="tag">net ${x.plus-x.minus}</div>
      </div>
      <div class="muted">+${x.plus} / -${x.minus}</div>
    </div>
  `).join("") : `<div class="item"><div class="hint">Bu aralÄ±kta veri yok.</div></div>`;

  // TÃ¼r daÄŸÄ±lÄ±mÄ±
  const tm=new Map();
  for(const o of ops){
    const k=o.typeLabel||o.type||"";
    tm.set(k, (tm.get(k)||0) + Number(o.qty||0));
  }
  const trows=[...tm.entries()].sort((a,b)=>b[1]-a[1]).slice(0,60);
  $("rTypes").innerHTML = trows.length ? trows.map(([k,v])=>`
    <div class="item">
      <div class="row" style="justify-content:space-between">
        <div class="name">${escapeHTML(k)}</div>
        <div class="tag">${v}</div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="hint">TÃ¼r verisi yok.</div></div>`;

  // â€œAkÄ±lâ€ (basit, donmayan)
  const brain=[];
  if(ops.length===0) brain.push("Veri yok: Ã¶nce iÅŸlem gir.");
  if(minus>plus) brain.push("ğŸŸ¥ Eksilme artÄ±dan fazla: satÄ±ÅŸ/skt/iade baskÄ±n.");
  if(plus>0 && minus===0) brain.push("ğŸŸ§ Sadece artÄ±ÅŸ var: daÄŸÄ±lÄ±m/sipariÅŸ girilmiÅŸ, satÄ±ÅŸ yok.");
  if(plus-minus<0) brain.push("ğŸŸ¥ Net negatif: stok aÃ§Ä±ÄŸÄ±/yanlÄ±ÅŸ kayÄ±t ihtimali.");
  if(brain.length===0) brain.push("ğŸŸ© Stabil: kritik sinyal yok.");
  $("rBrain").innerHTML = brain.map(t=>`<div class="item"><div class="name">${escapeHTML(t)}</div></div>`).join("");
}

/* V16_REPORT_DETAIL_STOCK_CSV */
let REPORT_LAST_DAYS = 1;

function fmtInt(n){
  try{ return String(Math.trunc(Number(n)||0)); }catch(e){ return "0"; }
}

function typeLabelByKey(k){
  const t = (typeof TYPE_DEF!=="undefined") ? TYPE_DEF.find(x=>x.k===k) : null;
  return t ? (t.label || k) : k;
}

function computeTypeTotals(db, ops){
  // tÃ¼r bazlÄ± + / - ve net
  const out = new Map(); // typeKey -> {label, dirPlus, dirMinus}
  for(const o of ops){
    const k = o.type || "";
    if(!k) continue;
    const cur = out.get(k) || {label: (o.typeLabel||typeLabelByKey(k)||k), plus:0, minus:0};
    const q = Number(o.qty||0);
    if(o.dir==="+") cur.plus += q; else cur.minus += q;
    out.set(k, cur);
  }
  return [...out.entries()].map(([k,v])=>({k, ...v, net:(v.plus-v.minus)}))
    .sort((a,b)=> (Math.abs(b.plus)+Math.abs(b.minus)) - (Math.abs(a.plus)+Math.abs(a.minus)));
}

function computeSubTotals(db, ops){
  // alt kÄ±rÄ±lÄ±m: typeLabel + sub
  const out = new Map(); // key -> qty
  for(const o of ops){
    const t = (o.typeLabel||typeLabelByKey(o.type)||o.type||"TÃ¼r");
    const sub = (o.sub||"").trim() || "Alt yok";
    const key = t + " :: " + sub;
    out.set(key, (out.get(key)||0) + Number(o.qty||0));
  }
  return [...out.entries()].map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
}

function renderTypeTotals(rows){
  const box = $("rTypeTotals");
  if(!box) return;
  if(!rows.length){
    box.innerHTML = `<div class="miniLine"><div class="hint">Detay veri yok.</div></div>`;
    return;
  }
  box.innerHTML = rows.slice(0,12).map(r=>`
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">${escapeHTML(r.label||r.k)}</div>
        <div class="badge">net <b>${fmtInt(r.net)}</b></div>
      </div>
      <div class="rTiny">+${fmtInt(r.plus)} / -${fmtInt(r.minus)}</div>
    </div>
  `).join("");
}

function renderSubTotals(rows){
  const box = $("rSubTotals");
  if(!box) return;
  if(!rows.length){
    box.innerHTML = `<div class="miniLine"><div class="hint">Alt kÄ±rÄ±lÄ±m veri yok.</div></div>`;
    return;
  }
  box.innerHTML = rows.slice(0,18).map(r=>{
    const parts = String(r.k).split(" :: ");
    const t = parts[0] || "TÃ¼r";
    const sub = parts.slice(1).join(" :: ") || "Alt yok";
    return `
      <div class="miniLine">
        <div class="rRow">
          <div style="flex:1">
            <div class="rKey">${escapeHTML(sub)}</div>
            <div class="rTiny">${escapeHTML(t)}</div>
          </div>
          <div class="badge"><b>${fmtInt(r.v)}</b></div>
        </div>
      </div>
    `;
  }).join("");
}

function renderStockNow(){
  const box = $("rStockNow");
  if(!box) return;

  const db = loadDB();
  const arr = (db.products||[]).map(p=>{
    const net = computeStock(db, p.id);
    return {name:p.name||"", id:p.id, net};
  }).sort((a,b)=> b.net - a.net);

  if(!arr.length){
    box.innerHTML = `<div class="miniLine"><div class="hint">ÃœrÃ¼n yok.</div></div>`;
    return;
  }

  box.innerHTML = arr.slice(0,25).map(x=>`
    <div class="miniLine">
      <div class="rRow">
        <div class="rKey">${escapeHTML(x.name)}</div>
        <div class="badge">stok <b>${fmtInt(x.net)}</b></div>
      </div>
      <div class="rTiny">ID: ${escapeHTML(String(x.id||"").slice(0,8))}</div>
    </div>
  `).join("");
}

function exportOpsCSV(days){
  const db = loadDB();
  const ops = opsInDays(db, days).sort((a,b)=>(b.ts||0)-(a.ts||0));

  const header = ["ts","date","product","dir","type","sub","qty","unitMode","packCount","packSize","note"];
  const lines = [header.join(",")];

  const pmap = new Map((db.products||[]).map(p=>[p.id, p.name||""]));

  function esc(v){
    const s = String(v??"").replace(/"/g,'""');
    return `"${s}"`;
  }

  for(const o of ops){
    const dt = new Date(o.ts||0);
    const row = [
      dt.toISOString(),
      (o.day||dt.toISOString().slice(0,10)),
      (pmap.get(o.pid)||""),
      (o.dir||""),
      (o.typeLabel||o.type||""),
      (o.sub||""),
      (o.qty||0),
      (o.unitMode||""),
      (o.packCount||0),
      (o.packSize||0),
      (o.note||""),
    ].map(esc);
    lines.push(row.join(","));
  }

  const csv = lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `stok_kontrol_ops_${days}g_${todayISO()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(e){} }, 2000);
}

// reportForDays'e â€œdetay renderâ€ hook
const _reportForDays_V16 = reportForDays;
reportForDays = function(days){
  REPORT_LAST_DAYS = days;
  _reportForDays_V16(days);
  const db = loadDB();
  const ops = opsInDays(db, days);
  renderTypeTotals(computeTypeTotals(db, ops));
  renderSubTotals(computeSubTotals(db, ops));
  renderStockNow();
};

document.addEventListener("DOMContentLoaded", ()=>{
  if($("btnCSV")){
    $("btnCSV").onclick = ()=> exportOpsCSV(REPORT_LAST_DAYS || 1);
  }
});


function reportToday(){ reportForDays(1); }

/* ====== ERROR GUARD ====== */
(function(){
  function showError(msg){
    const box=$("errorGuardBox");
    const txt=$("errorGuardText");
    if(!box||!txt) return;
    box.style.display="block";
    txt.textContent=msg;
  }
  window.addEventListener("error", e=> showError((e.message||"Hata") + " @ " + (e.filename||"") + ":" + (e.lineno||"")));
  window.addEventListener("unhandledrejection", e=> showError("Promise Error: " + (e.reason?.message || e.reason)));
})();

/* ====== EVENTS ====== */
$("btnAddProd").onclick=addProduct;
$("inProd").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addProduct(); }});
$("btnAddOp").onclick=()=>openModal(null,null);
$("btnClose").onclick=closeModal;
$("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal(); });

$("opType").addEventListener("change", ()=>{ fillSubSelect(); buildQuickRow(); });
$("btnSaveOp").onclick=addOp;

$("btnClearSearch").onclick=()=>{ $("inSearch").value=""; renderProducts(); };
$("inSearch").addEventListener("input", ()=>renderProducts());

$("btnReportToday").onclick=()=>reportToday();
$("btnReport7").onclick=()=>reportForDays(7);
$("btnReport30").onclick=()=>reportForDays(30);

// Skor test (debug): kritik deÄŸilse â€œ0â€ gibi davranÄ±r â†’ burada basit Ã§Ä±ktÄ± gÃ¶steriyoruz
$("btnSkorTest").onclick=()=>{
  const db=loadDB();
  if(!db.products.length){ alert("Ã–nce Ã¼rÃ¼n ekle."); return; }
  const pid=db.products[0].id;
  const net=computeStock(db,pid);
  alert("Skor Test âœ…\n\nÄ°lk Ã¼rÃ¼n: "+db.products[0].name+"\nNet: "+net+"\n\nNot: Skor sistemi kritik sinyal yoksa 'stabil' sayar.");
};

(function boot(){
  $("chipMeta").textContent = "LocalStorage â€¢ " + KEY;
  renderProducts();
  reportToday();
  // agresif autofocus yok: flicker riskini azaltÄ±r
})();

/* V12_BINDINGS */
document.addEventListener("DOMContentLoaded", ()=>{
    if($("btnUndo")) $("btnUndo").onclick = undoLast;
if($("btnModeAdet")) $("btnModeAdet").onclick = ()=> setMode("adet");
  if($("btnModeKoli")) $("btnModeKoli").onclick = ()=> setMode("koli");

  if($("opPackCount")) $("opPackCount").addEventListener("input", updatePackTotal);
  if($("opPackSize"))  $("opPackSize").addEventListener("input", updatePackTotal);

  if($("opProd")) $("opProd").addEventListener("change", ()=>{
    if(OP_MODE==="koli") syncPackDefaultsFromProduct();
    updatePackTotal();
  });

  // aÃ§Ä±lÄ±ÅŸta adet modu
  try{ setMode("adet"); }catch(e){}
});



/* V18_SINGLE_EXPORT_ALERTS */
let REPORT_DAYS = 1;

function fmtInt(n){ try{return String(Math.trunc(Number(n)||0));}catch(e){return "0";} }

function csvEsc(v){
  const s = String(v==null? "" : v);
  if(/[,"\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}

function exportCSV(){
  const db = loadDB();
  const ops = opsInDays(db, REPORT_DAYS);

  const headerOps = ["ts","day","product","dir","type","sub","qty","unitMode","packCount","packSize","note"];
  const rowsOps = [headerOps.join(",")];

  for(const o of ops){
    const prod = (db.products||[]).find(p=>p.id===o.pid);
    const name = prod ? prod.name : ("#"+String(o.pid||"").slice(0,8));
    const ts = new Date(o.ts||Date.now()).toISOString();
    const day = o.day || ts.slice(0,10);
    rowsOps.push([
      csvEsc(ts),
      csvEsc(day),
      csvEsc(name),
      csvEsc(o.dir||""),
      csvEsc(o.typeLabel||o.type||""),
      csvEsc(o.sub||""),
      csvEsc(o.qty||0),
      csvEsc(o.unitMode||""),
      csvEsc(o.packCount||0),
      csvEsc(o.packSize||0),
      csvEsc(o.note||"")
    ].join(","));
  }

  // stok snapshot
  const headerP = ["product","net","packDefault"];
  const rowsP = [headerP.join(",")];
  for(const p of (db.products||[])){
    const net = computeStock(db, p.id);
    rowsP.push([csvEsc(p.name||""), csvEsc(net), csvEsc(p.packDefault||"")].join(","));
  }

  const stamp = new Date().toISOString().replace(/[:.]/g,"-");
  downloadText("stok_kontrol_ops_"+REPORT_DAYS+"g_"+stamp+".csv", rowsOps.join("\n"));
  downloadText("stok_kontrol_stok_"+stamp+".csv", rowsP.join("\n"));
}

function exportPDFPrint(){
  // PDF iÃ§in en stabil yol: tarayÄ±cÄ± yazdÄ±r (Firefox/Chrome -> PDF kaydet)
  document.body.classList.add("single"); // Ã§Ä±ktÄ±da tek sayfa dÃ¼zeni
  setTimeout(()=>window.print(), 60);
}

function setSingleMode(on){
  if(on) document.body.classList.add("single");
  else document.body.classList.remove("single");
  try{
    localStorage.setItem("stok_kontrol_single_mode", on ? "1" : "0");
  }catch(e){}
}

function initSingleMode(){
  try{
    const v = localStorage.getItem("stok_kontrol_single_mode");
    setSingleMode(v==="1");
  }catch(e){}
}

function computeAlerts(db, ops, days){
  const alerts=[];

  // 1) Net stok negatif olan Ã¼rÃ¼nler (tÃ¼mÃ¼)
  for(const p of (db.products||[])){
    const net = computeStock(db, p.id);
    if(net < 0){
      alerts.push({lvl:"red", text:`ğŸŸ¥ Stok aÃ§Ä±ÄŸÄ±: ${p.name} (net ${net})`});
    }
  }

  // 2) Insert dÃ¶nÃ¼ÅŸÃ¼m dÃ¼ÅŸÃ¼k (seÃ§ili aralÄ±k)
  const insD = ops.filter(o=>o.type==="dagilim" && String(o.sub||"").toLowerCase().includes("insert"));
  const insS = ops.filter(o=>o.type==="satis"   && String(o.sub||"").toLowerCase().includes("insert"));
  const dTot = insD.reduce((a,o)=>a+Number(o.qty||0),0);
  const sTot = insS.reduce((a,o)=>a+Number(o.qty||0),0);
  if(dTot>0){
    const ratio = sTot/dTot;
    if(ratio < 0.35) alerts.push({lvl:"red", text:`ğŸŸ¥ Insert zayÄ±f: dÃ¶nÃ¼ÅŸÃ¼m %${Math.round(ratio*100)} (daÄŸÄ±lÄ±m ${dTot} / satÄ±ÅŸ ${sTot})`});
    else if(ratio < 0.60) alerts.push({lvl:"amber", text:`ğŸŸ§ Insert orta: dÃ¶nÃ¼ÅŸÃ¼m %${Math.round(ratio*100)} (daÄŸÄ±lÄ±m ${dTot} / satÄ±ÅŸ ${sTot})`});
  }

  // 3) Ä°ade yÃ¼ksek (seÃ§ili aralÄ±k) â€” satÄ±ÅŸa oranla kaba sinyal
  const ret = ops.filter(o=>o.type==="iade").reduce((a,o)=>a+Number(o.qty||0),0);
  const sal = ops.filter(o=>o.type==="satis").reduce((a,o)=>a+Number(o.qty||0),0);
  if(ret>0 && sal>0){
    const r = ret/sal;
    if(r >= 0.20) alerts.push({lvl:"red", text:`ğŸŸ¥ Ä°ade oranÄ± yÃ¼ksek: %${Math.round(r*100)} (iade ${ret} / satÄ±ÅŸ ${sal})`});
    else if(r >= 0.10) alerts.push({lvl:"amber", text:`ğŸŸ§ Ä°ade dikkat: %${Math.round(r*100)} (iade ${ret} / satÄ±ÅŸ ${sal})`});
  }else if(ret>0 && sal==0){
    alerts.push({lvl:"amber", text:`ğŸŸ§ Ä°ade var ama satÄ±ÅŸ yok (iade ${ret}). KayÄ±t/akÄ±ÅŸ kontrol.`});
  }

  // 4) Sadece artÄ±ÅŸ var (daÄŸÄ±lÄ±m/sipariÅŸ) ama satÄ±ÅŸ yok
  const plus = ops.filter(o=>o.dir==="+").reduce((a,o)=>a+Number(o.qty||0),0);
  const minus= ops.filter(o=>o.dir==="-").reduce((a,o)=>a+Number(o.qty||0),0);
  if(plus>0 && minus==0) alerts.push({lvl:"amber", text:`ğŸŸ§ Sadece artÄ±ÅŸ var (sipariÅŸ/daÄŸÄ±lÄ±m). SatÄ±ÅŸ kaydÄ± yok.`});

  // 5) Her ÅŸey sakin
  if(alerts.length==0) alerts.push({lvl:"green", text:"ğŸŸ© Kritik alarm yok (ÅŸimdilik)."});
  return alerts.slice(0,10);
}

function renderAlerts(db, ops, days){
  const box = $("rAlerts");
  if(!box) return;
  const arr = computeAlerts(db, ops, days);

  box.innerHTML = arr.map(a=>{
    const cls = a.lvl==="red" ? "alertRed" : (a.lvl==="amber" ? "alertAmber" : "alertGreen");
    return `<div class="miniLine ${cls}"><div class="rRow"><div class="rKey">${escapeHTML(a.text)}</div></div></div>`;
  }).join("");
}

// reportForDays hook: gÃ¼n etiketi + alarm render
const _reportForDays_V18 = reportForDays;
reportForDays = function(days){
  REPORT_DAYS = Number(days)||1;
  _reportForDays_V18(days);

  const lbl = $("rDaysLbl");
  if(lbl) lbl.textContent = String(REPORT_DAYS);

  const db = loadDB();
  const ops = opsInDays(db, REPORT_DAYS);
  renderAlerts(db, ops, REPORT_DAYS);
};

// UI baÄŸlama
document.addEventListener("DOMContentLoaded", ()=>{
  initSingleMode();

  const btn = $("btnSingle");
  if(btn){
    btn.addEventListener("click", ()=>{
      const on = !document.body.classList.contains("single");
      setSingleMode(on);
      btn.textContent = on ? "Ã‡ift Kolon" : "Tek Ekran";
    });
    // ilk yazÄ±
    btn.textContent = document.body.classList.contains("single") ? "Ã‡ift Kolon" : "Tek Ekran";
  }

  if($("btnExportCSV")) $("btnExportCSV").addEventListener("click", exportCSV);
  if($("btnExportPDF")) $("btnExportPDF").addEventListener("click", exportPDFPrint);

  // sayfa aÃ§Ä±lÄ±r aÃ§Ä±lmaz: alarm + gÃ¼n etiketi doÄŸru olsun
  try{ const db=loadDB(); const ops=opsInDays(db, REPORT_DAYS); renderAlerts(db, ops, REPORT_DAYS); }catch(e){}
});


/* V19_MANAGER_REPORTS_SAFE */

function renderManagerPanels(days){
  const db = loadDB();
  const ops = opsInDays(db, days);

  const salesBox = $("rSalesProducts");
  const insertBox = $("rInsertPerf");
  const returnBox = $("rReturnReasons");

  if(salesBox){
    const map = {};
    ops.forEach(o=>{
      if(o.type==="satis"){
        map[o.pid] = (map[o.pid]||0) + Number(o.qty||0);
      }
    });

    const rows = Object.entries(map)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,10)
      .map(([pid,qty])=>{
        const p = (db.products||[]).find(x=>x.id===pid);
        const name = p ? p.name : pid;
        return "<div>"+name+" â†’ <b>"+qty+"</b></div>";
      }).join("");

    salesBox.innerHTML = rows || "<div class='hint'>SatÄ±ÅŸ yok</div>";
  }

  if(insertBox){
    const map = {};
    ops.forEach(o=>{
      if(o.type==="dagilim" && String(o.sub||"").toLowerCase().includes("insert")){
        map[o.pid] = map[o.pid] || {d:0,s:0};
        map[o.pid].d += Number(o.qty||0);
      }
      if(o.type==="satis" && String(o.sub||"").toLowerCase().includes("insert")){
        map[o.pid] = map[o.pid] || {d:0,s:0};
        map[o.pid].s += Number(o.qty||0);
      }
    });

    const rows = Object.entries(map)
      .map(([pid,obj])=>{
        const p = (db.products||[]).find(x=>x.id===pid);
        const name = p ? p.name : pid;
        const ratio = obj.d>0 ? Math.round((obj.s/obj.d)*100) : 0;
        return "<div>"+name+" â†’ %"+ratio+" ("+obj.s+"/"+obj.d+")</div>";
      }).join("");

    insertBox.innerHTML = rows || "<div class='hint'>Insert verisi yok</div>";
  }

  if(returnBox){
    const map = {};
    ops.forEach(o=>{
      if(o.type==="iade"){
        const sub = o.sub || "DiÄŸer";
        map[sub] = (map[sub]||0) + Number(o.qty||0);
      }
    });

    const rows = Object.entries(map)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,10)
      .map(([sub,qty])=>{
        return "<div>"+sub+" â†’ <b>"+qty+"</b></div>";
      }).join("");

    returnBox.innerHTML = rows || "<div class='hint'>Ä°ade yok</div>";
  }
}

const _reportForDays_V19_SAFE = reportForDays;
reportForDays = function(days){
  _reportForDays_V19_SAFE(days);
  try{ renderManagerPanels(days); }catch(e){}
};

document.addEventListener("DOMContentLoaded", ()=>{
  try{ renderManagerPanels(1); }catch(e){}
});



/* V20_FORECAST_ENGINE */

function getLastNDaysOps(db, pid, n){
  const now = new Date();
  const arr=[];
  for(let i=0;i<n;i++){
    const d = new Date(now.getTime()-i*24*3600*1000);
    const key = d.toISOString().slice(0,10);
    const total = db.ops
      .filter(o=>o.pid===pid && o.type==="satis")
      .filter(o=>{
        const day = o.day || new Date(o.ts||0).toISOString().slice(0,10);
        return day===key;
      })
      .reduce((a,o)=>a+Number(o.qty||0),0);
    arr.push(total);
  }
  return arr;
}

function computeForecast(){
  const db = loadDB();
  const result = [];

  for(const p of (db.products||[])){

    const net = computeStock(db, p.id);

    const last7 = getLastNDaysOps(db, p.id, 7);
    const avg7 = last7.reduce((a,b)=>a+b,0)/7;
    const dailyAvg = avg7;

    const daysLeft = dailyAvg>0 ? (net/dailyAvg) : 999;

    const insertDist = db.ops.filter(o=>o.pid===p.id && o.type==="dagilim" && String(o.sub||"").toLowerCase().includes("insert"));
    const insertSales = db.ops.filter(o=>o.pid===p.id && o.type==="satis" && String(o.sub||"").toLowerCase().includes("insert"));

    const insD = insertDist.reduce((a,o)=>a+Number(o.qty||0),0);
    const insS = insertSales.reduce((a,o)=>a+Number(o.qty||0),0);

    const insertRatio = insD>0 ? (insS/insD) : 0;

    const returns = db.ops.filter(o=>o.pid===p.id && o.type==="iade")
      .reduce((a,o)=>a+Number(o.qty||0),0);

    const totalSales = db.ops.filter(o=>o.pid===p.id && o.type==="satis")
      .reduce((a,o)=>a+Number(o.qty||0),0);

    const returnRate = totalSales>0 ? (returns/totalSales) : 0;

    result.push({
      name: p.name,
      net,
      avg7: Math.round(avg7),
      daysLeft: Math.round(daysLeft),
      insertRatio: Math.round(insertRatio*100),
      returnRate: Math.round(returnRate*100)
    });
  }

  renderForecast(result);
}

function renderForecast(rows){
  let box = document.getElementById("rForecast");
  if(!box){
    const container = document.createElement("div");
    container.innerHTML = `
      <div class="hr"></div>
      <div class="hint">Tahmin Motoru (Forecast + Risk)</div>
      <div id="rForecast" class="card"></div>
    `;
    document.getElementById("cardReport").appendChild(container);
    box = document.getElementById("rForecast");
  }

  if(rows.length===0){
    box.innerHTML="<div class='hint'>Veri yok</div>";
    return;
  }

  box.innerHTML = rows.map(r=>`
    <div style="padding:10px;border-bottom:1px solid var(--line)">
      <b>${r.name}</b><br>
      Stok: ${r.net} |
      7g Ort: ${r.avg7} |
      Tahmini bitiÅŸ: ${r.daysLeft} gÃ¼n |
      Insert %: ${r.insertRatio} |
      Ä°ade %: ${r.returnRate}
    </div>
  `).join("");
}

const _reportForDays_V20 = reportForDays;
reportForDays = function(days){
  _reportForDays_V20(days);
  try{ computeForecast(); }catch(e){}
};

document.addEventListener("DOMContentLoaded", ()=>{
  try{ computeForecast(); }catch(e){}
});



/* V21_RISK_ENGINE */

function computeRiskScore(row){
  let score = 0;

  if(row.daysLeft <= 3) score += 40;
  else if(row.daysLeft <= 7) score += 20;

  if(row.insertRatio < 40) score += 20;

  if(row.returnRate > 15) score += 20;

  if(row.avg7 === 0 && row.net > 0) score += 10;

  return score;
}

function renderRiskPanel(rows){

  let box = document.getElementById("rRisk");
  if(!box){
    const container = document.createElement("div");
    container.innerHTML = `
      <div class="hr"></div>
      <div class="hint">Risk Motoru</div>
      <div id="rRisk" class="card"></div>
    `;
    document.getElementById("cardReport").appendChild(container);
    box = document.getElementById("rRisk");
  }

  if(rows.length===0){
    box.innerHTML = "<div class='hint'>Risk verisi yok</div>";
    return;
  }

  box.innerHTML = rows.map(r=>{
    const score = computeRiskScore(r);

    let level = "ğŸŸ¢ Stabil";
    if(score >= 60) level = "ğŸ”´ Kritik";
    else if(score >= 30) level = "ğŸŸ  Dikkat";

    return `
      <div style="padding:10px;border-bottom:1px solid var(--line)">
        <b>${r.name}</b><br>
        Risk Skor: <b>${score}</b> â€” ${level}
      </div>
    `;
  }).join("");
}

const _computeForecast_V21 = computeForecast;
computeForecast = function(){
  _computeForecast_V21();
  try{
    const db = loadDB();
    const rows = [];
    for(const p of (db.products||[])){
      const net = computeStock(db, p.id);
      const last7 = getLastNDaysOps(db, p.id, 7);
      const avg7 = last7.reduce((a,b)=>a+b,0)/7;
      const dailyAvg = avg7;
      const daysLeft = dailyAvg>0 ? (net/dailyAvg) : 999;

      const insertDist = db.ops.filter(o=>o.pid===p.id && o.type==="dagilim" && String(o.sub||"").toLowerCase().includes("insert"));
      const insertSales = db.ops.filter(o=>o.pid===p.id && o.type==="satis" && String(o.sub||"").toLowerCase().includes("insert"));
      const insD = insertDist.reduce((a,o)=>a+Number(o.qty||0),0);
      const insS = insertSales.reduce((a,o)=>a+Number(o.qty||0),0);
      const insertRatio = insD>0 ? (insS/insD)*100 : 0;

      const returns = db.ops.filter(o=>o.pid===p.id && o.type==="iade")
        .reduce((a,o)=>a+Number(o.qty||0),0);

      const totalSales = db.ops.filter(o=>o.pid===p.id && o.type==="satis")
        .reduce((a,o)=>a+Number(o.qty||0),0);

      const returnRate = totalSales>0 ? (returns/totalSales)*100 : 0;

      rows.push({
        name: p.name,
        net,
        avg7: Math.round(avg7),
        daysLeft: Math.round(daysLeft),
        insertRatio: Math.round(insertRatio),
        returnRate: Math.round(returnRate)
      });
    }

    renderRiskPanel(rows);
  }catch(e){}
};



/* V22_UI_DECLUTTER */
(function(){
  const KEY_COMPACT = "stok_view_compact_v1";
  const KEY_DETAILS = "stok_view_details_v1"; // 1=detay aÃ§Ä±k

  function setBodyFlags(){
    const compact = localStorage.getItem(KEY_COMPACT) === "1";
    const details = localStorage.getItem(KEY_DETAILS) === "1";

    document.body.classList.toggle("compact", compact);
    document.body.classList.toggle("hideDetails", !details);

    const bC = document.getElementById("btnCompact");
    const bD = document.getElementById("btnDetails");
    if(bC) bC.classList.toggle("on", compact);
    if(bD) bD.classList.toggle("on", details);

    if(bC) bC.textContent = compact ? "Kompakt âœ“" : "Kompakt";
    if(bD) bD.textContent = details ? "Detay âœ“" : "Detay";
  }

  function toggleCompact(){
    const cur = localStorage.getItem(KEY_COMPACT) === "1";
    localStorage.setItem(KEY_COMPACT, cur ? "0" : "1");
    setBodyFlags();
  }

  function toggleDetails(){
    const cur = localStorage.getItem(KEY_DETAILS) === "1";
    localStorage.setItem(KEY_DETAILS, cur ? "0" : "1");
    setBodyFlags();
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    // default: kompakt aÃ§Ä±k, detay kapalÄ±
    if(localStorage.getItem(KEY_COMPACT) === null) localStorage.setItem(KEY_COMPACT, "1");
    if(localStorage.getItem(KEY_DETAILS) === null) localStorage.setItem(KEY_DETAILS, "0");

    const bC = document.getElementById("btnCompact");
    const bD = document.getElementById("btnDetails");
    if(bC) bC.addEventListener("click", toggleCompact);
    if(bD) bD.addEventListener("click", toggleDetails);

    setBodyFlags();
  });
})();


/* V26_TABS_DECLUTTER */
(function(){
  const TABKEY = "stok_kontrol_tab_v26";

  function setHint(tab){
    const h = document.getElementById("tabHint");
    if(!h) return;
    if(tab==="products") h.textContent = "ÃœrÃ¼n ekranÄ±: Ã¼rÃ¼n ekle/ara + stok kartlarÄ± + hÄ±zlÄ± iÅŸlem";
    else if(tab==="report") h.textContent = "Rapor ekranÄ±: 1g/7g/30g Ã¶zet + yÃ¶netici bakÄ±ÅŸÄ±";
    else if(tab==="ops") h.textContent = "Ä°ÅŸlemler ekranÄ±: son iÅŸlemler listesi (hÄ±zlÄ± kontrol)";
    else if(tab==="alarm") h.textContent = "Alarm ekranÄ±: kritik sinyaller / uyarÄ±lar";
    else h.textContent = "";
  }

  function showTab(tab){
    const cP = document.getElementById("cardProducts");
    const cR = document.getElementById("cardReport");
    const cO = document.getElementById("cardOps");
    const cA = document.getElementById("cardAlarm");

    // Grid dÃ¼zeni: products/report aslÄ±nda grid iÃ§indeydi.
    // Biz sadece kartlarÄ± gÃ¶rÃ¼nÃ¼r/gizli yapÄ±yoruz.
    if(cP) cP.classList.toggle("hiddenPanel", tab!=="products");
    if(cR) cR.classList.toggle("hiddenPanel", tab!=="report");
    if(cO) cO.classList.toggle("hiddenPanel", tab!=="ops");
    if(cA) cA.classList.toggle("hiddenPanel", tab!=="alarm");

    // tab buton state
    document.querySelectorAll("#tabsBar .tabBtn").forEach(b=>{
      const on = (b.getAttribute("data-tab")===tab);
      b.classList.toggle("tabBtnOn", on);
    });

    setHint(tab);
    try{ localStorage.setItem(TABKEY, tab); }catch(e){}
    if(tab==="ops"){ try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){} }
  }

  function safeText(x){ return (x===null||x===undefined) ? "" : String(x); }

  function renderOpsPanel(){
    const list = document.getElementById("opsList");
    if(!list) return;

    const db = (typeof loadDB==="function") ? loadDB() : {products:[], ops:[]};
    const prodById = new Map((db.products||[]).map(p=>[p.id,p]));

    const ops = (db.ops||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,120);
    if(!ops.length){
      list.innerHTML = '<div class="item"><div class="hint">Ä°ÅŸlem yok.</div></div>';
      return;
    }

    list.innerHTML = ops.map(o=>{
      const p = prodById.get(o.pid);
      const name = p ? p.name : ("(silinmiÅŸ Ã¼rÃ¼n) " + safeText(o.pid).slice(0,8));
      const sign = (o.dir==="+") ? "+" : "-";
      const dt = new Date(o.ts||Date.now()).toLocaleString("tr-TR");
      const type = safeText(o.typeLabel || o.type || "");
      const sub = safeText(o.sub || "");
      const note = safeText(o.note || "");
      const extra = (o.unitMode==="koli" && o.packCount && o.packSize) ? (" â€¢ "+o.packCount+" koli Ã— "+o.packSize) : "";
      return `
        <div class="item" style="background:rgba(255,255,255,.02)">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <div class="name">${sign}${safeText(o.qty)} â€¢ ${escapeHTML(name)}</div>
              <div class="muted">${escapeHTML(type)} ${sub?(" â€¢ "+escapeHTML(sub)):""}${extra}${note?(" â€¢ "+escapeHTML(note)):""}</div>
            </div>
            <div class="tag">${escapeHTML(dt)}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  // global yap ki diÄŸer yerlerden Ã§aÄŸrabilelim
  window.renderOpsPanel = renderOpsPanel;
  const _renderProducts_v26 = (typeof renderProducts==="function") ? renderProducts : null;

  // renderProducts Ã§alÄ±ÅŸtÄ±kÃ§a ops panel de gÃ¼ncellensin (ama sekme ops deÄŸilse bile sorun deÄŸil)
  if(typeof _renderProducts_v26 === "function"){
    window.renderProducts = function(){
      _renderProducts_v26();
      try{ renderOpsPanel(); }catch(e){}
    };
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    // tab click
    const bar = document.getElementById("tabsBar");
    if(bar){
      bar.querySelectorAll(".tabBtn").forEach(btn=>{
        btn.addEventListener("click", ()=> showTab(btn.getAttribute("data-tab")));
      });
    }

    // ops panel buttons
    const r = document.getElementById("btnOpsRefresh");
    if(r) r.onclick = ()=> renderOpsPanel();

    const c = document.getElementById("btnOpsClear");
    if(c) c.onclick = ()=>{
      const ok = confirm("TÃ¼m iÅŸlemleri silmek istiyor musun? Bu geri alÄ±namaz.");
      if(!ok) return;
      const db = loadDB();
      db.ops = [];
      saveDB(db);
      try{ renderProducts(); }catch(e){}
      renderOpsPanel();
      alert("Ä°ÅŸlemler silindi.");
    };

    // restore last tab
    let t = "products";
    try{ t = localStorage.getItem("stok_kontrol_tab_v26") || "products"; }catch(e){}
    if(!["products","report","ops","alarm"].includes(t)) t="products";
    showTab(t);
    // ops panel ilk Ã§izim
    try{ renderOpsPanel(); }catch(e){}
  });
})();


/* V27_DECLUTTER_PRODUCTS_MOVE_HISTORY */
(function(){
  // Ops paneline filtre barÄ± ekle (yoksa)
  function ensureOpsFilterBar(){
    const card = document.getElementById("cardOps");
    if(!card) return;
    if(document.getElementById("opsFilterBar")) return;

    const bar = document.createElement("div");
    bar.className = "opsFilterBar";
    bar.id = "opsFilterBar";
    bar.style.display = "none";
    bar.innerHTML = `
      <span class="tag">Filtre</span>
      <span class="name" id="opsFilterName"></span>
      <button class="btn smallBtn" id="btnOpsFilterClear" type="button">Temizle</button>
    `;

    // card iÃ§indeki ilk hr'den Ã¶nce koyalÄ±m
    const hr = card.querySelector(".hr");
    if(hr) hr.parentNode.insertBefore(bar, hr);
    else card.insertBefore(bar, card.firstChild);

    const clr = document.getElementById("btnOpsFilterClear");
    if(clr){
      clr.onclick = ()=>{
        window.__OPS_FILTER_PID = null;
        try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){}
      };
    }
  }

  function prodNameById(pid){
    try{
      const db = (typeof loadDB==="function") ? loadDB() : null;
      if(!db || !db.products) return pid ? pid.slice(0,8) : "";
      const p = db.products.find(x=>x.id===pid);
      return p ? p.name : (pid ? pid.slice(0,8) : "");
    }catch(e){
      return pid ? pid.slice(0,8) : "";
    }
  }

  // renderOpsPanel wrapper: filtre uygula
  function wrapOpsRenderer(){
    if(typeof window.renderOpsPanel !== "function") return;
    if(window.__V27_WRAPPED_OPS) return;

    const orig = window.renderOpsPanel;
    window.renderOpsPanel = function(){
      ensureOpsFilterBar();

      const pid = window.__OPS_FILTER_PID || null;
      const bar = document.getElementById("opsFilterBar");
      const nm  = document.getElementById("opsFilterName");

      // orig render etsin, ama biz Ã¶nce db.ops'yi geÃ§ici filtreleyelim
      // En gÃ¼venlisi: orig iÃ§inde loadDB() Ã§aÄŸrÄ±ldÄ±ÄŸÄ± iÃ§in, burada geÃ§ici olarak loadDB wrapper yapÄ±yoruz.
      if(pid && typeof loadDB==="function"){
        const _load = loadDB;
        window.loadDB = function(){
          const db = _load();
          db.ops = (db.ops||[]).filter(o=>o.pid===pid);
          return db;
        };
        try{ orig(); } finally { window.loadDB = _load; }
      }else{
        orig();
      }

      if(pid){
        if(bar) bar.style.display = "";
        if(nm) nm.textContent = prodNameById(pid);
      }else{
        if(bar) bar.style.display = "none";
        if(nm) nm.textContent = "";
      }
    };

    window.__V27_WRAPPED_OPS = true;
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    try{ ensureOpsFilterBar(); }catch(e){}
    try{ wrapOpsRenderer(); }catch(e){}
  });

  // EÄŸer sonradan renderOpsPanel tanÄ±mlandÄ±ysa da sar:
  const t = setInterval(()=>{
    if(typeof window.renderOpsPanel === "function"){
      try{ wrapOpsRenderer(); }catch(e){}
      clearInterval(t);
    }
  }, 120);
})();


/* V28_ALARM_TAB */
let ALARM_DAYS = 7;

function opsWindow(db, days){
  const now = Date.now();
  const from = now - days*24*3600*1000;
  return (db.ops||[]).filter(o => (o.ts||0) >= from);
}

function calcCritical(db, pid, days){
  const net = (typeof computeStock === "function") ? computeStock(db, pid) : 0;
  const ops = opsWindow(db, days).filter(o=>o.pid===pid);

  // eksi akÄ±ÅŸ (satÄ±ÅŸ+iade+skt) toplami
  let out = 0;
  for(const o of ops){
    const q = Number(o.qty||0);
    if(!q) continue;
    if(o.dir==="-" && (o.type==="satis" || o.type==="iade" || o.type==="skt")){
      out += q;
    }
  }

  const avgDaily = out / Math.max(1, days);
  const daysLeft = (avgDaily>0) ? (net / avgDaily) : Infinity;

  let level="ok";
  if(net < 0) level="red";
  else if(net === 0 && avgDaily>0) level="red";
  else if(daysLeft <= 3) level="red";
  else if(daysLeft <= 7) level="warn";

  return {net, out, avgDaily, daysLeft, level};
}

function badgeHTML(m){
  if(!m) return "";
  if(m.level==="red"){
    const d = isFinite(m.daysLeft) ? Math.max(0, Math.round(m.daysLeft)) : null;
    return `<span class="badgeRed">ğŸŸ¥ Kritik${d!==null?(" â€¢ ~"+d+"g"):""}</span>`;
  }
  if(m.level==="warn"){
    const d = isFinite(m.daysLeft) ? Math.max(0, Math.round(m.daysLeft)) : null;
    return `<span class="badgeWarn">ğŸŸ§ UyarÄ±${d!==null?(" â€¢ ~"+d+"g"):""}</span>`;
  }
  return "";
}

function renderAlarm(){
  const db = loadDB();
  
  /* V4_ALARM_ACTIVE_ONLY */
  try{
    const pid = (window.getActivePid? window.getActivePid() : "");
    if(pid){
      const only = (db.products||[]).filter(p=>p && p.id===pid);
      db.products = only;
    }
  }catch(e){}
const list = document.getElementById("alarmList");
  if(!list) return;

  
  // V50: Odak varsa Alarm'Ä± tek Ã¼rÃ¼ne indir (net/hÄ±z/eta)
  try{
    const pid = (window.getActivePid ? window.getActivePid() : "");
    if(pid){
      const p = (db.products||[]).find(x=>x.id===pid);
      const m = calcCritical(db, pid, ALARM_DAYS);

      const d = isFinite(m.daysLeft) ? Math.max(0, Math.round(m.daysLeft)) : null;
      const speed = (m.avgDaily>0) ? m.avgDaily.toFixed(1) : "0";
      const title = p ? (p.name||"SeÃ§ili ÃœrÃ¼n") : "SeÃ§ili ÃœrÃ¼n";

      let badge = "";
      if(m.level==="red") badge = `<span class="badgeRed">ğŸŸ¥ Kritik${d!==null?(" â€¢ ~"+d+"g"):""}</span>`;
      else if(m.level==="warn") badge = `<span class="badgeWarn">ğŸŸ§ UyarÄ±${d!==null?(" â€¢ ~"+d+"g"):""}</span>`;
      else badge = `<span class="tag">ğŸŸ© Normal</span>`;

      list.innerHTML = `
        <div class="alarmItem">
          <div class="alarmTop">
            <div style="flex:1">
              <div class="alarmName">${escapeHTML(title)}</div>
              <div class="alarmMeta">Net: <b>${m.net}</b> â€¢ ${ALARM_DAYS}g eksi akÄ±ÅŸ: <b>${m.out}</b> â€¢ gÃ¼n/Ã§Ä±kÄ±ÅŸ: <b>${speed}</b>${d!==null?(" â€¢ ~"+d+"g"):""}</div>
            </div>
            <div>${badge}</div>
          </div>
        </div>
      `;
      // sayaÃ§larÄ± da temizle
      const aCritCount = document.getElementById("aCritCount");
      const aNegCount  = document.getElementById("aNegCount");
      const aZeroCount = document.getElementById("aZeroCount");
      if(aCritCount) aCritCount.textContent = (m.level==="ok" ? "0" : "1");
      if(aNegCount)  aNegCount.textContent  = (m.net<0 ? "1" : "0");
      if(aZeroCount) aZeroCount.textContent = (m.net===0 ? "1" : "0");
      return;
    }
  }catch(e){}
const metas = [];
  let neg=0, zero=0;

  for(const p of (db.products||[])){
    const m = calcCritical(db, p.id, ALARM_DAYS);
    if(m.net < 0) neg++;
    if(m.net === 0) zero++;
    if(m.level !== "ok"){
      metas.push({pid:p.id, name:p.name||"", m});
    }
  }

  metas.sort((a,b)=>{
    const rank = x => (x.m.level==="red"?0:1);
    const ra=rank(a), rb=rank(b);
    if(ra!==rb) return ra-rb;

    const da = isFinite(a.m.daysLeft)?a.m.daysLeft:1e18;
    const dbb= isFinite(b.m.daysLeft)?b.m.daysLeft:1e18;
    if(da!==dbb) return da-dbb;

    return (a.name||"").localeCompare((b.name||""),"tr");
  });

  const critCount = metas.length;
  const aCritCount = document.getElementById("aCritCount");
  const aNegCount  = document.getElementById("aNegCount");
  const aZeroCount = document.getElementById("aZeroCount");
  if(aCritCount) aCritCount.textContent = String(critCount);
  if(aNegCount)  aNegCount.textContent  = String(neg);
  if(aZeroCount) aZeroCount.textContent = String(zero);

  if(!critCount){
    list.innerHTML = `<div class="alarmItem"><div class="hint">Kritik Ã¼rÃ¼n yok. (Bu iyi haber.)</div></div>`;
    return;
  }

  list.innerHTML = metas.slice(0, 60).map(x=>{
    const m=x.m;
    const d = isFinite(m.daysLeft) ? Math.max(0, Math.round(m.daysLeft)) : null;
    const speed = (m.avgDaily>0) ? m.avgDaily.toFixed(1) : "0";
    return `
      <div class="alarmItem">
        <div class="alarmTop">
          <div style="flex:1">
            <div class="alarmName">${escapeHTML(x.name)}</div>
            <div class="alarmMeta">Net: <b>${m.net}</b> â€¢ ${ALARM_DAYS}g eksi akÄ±ÅŸ: <b>${m.out}</b> â€¢ gÃ¼n/Ã§Ä±kÄ±ÅŸ: <b>${speed}</b>${d!==null?(" â€¢ ~"+d+"g"): ""}</div>
          </div>
          <div>${badgeHTML(m)}</div>
        </div>
      </div>
    `;
  }).join("");
}

function setAlarmDays(days){
  try{ days = Number(days||7); }catch(e){ days = 7; }
  if(days!==7 && days!==15 && days!==30) days=7;
  ALARM_DAYS = days;

  const b7  = document.getElementById("btnAlarm7");
  const b15 = document.getElementById("btnAlarm15");
  const b30 = document.getElementById("btnAlarm30");

  if(b7)  b7.classList.toggle("alarmBtnOn", days===7);
  if(b15) b15.classList.toggle("alarmBtnOn", days===15);
  if(b30) b30.classList.toggle("alarmBtnOn", days===30);

  const info = document.getElementById("alarmInfo");
  if(info) info.textContent = "Eksi akÄ±ÅŸ: son " + days + " gÃ¼n";

  try{ localStorage.setItem("stok_alarm_days", String(days)); }catch(e){}

  renderAlarm();
}

document.addEventListener("DOMContentLoaded", ()=>{
  const b7 = document.getElementById("btnAlarm7");
  const b15= document.getElementById("btnAlarm15");
  const b30= document.getElementById("btnAlarm30");
  if(b7) b7.onclick  = ()=> setAlarmDays(7);
  if(b15) b15.onclick = ()=> setAlarmDays(15);
  if(b30) b30.onclick = ()=> setAlarmDays(30);

  // Tab sistemi varsa alarm tabÄ±na girince render et
  const alarmTabBtn = document.querySelector('[data-tab="alarm"]');
  if(alarmTabBtn){
    alarmTabBtn.addEventListener("click", ()=>{ try{ renderAlarm(); }catch(e){} });
  }

  // Ä°lk kurulum
  try{ setAlarmDays(7); }catch(e){}
});


/* V291_MINT_LIGHT_UI */
(function(){
  const KEY="stok_v291_tab";
  const PANELS=["cardProducts","cardOps","cardAlarm","cardReport"];

  function ensurePanels(){
    for(const id of PANELS){
      const el=document.getElementById(id);
      if(el){
        el.classList.add("v291Panel");
      }
    }
  }

  function show(id){
    ensurePanels();

    for(const pid of PANELS){
      const el=document.getElementById(pid);
      if(el){
        el.classList.remove("v291PanelOn");
      }
    }
    const active=document.getElementById(id);
    if(active){
      active.classList.add("v291PanelOn");
    }

    document.querySelectorAll(".navBtn").forEach(b=>{
      b.classList.toggle("navBtnOn", b.getAttribute("data-v291")===id);
    });

    try{ localStorage.setItem(KEY,id); }catch(e){}
    try{ window.scrollTo({top:0, behavior:"instant"}); }catch(e){ window.scrollTo(0,0); }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    // Paneller yoksa sessizce Ã§Ä±k
    const any = PANELS.some(id=>document.getElementById(id));
    if(!any) return;

    // nav event baÄŸla
    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=btn.getAttribute("data-v291");
        show(id);
      });
    });

    // son seÃ§im
    let last="cardProducts";
    try{ last=localStorage.getItem(KEY) || "cardProducts"; }catch(e){}
    if(!document.getElementById(last)) last="cardProducts";
    show(last);
  });
})();


/* V292_SINGLE_NAV_CONTROL (fixed) */
document.addEventListener("DOMContentLoaded", function(){
  try{
    // sadece ilk kurulumda default ata; kullanÄ±cÄ± seÃ§imini ezme
    if(!localStorage.getItem("stok_v291_tab")){
      localStorage.setItem("stok_v291_tab","cardProducts");
    }
  }catch(e){}
});

/* V32_GLOBAL_ACTIVE_PRODUCT */
(function(){
  const KEY = "stok_active_pid_v32";

  /* V34_FIX_GLOBAL_PID */

window.getActivePid = function(){
      try{
        // 1) EN NET KAYNAK: globalProdSelect
        const sel = document.getElementById("globalProdSelect");
        if(sel && sel.value && sel.value!=="all" && sel.value!=="*") return String(sel.value);

        // 2) global deÄŸiÅŸken
        if(window.ACTIVE_PID) return String(window.ACTIVE_PID||"");

        // 3) LocalStorage ihtimalleri
        const keys = ["stok_active_pid","stok_kontrol_active_pid","stok_focus_pid","active_pid"];
        for(const k of keys){
          const v = localStorage.getItem(k);
          if(v && v!=="all" && v!=="*") return v;
        }

        // 4) DiÄŸer DOM select ihtimalleri
        const ids = ["activeProd","activeProdSel","selActiveProd","activeProduct","focusProd","prodFocus","selFocusProd"];
        for(const id of ids){
          const el = document.getElementById(id);
          if(el && el.value && el.value!=="all" && el.value!=="*") return el.value;
        }
      }catch(e){}
      return "";
    };


  window.setActivePid = function(pid){
    try{
      if(pid) localStorage.setItem(KEY, pid);
      else localStorage.removeItem(KEY);
    }catch(e){}
  };

  function prodName(db, pid){
    const p = (db.products||[]).find(x=>x.id===pid);
    return p ? (p.name||"") : "";
  }

  window.refreshAllPanels = function(){
    try{ window.renderProducts && window.renderProducts(); }catch(e){}
    try{
      // rapor buton state korunuyorsa zaten kendi Ã§alÄ±ÅŸÄ±r; yine de gÃ¼ncel kalsÄ±n:
      if(window.reportToday) window.reportToday();
    }catch(e){}
    try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){}
    try{ window.renderAlarm && window.renderAlarm(); }catch(e){}
  };

  window.fillGlobalProdSelect = function(){
    const sel = document.getElementById("globalProdSelect");
    if(!sel) return;

    const db = (typeof loadDB==="function") ? loadDB() : {products:[], ops:[]};
    const cur = window.getActivePid();

    const opts = ['<option value="">(TÃ¼mÃ¼ / ÃœrÃ¼n seÃ§me)</option>'];
    for(const p of (db.products||[])){
      const name = String(p.name||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      opts.push('<option value="'+p.id+'">'+name+'</option>');
    }
    sel.innerHTML = opts.join("");
    sel.value = cur;

    const hint = document.getElementById("globalProdHint");
    if(hint){
      if(cur){
        hint.textContent = "Aktif Ã¼rÃ¼n: " + (prodName(db, cur) || cur.slice(0,8)) + " â€¢ Ä°ÅŸlem/Alarm/Rapor bu Ã¼rÃ¼ne gÃ¶re Ã§alÄ±ÅŸÄ±yor.";
      }else{
        hint.textContent = "Ä°pucu: ÃœrÃ¼n seÃ§ersen Ä°ÅŸlem/Alarm/Rapor otomatik o Ã¼rÃ¼ne gÃ¶re filtrelenir.";
      }
    }

    // Ops panelinde ayrÄ±ca Ã¼rÃ¼n filtresi varsa onu da senkronla (varsa)
    try{
      const opsPid = document.getElementById("opsPid");
      if(opsPid){
        opsPid.value = cur || "";
      }
    }catch(e){}
  };

  document.addEventListener("DOMContentLoaded", ()=>{
    window.fillGlobalProdSelect();

    const sel = document.getElementById("globalProdSelect");
    const clr = document.getElementById("btnGlobalProdClear");

    if(sel){
      sel.addEventListener("change", ()=>{
        window.setActivePid(sel.value || "");
        window.fillGlobalProdSelect();
        window.refreshAllPanels();
      });
    }
    if(clr){
      clr.addEventListener("click", ()=>{
        window.setActivePid("");
        window.fillGlobalProdSelect();
        window.refreshAllPanels();
      });
    }
  });

  // renderProducts Ã§alÄ±ÅŸÄ±nca select de gÃ¼ncellensin (Ã¼rÃ¼n ekle/sil sonrasÄ±)
  if(typeof window.renderProducts === "function" && !window.__V32_WRAP_RENDERPRODUCTS){
    const _rp = window.renderProducts;
    window.renderProducts = function(){
      const r = _rp.apply(this, arguments);
      try{ window.fillGlobalProdSelect(); }catch(e){}
      return r;
    };
    window.__V32_WRAP_RENDERPRODUCTS = true;
  }
})();


/* V32_REPORT_FILTER_ACTIVE_PRODUCT */
(function(){
  // aktif Ã¼rÃ¼n id'sini olabildiÄŸince gÃ¼venli yakala
  window.getActivePid = function(){
    try{
      if(window.ACTIVE_PID) return String(window.ACTIVE_PID||"");
      // LocalStorage ihtimalleri
      const keys = ["stok_active_pid","stok_kontrol_active_pid","stok_focus_pid","active_pid"];
      for(const k of keys){
        const v = localStorage.getItem(k);
        if(v && v!=="all" && v!=="*") return v;
      }
      // DOM ihtimalleri (id denemeleri)
      const ids = ["activeProd","activeProdSel","selActiveProd","activeProduct","focusProd","prodFocus","selFocusProd"];
      for(const id of ids){
        const el = document.getElementById(id);
        if(el && el.value && el.value!=="all" && el.value!=="*") return el.value;
      }
      // son Ã§are: select iÃ§inde â€œÃœrÃ¼n seÃ§meâ€ barÄ±na yakÄ±n olan ilk select
      const sel = document.querySelector('select');
      if(sel && sel.value && sel.value!=="all" && sel.value!=="*") return sel.value;
    }catch(e){}
    return "";
  };

  window.applyActivePidFilter = function(db){
    try{
      const pid = window.getActivePid ? window.getActivePid() : "";
      if(!pid) return db;
      const ops = (db.ops||[]).filter(o => o && o.pid === pid);
      const nd = Object.assign({}, db);
      nd.ops = ops;
      return nd;
    }catch(e){
      return db;
    }
  };
})();



/* V4_CORE_STATE */
window.APP = {
  activePid: "",
  db: null
};

window.getActivePid = function(){
  return window.APP.activePid || "";
};

window.setActivePid = function(pid){
  window.APP.activePid = pid || "";
  if(typeof renderAll === "function"){
    renderAll();
  }
};




/* V4_STAGE2_BIND_ACTIVE */
(function(){
  const LSKEY = "stok_active_pid_v4";

  // V32 gibi â€œselect arayÄ±p bulayÄ±mâ€ yok. Tek kaynak: APP.activePid
  window.getActivePid = function(){
    try{ return (window.APP && window.APP.activePid) ? String(window.APP.activePid||"") : ""; }
    catch(e){ return ""; }
  };

  // reportForDays zaten bunu Ã§aÄŸÄ±rÄ±yor â†’ burayÄ± saÄŸlam yapÄ±yoruz
  window.applyActivePidFilter = function(db){
    try{
      const pid = window.getActivePid ? window.getActivePid() : "";
      if(!pid) return db;
      const nd = Object.assign({}, db);
      nd.ops = (db.ops||[]).filter(o => o && o.pid === pid);
      return nd;
    }catch(e){
      return db;
    }
  };

  function save(pid){
    try{ localStorage.setItem(LSKEY, pid||""); }catch(e){}
  }
  function load(){
    try{ return localStorage.getItem(LSKEY)||""; }catch(e){ return ""; }
  }

  function bindSelect(){
    const sel = document.getElementById("globalProdSelect");
    if(!sel) return;

    // restore (varsa)
    const want = load();
    if(want && [...sel.options].some(o=>o.value===want)){
      sel.value = want;
      if(window.setActivePid) window.setActivePid(want);
      else if(window.APP) window.APP.activePid = want;
    } else {
      // boÅŸsa â€œtÃ¼mÃ¼â€
      if(window.setActivePid) window.setActivePid(sel.value||"");
      else if(window.APP) window.APP.activePid = (sel.value||"");
    }

    sel.addEventListener("change", ()=>{
      const pid = sel.value || "";
      if(window.setActivePid) window.setActivePid(pid);
      else if(window.APP) window.APP.activePid = pid;
      save(pid);
    });
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    try{ bindSelect(); }catch(e){}
  });
})();



/* V43_SYNC_SELECTS_OPS_FILTER */
(function(){
  const LSKEY = "stok_active_pid_v4";

  function setPid(pid){
    pid = pid || "";
    try{
      if(window.setActivePid) window.setActivePid(pid);
      else if(window.APP) window.APP.activePid = pid;
    }catch(e){}

    // iki select'i de aynÄ± yap
    try{
      const g = document.getElementById("globalProdSelect");
      if(g && g.value !== pid) g.value = pid;
    }catch(e){}

    try{
      const r = document.getElementById("reportProdFilter");
      if(r && r.value !== pid) r.value = pid;
    }catch(e){}

    // persist
    try{ localStorage.setItem(LSKEY, pid); }catch(e){}

    // ekranlarÄ± tazele
    try{ window.renderProducts && window.renderProducts(); }catch(e){}
    try{ window.renderAlarm && window.renderAlarm(); }catch(e){}
    try{ window.reportForDays && window.reportForDays((window.REPORT_LAST_DAYS||1)); }catch(e){}
    try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){}
  }

  function getPid(){
    try{ return (window.getActivePid ? window.getActivePid() : (window.APP && window.APP.activePid) || "") || ""; }
    catch(e){ return ""; }
  }

  function restore(){
    let pid = "";
    try{ pid = localStorage.getItem(LSKEY) || ""; }catch(e){}
    // select'lerde varsa uygula
    const g = document.getElementById("globalProdSelect");
    const r = document.getElementById("reportProdFilter");

    if(g && pid && [...g.options].some(o=>o.value===pid)) g.value = pid;
    if(r && pid && [...r.options].some(o=>o.value===pid)) r.value = pid;

    // APP'ye yaz
    if(pid) setPid(pid);
    else setPid(g ? (g.value||"") : "");
  }

  function bind(){
    const g = document.getElementById("globalProdSelect");
    if(g){
      g.addEventListener("change", ()=> setPid(g.value||""));
    }

    const r = document.getElementById("reportProdFilter");
    if(r){
      r.addEventListener("change", ()=> setPid(r.value||""));
    }
  }

  // Ops panel: aktif Ã¼rÃ¼ne gÃ¶re ops filtre (tek kaynak: getActivePid)
  function wrapOps(){
    if(window.__V43_OPS_WRAPPED) return;
    if(typeof window.renderOpsPanel !== "function") return;

    const orig = window.renderOpsPanel;
    window.renderOpsPanel = function(){
      const pid = getPid();
      if(pid){
        const _load = window.loadDB;
        if(typeof _load === "function"){
          window.loadDB = function(){
            const db = _load();
            db.ops = (db.ops||[]).filter(o=>o && o.pid===pid);
            return db;
          };
          try{ orig(); } finally { window.loadDB = _load; }
          return;
        }
      }
      orig();
    };
    window.__V43_OPS_WRAPPED = true;
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    try{ bind(); }catch(e){}
    try{ restore(); }catch(e){}

    // renderOpsPanel geÃ§ tanÄ±mlanÄ±yorsa yakala
    try{ wrapOps(); }catch(e){}
    const t = setInterval(()=>{
      try{
        if(typeof window.renderOpsPanel === "function"){
          wrapOps();
          clearInterval(t);
        }
      }catch(e){}
    }, 120);
  });

  // dÄ±ÅŸarÄ±dan da tek satÄ±rda setlemek isteyen olursa:
  window.setActivePidV43 = setPid;
})();



/* V44_ALARM_7_15_30 */
(function(){
  const KEY = "stok_alarm_days_v44";

  function ui(days){
    const b7  = document.getElementById("btnAlarm7");
    const b15 = document.getElementById("btnAlarm15");
    const b30 = document.getElementById("btnAlarm30");
    if(b7)  b7.classList.toggle("alarmBtnOn", days===7);
    if(b15) b15.classList.toggle("alarmBtnOn", days===15);
    if(b30) b30.classList.toggle("alarmBtnOn", days===30);

    const info = document.getElementById("alarmInfo");
    if(info) info.textContent = "son " + days + " gÃ¼n";
  }

  function getSaved(){
    let v = 7;
    try{ v = parseInt(localStorage.getItem(KEY)||"7",10)||7; }catch(e){}
    if(v!==7 && v!==15 && v!==30) v=7;
    return v;
  }

  function save(v){
    try{ localStorage.setItem(KEY, String(v)); }catch(e){}
  }

  // renderAlarm mevcutsa kullanacaÄŸÄ±z
  window.setAlarmDaysV44 = function(days){
    days = (days===15?15:(days===30?30:7));
    try{ window.ALARM_DAYS = days; }catch(e){}
    save(days);
    ui(days);
    try{ window.renderAlarm && window.renderAlarm(); }catch(e){}
  };

  document.addEventListener("DOMContentLoaded", ()=>{
    const b7  = document.getElementById("btnAlarm7");
    const b15 = document.getElementById("btnAlarm15");
    const b30 = document.getElementById("btnAlarm30");

    if(b7)  b7.onclick  = ()=> window.setAlarmDaysV44(7);
    if(b15) b15.onclick = ()=> window.setAlarmDaysV44(15);
    if(b30) b30.onclick = ()=> window.setAlarmDaysV44(30);

    // eski setAlarmDays varsa da ez (tek doÄŸru kaynak V44 olsun)
    try{ window.setAlarmDays = window.setAlarmDaysV44; }catch(e){}

    // ilk kurulum: kayÄ±tlÄ± deÄŸer
    try{ window.setAlarmDaysV44(getSaved()); }catch(e){}
  });
})();



/* V45_ALARM_FOLLOWS_ACTIVE_PRODUCT */
(function(){
  if(window.__V45_WRAPPED_ALARM) return;

  // 1) Aktif Ã¼rÃ¼n id'sini NOKTA ATIÅI yakala (globalProdSelect)
  function activePid(){
    try{
      const sel = document.getElementById("globalProdSelect");
      if(sel && sel.value && sel.value!=="all" && sel.value!=="*") return String(sel.value);
    }catch(e){}
    // 2) varsa eski getActivePid fallback (V32)
    try{
      if(window.getActivePid){
        const v = window.getActivePid();
        if(v && v!=="all" && v!=="*") return String(v);
      }
    }catch(e){}
    return "";
  }

  // getActivePid'i gÃ¼Ã§lendir: globalProdSelect'i daima Ã¶ne al
  try{
    const oldGet = window.getActivePid;
    window.getActivePid = function(){
      const pid = activePid();
      if(pid) return pid;
      try{ return oldGet ? oldGet() : ""; }catch(e){ return ""; }
    };
  }catch(e){}

  // renderAlarm yoksa Ã§Ä±k
  const orig = window.renderAlarm;
  if(typeof orig !== "function"){
    console.log("V45: renderAlarm yok, pas geÃ§tim.");
    return;
  }

  // 3) renderAlarm'Ä± sar: aktif Ã¼rÃ¼n varsa loadDB'yi geÃ§ici filtrele
  window.renderAlarm = function(){
    const pid = activePid();

    // aktif Ã¼rÃ¼n yoksa normal Ã§alÄ±ÅŸ
    if(!pid){
      try{ orig(); }catch(e){}
      return;
    }

    const _load = window.loadDB;
    if(typeof _load === "function"){
      window.loadDB = function(){
        const db = _load();
        try{
          db.ops = (db.ops||[]).filter(o => o && o.pid === pid);
          db.products = (db.products||[]).filter(p => p && p.id === pid);
        }catch(e){}
        return db;
      };
    }

    try{
      orig();
    } finally {
      if(typeof _load === "function") window.loadDB = _load;
    }

    // kÃ¼Ã§Ã¼k bilgi notu
    try{
      const info = document.getElementById("alarmInfo");
      if(info){
        const t = (info.textContent||"").trim();
        info.textContent = (t ? (t+" â€¢ ") : "") + "aktif Ã¼rÃ¼n";
      }
    }catch(e){}
  };

  // 4) Aktif Ã¼rÃ¼n deÄŸiÅŸince Alarm yenile
  document.addEventListener("DOMContentLoaded", ()=>{
    try{
      const sel = document.getElementById("globalProdSelect");
      if(sel){
        sel.addEventListener("change", ()=>{
          try{ window.renderAlarm(); }catch(e){}
        });
      }
    }catch(e){}
  });

  window.__V45_WRAPPED_ALARM = true;
})();



/* V46_OPS_FOLLOWS_ACTIVE_PRODUCT */
(function(){
  if(window.__V46_WRAPPED_OPS) return;

  function activePid(){
    try{
      const sel = document.getElementById("globalProdSelect");
      if(sel && sel.value && sel.value!=="all" && sel.value!=="*") return String(sel.value);
    }catch(e){}
    try{
      if(window.getActivePid){
        const v = window.getActivePid();
        if(v && v!=="all" && v!=="*") return String(v);
      }
    }catch(e){}
    return "";
  }

  // renderOpsPanel yoksa da sorun deÄŸil: sadece gÃ¼venli bind
  function safeRenderOps(){
    try{
      if(typeof window.renderOpsPanel === "function"){
        window.renderOpsPanel();
      }
    }catch(e){}
  }

  // renderOpsPanel varsa sar (aktif Ã¼rÃ¼n varsa loadDB'yi geÃ§ici filtrele)
  function wrapOps(){
    if(window.__V46_OPS_WRAPPED_ONCE) return;
    if(typeof window.renderOpsPanel !== "function") return;

    const orig = window.renderOpsPanel;

    window.renderOpsPanel = function(){
      const pid = activePid();
      if(!pid){
        try{ orig(); }catch(e){}
        return;
      }

      const _load = window.loadDB;
      if(typeof _load === "function"){
        window.loadDB = function(){
          const db = _load();
          try{
            db.ops = (db.ops||[]).filter(o => o && o.pid === pid);
            // ops ekranÄ±nda Ã¼rÃ¼n adÄ± vs. iÃ§in lazÄ±m olabiliyor, tek Ã¼rÃ¼ne indiriyoruz
            db.products = (db.products||[]).filter(p => p && p.id === pid);
          }catch(e){}
          return db;
        };
      }

      try{
        orig();
      } finally {
        if(typeof _load === "function") window.loadDB = _load;
      }
    };

    window.__V46_OPS_WRAPPED_ONCE = true;
  }

  // Ä°lk dene (bazÄ± sÃ¼rÃ¼mlerde renderOpsPanel daha sonra geliyor)
  wrapOps();

  // Sonradan gelirse de sar
  const t = setInterval(()=>{
    if(typeof window.renderOpsPanel === "function"){
      try{ wrapOps(); }catch(e){}
      clearInterval(t);
    }
  }, 120);

  document.addEventListener("DOMContentLoaded", ()=>{
    // aktif Ã¼rÃ¼n deÄŸiÅŸince ops yenile
    try{
      const sel = document.getElementById("globalProdSelect");
      if(sel){
        sel.addEventListener("change", ()=>{
          try{ wrapOps(); }catch(e){}
          safeRenderOps();
        });
      }
    }catch(e){}

    // â€œÄ°ÅŸlemâ€ sekmesine basÄ±nca da hemen render et (bottom nav + eski tab sistemi)
    try{
      const navOps = document.querySelector('[data-v291="cardOps"]');
      if(navOps){
        navOps.addEventListener("click", ()=>{
          try{ wrapOps(); }catch(e){}
          setTimeout(safeRenderOps, 0);
        });
      }
    }catch(e){}

    try{
      const tabOps = document.querySelector('[data-tab="ops"]');
      if(tabOps){
        tabOps.addEventListener("click", ()=>{
          try{ wrapOps(); }catch(e){}
          setTimeout(safeRenderOps, 0);
        });
      }
    }catch(e){}
  });

  window.__V46_WRAPPED_OPS = true;
})();



/* V47_ACTIVE_BADGE_AND_ALARM_FOLLOW */
(function(){
  if(window.__V47_ACTIVE_BADGE) return;

  function getActivePid(){
    try{
      const sel = document.getElementById("globalProdSelect");
      if(sel && sel.value && sel.value!=="all" && sel.value!=="*") return String(sel.value);
    }catch(e){}
    try{
      if(window.getActivePid){
        const v = window.getActivePid();
        if(v && v!=="all" && v!=="*") return String(v);
      }
    }catch(e){}
    return "";
  }

  function getActiveName(pid){
    try{
      const db = (typeof loadDB==="function") ? loadDB() : null;
      if(!db || !db.products) return "";
      const p = db.products.find(x=>x.id===pid);
      return p ? (p.name||"") : "";
    }catch(e){
      return "";
    }
  }

  function clearActive(){
    try{
      const sel=document.getElementById("globalProdSelect");
      if(sel){
        sel.value = "";
        try{ sel.dispatchEvent(new Event("change")); }catch(e){}
      }
    }catch(e){}
  }

  function badgeHTML(name){
    const safe = (name||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    return 'ğŸ¯ <span class="mut">Aktif:</span> <span>'+safe+'</span> <button class="xBtn" id="btnClearActive" type="button">Temizle</button>';
  }

  window.updateActiveBadges = function(){
    const pid = getActivePid();
    const bOps   = document.getElementById("activeBadgeOps");
    const bAlarm = document.getElementById("activeBadgeAlarm");
    const bRep   = document.getElementById("activeBadgeReport");

    if(!pid){
      if(bOps) bOps.style.display="none";
      if(bAlarm) bAlarm.style.display="none";
      if(bRep) bRep.style.display="none";
      return;
    }

    const name = getActiveName(pid) || ("ID:"+pid.slice(0,8));
    const html = badgeHTML(name);

    if(bOps){ bOps.innerHTML = html; bOps.style.display="inline-flex"; }
    if(bAlarm){ bAlarm.innerHTML = html; bAlarm.style.display="inline-flex"; }
    if(bRep){ bRep.innerHTML = html; bRep.style.display="inline-flex"; }

    // temizle butonu (aynÄ± id 3 yerde var => en son basÄ±lan Ã§alÄ±ÅŸÄ±r; event delegation kullanalÄ±m)
  };

  // Alarm: aktif Ã¼rÃ¼n varsa sadece o Ã¼rÃ¼nÃ¼ hesapla
  function wrapAlarm(){
    if(window.__V47_ALARM_WRAPPED) return;
    if(typeof window.renderAlarm !== "function") return;

    const orig = window.renderAlarm;

    window.renderAlarm = function(){
      const pid = getActivePid();
      if(!pid){
        try{ orig(); }catch(e){}
        return;
      }

      const _load = window.loadDB;
      if(typeof _load === "function"){
        window.loadDB = function(){
          const db = _load();
          try{
            db.ops = (db.ops||[]).filter(o => o && o.pid === pid);
            db.products = (db.products||[]).filter(p => p && p.id === pid);
          }catch(e){}
          return db;
        };
      }

      try{
        orig();
      } finally {
        if(typeof _load === "function") window.loadDB = _load;
      }
    };

    window.__V47_ALARM_WRAPPED = true;
  }

  function safeReportRefresh(){
    try{
      if(typeof window.reportForDays === "function"){
        // mÃ¼mkÃ¼nse son seÃ§ili gÃ¼n aralÄ±ÄŸÄ±na bas
        let d = 1;
        try{
          if(document.getElementById("btnReport30") && document.getElementById("btnReport30").classList.contains("alarmBtnOn")) d=30;
          else if(document.getElementById("btnReport7") && document.getElementById("btnReport7").classList.contains("alarmBtnOn")) d=7;
          else if(document.getElementById("btnReport1") && document.getElementById("btnReport1").classList.contains("alarmBtnOn")) d=1;
        }catch(e){}
        window.reportForDays(d);
      }
    }catch(e){}
  }

  function safeOpsRefresh(){
    try{ if(typeof window.renderOpsPanel==="function") window.renderOpsPanel(); }catch(e){}
  }

  document.addEventListener("click", (ev)=>{
    const t = ev.target;
    if(t && t.id==="btnClearActive"){
      ev.preventDefault();
      clearActive();
    }
  });

  document.addEventListener("DOMContentLoaded", ()=>{
    try{ wrapAlarm(); }catch(e){}
    try{ window.updateActiveBadges(); }catch(e){}

    // aktif Ã¼rÃ¼n deÄŸiÅŸince: rozet + alarm + ops + rapor yenile
    try{
      const sel=document.getElementById("globalProdSelect");
      if(sel){
        sel.addEventListener("change", ()=>{
          try{ window.updateActiveBadges(); }catch(e){}
          try{ wrapAlarm(); }catch(e){}
          try{ safeOpsRefresh(); }catch(e){}
          try{ window.renderAlarm && window.renderAlarm(); }catch(e){}
          try{ safeReportRefresh(); }catch(e){}
        });
      }
    }catch(e){}

    // Alarm sekmesine girince garanti render + rozet
    try{
      const navAlarm = document.querySelector('[data-v291="cardAlarm"]');
      if(navAlarm){
        navAlarm.addEventListener("click", ()=>{
          try{ wrapAlarm(); }catch(e){}
          try{ window.updateActiveBadges(); }catch(e){}
          setTimeout(()=>{ try{ window.renderAlarm && window.renderAlarm(); }catch(e){} }, 0);
        });
      }
    }catch(e){}

    // Rapor sekmesine girince: filtreli raporu bas
    try{
      const navRep = document.querySelector('[data-v291="cardReport"]');
      if(navRep){
        navRep.addEventListener("click", ()=>{
          try{ window.updateActiveBadges(); }catch(e){}
          setTimeout(()=>{ try{ safeReportRefresh(); }catch(e){} }, 0);
        });
      }
    }catch(e){}

    // Ops sekmesine girince: rozet + yenile
    try{
      const navOps = document.querySelector('[data-v291="cardOps"]');
      if(navOps){
        navOps.addEventListener("click", ()=>{
          try{ window.updateActiveBadges(); }catch(e){}
          setTimeout(()=>{ try{ safeOpsRefresh(); }catch(e){} }, 0);
        });
      }
    }catch(e){}
  });

  // renderAlarm sonradan gelirse de sar
  const t=setInterval(()=>{
    if(typeof window.renderAlarm==="function"){
      try{ wrapAlarm(); }catch(e){}
      clearInterval(t);
    }
  }, 120);

  window.__V47_ACTIVE_BADGE = true;
})();


/* V49_ACTIVE_PRODUCT_MASTER */
(function(){
  const KEY = "stok_active_pid";

  function safeDB(){
    try{ return (typeof loadDB==="function") ? loadDB() : {products:[], ops:[], meta:{}}; }catch(e){ return {products:[], ops:[], meta:{}}; }
  }

  function getActivePid(){
    try{
      // 1) RAM
      if(window.ACTIVE_PID && window.ACTIVE_PID!=="all") return String(window.ACTIVE_PID);
      // 2) storage
      const v = localStorage.getItem(KEY);
      if(v && v!=="all" && v!=="*") return v;
      // 3) select
      const sel = document.getElementById("globalProdSelect");
      if(sel && sel.value && sel.value!=="all" && sel.value!=="*") return sel.value;
    }catch(e){}
    return "";
  }

  function setActivePid(pid){
    try{
      pid = String(pid||"");
      if(!pid || pid==="all" || pid==="*"){
        window.ACTIVE_PID = "";
        try{ localStorage.removeItem(KEY); }catch(e){}
        const sel = document.getElementById("globalProdSelect");
        if(sel) sel.value = "";
        return;
      }
      window.ACTIVE_PID = pid;
      try{ localStorage.setItem(KEY, pid); }catch(e){}
      const sel = document.getElementById("globalProdSelect");
      if(sel) sel.value = pid;
    }catch(e){}
  }

  function rebuildGlobalSelect(){
    const sel = document.getElementById("globalProdSelect");
    if(!sel) return;

    const db = safeDB();
    const list = (db.products||[]).slice().sort((a,b)=>String(a.name||"").localeCompare(String(b.name||""),"tr"));

    const cur = getActivePid();

    // BaÅŸtan kur (en temizi)
    const opts = [];
    opts.push('<option value="">(TÃ¼mÃ¼)</option>');
    for(const p of list){
      const id = String(p.id||"");
      if(!id) continue;
      const nm = String(p.name||id);
      opts.push('<option value="'+id.replace(/"/g,'&quot;')+'">'+nm.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</option>');
    }
    sel.innerHTML = opts.join("");

    // restore
    if(cur){
      sel.value = cur;
      window.ACTIVE_PID = cur;
    }else{
      sel.value = "";
      window.ACTIVE_PID = "";
    }
  }

  function refreshAll(){
    // ÃœrÃ¼n listesi
    try{ if(typeof renderProducts==="function") renderProducts(); }catch(e){}
    // Ops panel
    try{ if(typeof window.renderOpsPanel==="function") window.renderOpsPanel(); }catch(e){}
    // Alarm
    try{ if(typeof renderAlarm==="function") renderAlarm(); }catch(e){}
    // Rapor: hangi gÃ¼n seÃ§iliyse onu bas
    try{
      if(typeof reportForDays==="function"){
        // Ã¶nce REPORT_LAST_DAYS varsa onu kullan
        if(typeof REPORT_LAST_DAYS!=="undefined" && REPORT_LAST_DAYS) reportForDays(REPORT_LAST_DAYS);
        else reportForDays(1);
      }
    }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    // select'i kur
    try{ rebuildGlobalSelect(); }catch(e){}

    const sel = document.getElementById("globalProdSelect");
    if(sel){
      sel.addEventListener("change", ()=>{
        try{
          setActivePid(sel.value||"");
          // filtre deÄŸiÅŸti -> her ÅŸeyi tazele
          refreshAll();
        }catch(e){}
      });
    }

    // ilk aÃ§Ä±lÄ±ÅŸta storage varsa uygula
    try{
      const v = localStorage.getItem(KEY);
      if(v && v!=="all" && v!=="*"){
        setActivePid(v);
      }
    }catch(e){}

    // ilk paint
    try{ refreshAll(); }catch(e){}
  });

  // dÄ±ÅŸarÄ±dan da Ã§aÄŸrÄ±labilsin
  window.getActivePidV49 = getActivePid;
  window.setActivePidV49 = setActivePid;
  window.refreshAllV49 = refreshAll;
})();



/* V50_FOCUS_MODE_ACTIVE_PRODUCT */
(function(){
  function refreshAll(){
    try{ window.renderProducts && window.renderProducts(); }catch(e){}
    try{
      // rapor aralÄ±ÄŸÄ± hatÄ±rlanÄ±yorsa onu tekrar bas
      if(typeof window.REPORT_LAST_DAYS === "number" && window.reportForDays){
        window.reportForDays(window.REPORT_LAST_DAYS);
      }else if(window.reportToday){
        window.reportToday();
      }
    }catch(e){}
    try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){}
    try{ window.renderAlarm && window.renderAlarm(); }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    const sel = document.getElementById("globalProdSelect");
    if(!sel) return;

    // UI mini bilgi: seÃ§ili Ã¼rÃ¼n adÄ±
    const tag = document.createElement("div");
    tag.id = "focusTag";
    tag.className = "focusPill";
    tag.style.marginTop = "10px";
    tag.innerHTML = 'Odak: <b>TÃ¼mÃ¼</b>';
    // select satÄ±rÄ±nÄ±n hemen altÄ±na koy
    try{
      sel.parentElement && sel.parentElement.appendChild(tag);
    }catch(e){}

    function setTag(){
      try{
        const pid = window.getActivePid ? window.getActivePid() : "";
        if(!pid){
          tag.innerHTML = 'Odak: <b>TÃ¼mÃ¼</b>';
          return;
        }
        const db = (typeof window.loadDB==="function") ? window.loadDB() : {products:[]};
        const p = (db.products||[]).find(x=>x.id===pid);
        tag.innerHTML = 'Odak: <b>' + (p?(p.name||"SeÃ§ili"): "SeÃ§ili") + '</b>';
      }catch(e){}
    }

    sel.addEventListener("change", ()=>{
      try{
        const v = sel.value || "";
        window.ACTIVE_PID = v;
        // kalÄ±cÄ± hafÄ±za (bizim key)
        localStorage.setItem("stok_active_pid", v);
      }catch(e){}
      try{ setTag(); }catch(e){}
      refreshAll();
    });

    // ilk aÃ§Ä±lÄ±ÅŸta tag ayarla
    try{ setTag(); }catch(e){}
  });
})();



/* V51_FOCUS_SYNC_BUGFIX */
(function(){
  function syncReportFilter(){
    try{
      const g = document.getElementById("globalProdSelect");
      const r = document.getElementById("reportProdFilter");
      if(!g || !r) return;
      // report filtresi boÅŸsa veya farklÄ±ysa global'e eÅŸitle (tÃ¼mÃ¼ durumunu da koru)
      if(r.value !== g.value){
        r.value = g.value;
      }
    }catch(e){}
  }

  function refreshAllSoft(){
    try{ syncReportFilter(); }catch(e){}
    try{
      if(typeof window.REPORT_LAST_DAYS === "number" && window.reportForDays){
        window.reportForDays(window.REPORT_LAST_DAYS);
      }else if(window.reportToday){
        window.reportToday();
      }
    }catch(e){}
    try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){}
    try{ window.renderAlarm && window.renderAlarm(); }catch(e){}
    try{ window.renderProducts && window.renderProducts(); }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    // ilk aÃ§Ä±lÄ±ÅŸta eÅŸitle
    try{ syncReportFilter(); }catch(e){}

    // global select deÄŸiÅŸince raporu da gÃ¼ncelle
    const g = document.getElementById("globalProdSelect");
    if(g){
      g.addEventListener("change", ()=>{
        // V51: rapor filtresi + ekranlar senkron
        refreshAllSoft();
      });
    }

    // rapor filtresi elle deÄŸiÅŸirse, globalâ€™i de eÅŸitle (kafa karÄ±ÅŸmasÄ±n)
    const r = document.getElementById("reportProdFilter");
    if(r){
      r.addEventListener("change", ()=>{
        try{
          const g2 = document.getElementById("globalProdSelect");
          if(g2 && g2.value !== r.value){
            g2.value = r.value;
            try{ localStorage.setItem("stok_active_pid", r.value||""); }catch(e){}
          }
        }catch(e){}
        refreshAllSoft();
      });
    }
  });
})();


/* V53_ACTIVE_PRODUCT_CHANGE_REFRESH */
document.addEventListener("DOMContentLoaded", ()=>{
  try{
    const sel=document.getElementById("globalProdSelect");
    if(sel && !sel.__v53_bound){
      sel.__v53_bound = true;
      sel.addEventListener("change", ()=>{
        try{
          // Ã¼rÃ¼n deÄŸiÅŸti => rapor/alarm/ops (varsa) gÃ¼ncelle
          try{ reportToday(); }catch(e){}
          try{ if(typeof renderAlarm==="function") renderAlarm(); }catch(e){}
          try{ if(typeof window.renderOpsPanel==="function") window.renderOpsPanel(); }catch(e){}
        }catch(e){}
      });
    }
  }catch(e){}
});


/* V54_RENDER_SCHEDULER */
(function(){
  const Q = [];
  let running = false;
  const lastRun = new Map(); // key -> ms
  const MIN_GAP = 300;

  function now(){ try{ return Date.now(); }catch(e){ return 0; } }

  function drain(){
    if(running) return;
    if(!Q.length) return;
    running = true;

    const job = Q.shift();
    // iÅŸi bir sonraki frame + kÄ±sa timeout ile Ã§alÄ±ÅŸtÄ±r (UI nefes alsÄ±n)
    try{
      requestAnimationFrame(()=> {
        setTimeout(()=> {
          try{ job.fn(); }catch(e){}
          running = false;
          drain();
        }, 0);
      });
    }catch(e){
      // fallback
      try{ job.fn(); }catch(e2){}
      running = false;
      drain();
    }
  }

  window.__scheduleRender = function(key, fn){
    try{
      const t = now();
      const prev = lastRun.get(key) || 0;
      if(t - prev < MIN_GAP){
        return; // Ã§ok sÄ±k Ã§aÄŸrÄ± -> yut
      }
      lastRun.set(key, t);
      Q.push({key, fn});
      drain();
    }catch(e){
      // scheduler patlarsa direkt Ã§alÄ±ÅŸtÄ±r
      try{ fn(); }catch(e2){}
    }
  };

  // GÃ¼venli wrapperâ€™lar
  window.__renderReportSafe = function(){
    window.__scheduleRender("report", ()=>{ try{ window.reportToday && window.reportToday(); }catch(e){} });
  };
  window.__renderAlarmSafe = function(){
    window.__scheduleRender("alarm", ()=>{ try{ window.renderAlarm && window.renderAlarm(); }catch(e){} });
  };
  window.__renderOpsSafe = function(){
    window.__scheduleRender("ops", ()=>{ try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){} });
  };
})();


/* V54_ACTIVE_PRODUCT_CHANGE_REFRESH */
document.addEventListener("DOMContentLoaded", ()=>{
  try{
    const sel = document.getElementById("globalProdSelect");
    if(sel && !sel.__v54_bound){
      sel.__v54_bound = true;
      sel.addEventListener("change", ()=>{
        try{
          window.__renderReportSafe && window.__renderReportSafe();
          window.__renderAlarmSafe && window.__renderAlarmSafe();
          window.__renderOpsSafe && window.__renderOpsSafe();
        }catch(e){}
      });
    }
  }catch(e){}
});


/* V56_OPS_VIRTUAL_RENDER */
(function(){
  // Ayarlar: batch render
  const BATCH = 40;        // her seferde kaÃ§ satÄ±r basÄ±lsÄ±n
  const TICK  = 0;         // 0ms yield (UI nefes alsÄ±n)

  function $(id){ return document.getElementById(id); }

  function safe(fn){ try{ return fn(); }catch(e){ return null; } }

  function esc(s){
    try{
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }catch(e){ return ""; }
  }

  function prodName(db, pid){
    try{
      const p = (db.products||[]).find(x=>x.id===pid);
      return p ? (p.name||pid.slice(0,8)) : (pid?pid.slice(0,8):"");
    }catch(e){ return pid?pid.slice(0,8):""; }
  }

  function typeLabel(o){
    return (o.typeLabel || o.type || "");
  }

  function fmtDT(ts){
    try{ return new Date(Number(ts||0)).toLocaleString("tr-TR"); }catch(e){ return ""; }
  }

  function buildOpsArray(db){
    let ops = (db.ops||[]).slice();
    ops.sort((a,b)=>(Number(b.ts||0)-Number(a.ts||0)));

    // ÃœrÃ¼n filtresi (ÃœrÃ¼n kartÄ±ndaki â€œÄ°ÅŸlemlerâ€ butonu bunu set ediyordu)
    const pid = safe(()=>window.__OPS_FILTER_PID) || "";
    if(pid){
      ops = ops.filter(o=>o && o.pid===pid);
    }
    return ops;
  }

  /* V57_OPS_RICHER_REAL */
function renderOpsVirtual(){
    const list = $("opsList");
    if(!list) return;

    const db = safe(()=>loadDB()) || {products:[], ops:[]};
    const ops = buildOpsArray(db);

    list.innerHTML = "";

    if(!ops.length){
      list.innerHTML = '<div class="item"><div class="hint">Ä°ÅŸlem yok.</div></div>';
      return;
    }

    // baÅŸlÄ±k gibi mini bilgi
    const head = document.createElement("div");
    head.className = "item";
    
const pid = window.__OPS_FILTER_PID || "";
let chip = "";
if(pid){
  const prod = (db.products||[]).find(x=>x.id===pid);
  const pname = prod ? (prod.name||pid.slice(0,8)) : pid.slice(0,8);
  chip = '<span class="opsFilterChip">Filtre: <b>'+esc(pname)+'</b></span>';
}
head.innerHTML = '<div class="opsMiniRow">'+
  '<div class="name">Son Ä°ÅŸlemler</div>'+
  '<div class="opsMiniMeta">'+chip+' Toplam: <b>'+ops.length+'</b></div>'+
'</div>';

    list.appendChild(head);

    let i = 0;
    const total = ops.length;

    const moreBtn = document.createElement("button");
    moreBtn.className = "btn opsLoadBtn";
    moreBtn.type = "button";

    function paintBatch(){
      const end = Math.min(i + BATCH, total);
      for(; i<end; i++){
        const o = ops[i];
        const pid = o.pid || "";
        const pname = prodName(db, pid);

        const dir = (o.dir==="-" ? "âˆ’" : "+");
        const qty = Number(o.qty||0);
        const unit = (o.unitMode==="koli" ? "koli" : "adet");
        const sub = (o.sub||"");
        const note = (o.note||"");

        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div class="row" style="justify-content:space-between;gap:10px">
            <div class="name" style="flex:1;min-width:0">${esc(pname)}</div>
            <div class="tag">${dir}${qty} ${esc(unit)}</div>
          </div>
          <div class="muted">${esc(typeLabel(o))}${sub?(" â€¢ "+esc(sub)):""}${note?(" â€¢ "+esc(note)):""}</div>
          ${(unit==="koli" && o.packCount && o.packSize)
          ? `<div class="opsSubLine">Koli: <b>${o.packCount}</b> Ã— <b>${o.packSize}</b> = <b>${o.packCount*o.packSize}</b> adet</div>`
          : ""}
        <div class="opsMiniMeta">${esc(fmtDT(o.ts))}</div>
        `;
        list.appendChild(row);
      }

      if(i < total){
        moreBtn.textContent = "Daha fazla gÃ¶ster ("+(total-i)+")";
        if(!moreBtn.isConnected) list.appendChild(moreBtn);
      }else{
        if(moreBtn.isConnected) moreBtn.remove();
      }
    }

    moreBtn.onclick = ()=>{
      // kullanÄ±cÄ± basÄ±nca bir batch daha
      setTimeout(paintBatch, TICK);
    };

    // Ä°lk batchâ€™i parÃ§a parÃ§a basalÄ±m (UI donmasÄ±n)
    setTimeout(paintBatch, TICK);
  }

  // Mevcut renderOpsPanel varsa override et (en gÃ¼venli: dÄ±ÅŸarÄ±yÄ± bozmadan)
  function hook(){
    // Ops paneli var mÄ±?
    if(!$("opsList")) return;

    // Orijinali sakla (istersek geri dÃ¶neriz)
    if(!window.__V56_ORIG_OPS && typeof window.renderOpsPanel === "function"){
      window.__V56_ORIG_OPS = window.renderOpsPanel;
    }

    window.renderOpsPanel = renderOpsVirtual;

    // Ops sekmesine girince de Ã§iz
    try{
      // V291 bottom nav
      const btn = document.querySelector('[data-v291="cardOps"]');
      if(btn){
        btn.addEventListener("click", ()=>{ try{ renderOpsVirtual(); }catch(e){} });
      }
    }catch(e){}

    // Ä°lk aÃ§Ä±lÄ±ÅŸta da Ã§iz (ops panel aÃ§Ä±k olmasa bile sorun deÄŸil)
    try{ renderOpsVirtual(); }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", hook);
})();


/* V58_ACTIVE_PRODUCT_DRIVES_ALL */
(function(){
  const KEY = "stok_active_pid";

  function readSel(){
    try{
      const sel = document.getElementById("globalProdSelect");
      if(sel && sel.value) return String(sel.value||"");
    }catch(e){}
    return "";
  }

  function applyPid(pid){
    try{ window.ACTIVE_PID = pid || ""; }catch(e){}
    try{ window.__OPS_FILTER_PID = pid || ""; }catch(e){}
    try{ window.REPORT_PID = pid || ""; }catch(e){}
    try{ localStorage.setItem(KEY, pid || ""); }catch(e){}

    // ekranlarÄ± tazele (varsa)
    try{ window.renderProducts && window.renderProducts(); }catch(e){}
    try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){}
    try{ window.reportToday && window.reportToday(); }catch(e){}
    try{ window.renderAlarm && window.renderAlarm(); }catch(e){}
  }

  function bind(){
    const sel = document.getElementById("globalProdSelect");
    if(!sel) return false;

    // seÃ§enekler doldu mu? (en az 1 option)
    if(!sel.options || sel.options.length < 1) return false;

    // aÃ§Ä±lÄ±ÅŸta eski seÃ§imi yÃ¼kle
    let saved = "";
    try{ saved = localStorage.getItem(KEY) || ""; }catch(e){}
    if(saved){
      try{ sel.value = saved; }catch(e){}
      applyPid(saved);
    }else{
      // hiÃ§ kayÄ±t yoksa mevcut valueâ€™yu uygula (varsa)
      const cur = readSel();
      if(cur) applyPid(cur);
    }

    // deÄŸiÅŸince her yere uygula
    sel.addEventListener("change", ()=>{
      const pid = readSel();
      applyPid(pid);
    });

    return true;
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    // bazÄ± cihazlarda select options geÃ§ doluyor â†’ kÄ±sa bir bekleme/poll
    let t=0;
    const iv = setInterval(()=>{
      t += 1;
      if(bind()){ clearInterval(iv); return; }
      if(t >= 30){ clearInterval(iv); } // ~3sn
    }, 100);
  });
})();


/* V59_FOCUS_TOGGLE_CLEAR_ACTIVE */
(function(){
  const KEY_ACTIVE = "stok_active_pid";
  const KEY_FOCUS  = "stok_focus_on_v59"; // "1" / "0"

  function setBtnState(on){
    const b = document.getElementById("btnFocusToggle");
    if(!b) return;
    b.classList.toggle("focusBtnOff", !on);
    b.textContent = on ? "ğŸ¯ Odak: AÃ§Ä±k" : "ğŸ¯ Odak: KapalÄ±";
  }

  function isOn(){
    try{ return (localStorage.getItem(KEY_FOCUS) || "1") !== "0"; }catch(e){}
    return true;
  }

  function setOn(v){
    try{ localStorage.setItem(KEY_FOCUS, v ? "1" : "0"); }catch(e){}
    setBtnState(v);
  }

  function clearActiveEverywhere(){
    // select'i boÅŸla (varsa)
    try{
      const sel = document.getElementById("globalProdSelect");
      if(sel) sel.value = "";
    }catch(e){}

    // global state temizle
    try{ window.ACTIVE_PID = ""; }catch(e){}
    try{ window.__OPS_FILTER_PID = ""; }catch(e){}
    try{ window.REPORT_PID = ""; }catch(e){}
    try{ localStorage.removeItem(KEY_ACTIVE); }catch(e){}

    // ekranlarÄ± tazele
    try{ window.renderProducts && window.renderProducts(); }catch(e){}
    try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){}
    try{ window.reportToday && window.reportToday(); }catch(e){}
    try{ window.renderAlarm && window.renderAlarm(); }catch(e){}
  }

  function applyFocusRule(){
    const on = isOn();
    setBtnState(on);

    // Odak kapalÄ±ysa: aktif pid'i sÄ±fÄ±rla (tam geniÅŸ gÃ¶rÃ¼nÃ¼m)
    if(!on){
      clearActiveEverywhere();
    }else{
      // Odak aÃ§Ä±ksa: mevcut seÃ§imi uygulat (V58 varsa onun change handler'Ä± zaten sÃ¼rer)
      try{
        const sel = document.getElementById("globalProdSelect");
        if(sel){
          const pid = String(sel.value||"");
          // pid varsa V58 bunu zaten yayar; yoksa da sorun deÄŸil.
          // yine de rapor/ops/alarm tazele:
          try{ window.renderProducts && window.renderProducts(); }catch(e){}
          try{ window.renderOpsPanel && window.renderOpsPanel(); }catch(e){}
          try{ window.reportToday && window.reportToday(); }catch(e){}
          try{ window.renderAlarm && window.renderAlarm(); }catch(e){}
        }
      }catch(e){}
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    // buton varsa baÄŸla
    const b = document.getElementById("btnFocusToggle");
    if(b && !b.__bound){
      b.__bound = true;
      b.addEventListener("click", ()=>{
        const on = isOn();
        setOn(!on);
        applyFocusRule();
      });
    }

    // aÃ§Ä±lÄ±ÅŸta state uygula
    applyFocusRule();
  });
})();

</script>

  <!-- V291: Gemini tarzÄ± hafif alt sekme -->
  <nav class="bottomNav" id="bottomNav">
    <div class="navRow">
      <button class="navBtn navBtnOn" data-v291="cardProducts" type="button">ÃœrÃ¼n</button>
      <button class="navBtn" data-v291="cardOps" type="button">Ä°ÅŸlem</button>
      <button class="navBtn" data-v291="cardAlarm" type="button">Alarm</button>
      <button class="navBtn" data-v291="cardReport" type="button">Rapor</button>
    </div>
  </nav>

</body>
</html>
