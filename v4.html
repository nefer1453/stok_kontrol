<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SKT PRO V15</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --yesil: #27ae60; --koyu: #2c3e50; --kirmizi: #c0392b; --sari: #f39c12; --mavi: #2980b9; --gri: #ecf0f1; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: #f4f6f7; color: var(--koyu); padding-bottom: 80px; user-select: none; }
        
        .header { background: #1abc9c; color: white; padding: 15px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header h3 { margin: 0; font-size: 18px; font-weight: bold; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; height: 60px; z-index: 99; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #95a5a6; cursor: pointer; }
        .nav-item.active { color: #1abc9c; font-weight: bold; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }

        .view { display: none; padding: 10px; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid transparent; position: relative; }
        .card-green { border-left-color: var(--yesil); }
        .card-red { border-left-color: var(--kirmizi); background: #fff5f5; }
        .card-gray { border-left-color: #7f8c8d; background: #eee; opacity: 0.8; }

        .row { display: flex; justify-content: space-between; align-items: center; }
        .lbl { font-size: 11px; color: #7f8c8d; font-weight: bold; margin-top: 5px; }
        .val { font-size: 16px; font-weight: bold; }
        .badge { font-size: 10px; padding: 3px 6px; border-radius: 4px; color: white; background: #95a5a6; }
        
        .btn-grp { display: flex; gap: 5px; margin-top: 10px; }
        .btn-act { flex: 1; padding: 10px; border: none; border-radius: 5px; font-weight: bold; font-size: 11px; cursor: pointer; color: white; }
        .bg-sari { background: var(--sari); color: #333; }
        .bg-kirmizi { background: var(--kirmizi); }
        .bg-mavi { background: var(--mavi); }
        .bg-yesil { background: var(--yesil); }
        
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 15px; border-radius: 10px; text-align: center; border-bottom: 3px solid #ddd; }
        .stat-num { font-size: 24px; font-weight: bold; color: var(--yesil); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; align-items: flex-end; justify-content: center; }
        .modal-content { background: white; width: 100%; padding: 25px; border-radius: 20px 20px 0 0; }
        
        input, select { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; background: #fafafa; font-size: 16px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 15px; background: #1abc9c; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; }

        .fab { position: fixed; bottom: 80px; right: 20px; width: 60px; height: 60px; background: #1abc9c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 150; }
    </style>
</head>
<body>

<div class="header">
    <h3>SKT PRO V15 (CEO)</h3>
    <span onclick="window.location.reload(true)" style="font-size:20px;">ğŸ”„</span>
</div>

<div id="view-dash" class="view active">
    <div class="stats">
        <div class="stat-box" style="border-color:var(--kirmizi);">
            <div class="stat-num" id="stat-risk" style="color:var(--kirmizi);">0</div>
            <div class="lbl">RÄ°SKLÄ° ÃœRÃœN</div>
        </div>
        <div class="stat-box" style="border-color:var(--mavi);">
            <div class="stat-num" id="stat-sip" style="color:var(--mavi);">0</div>
            <div class="lbl">SÄ°PARÄ°Å</div>
        </div>
    </div>
    
    <div class="card" style="border-left:5px solid var(--sari);">
        <div class="row"><b style="color:#d35400;">ğŸ’° FÄ°YAT TALEPLERÄ°</b></div>
        <div id="fiyatTalepListesi" style="font-size:12px; margin-top:5px; color:#666;">Liste boÅŸ.</div>
    </div>

    <div class="card">
        <div class="lbl" style="margin-bottom:5px;">YÃ–NETÄ°CÄ° RAPORU VE YEDEK</div>
        <button class="btn-main bg-yesil" style="margin-bottom:10px; font-size:14px;" onclick="exportExcel()">ğŸ“Š EXCEL (CVS) RAPORU Ä°NDÄ°R</button>
        <div class="btn-grp">
            <button class="btn-act bg-mavi" onclick="backupDownload()">ğŸ“¥ SÄ°STEMÄ° Ä°NDÄ°R</button>
            <button class="btn-act bg-kirmizi" onclick="document.getElementById('fileIn').click()">ğŸ“¤ SÄ°STEMÄ° YÃœKLE</button>
        </div>
        <input type="file" id="fileIn" style="display:none" onchange="backupUpload(this)">
    </div>
</div>

<div id="view-stock" class="view">
    <input type="text" id="searchStock" placeholder="ğŸ” ÃœrÃ¼n Ara..." onkeyup="renderStock()">
    <div id="stockList"></div>
    <div class="fab" onclick="openModal('modalStock')">+</div>
</div>

<div id="view-order" class="view">
    <div class="btn-grp" style="margin-bottom:10px;">
        <button class="btn-act bg-mavi" onclick="renderOrders('Hepsi')">HEPSÄ°</button>
        <button class="btn-act bg-mavi" onclick="renderOrders('Bekliyor')">BEKLEYEN</button>
    </div>
    <div id="orderList"></div>
    <div class="fab" onclick="openModal('modalOrder')">+</div>
</div>

<div id="view-archive" class="view">
    <h4 style="color:#7f8c8d; text-align:center;">GEÃ‡MÄ°Å Ä°ÅLEMLER</h4>
    <div id="archiveList"></div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="go('dash', this)"><span class="nav-icon">ğŸ“Š</span>Ã–ZET</div>
    <div class="nav-item" onclick="go('stock', this)"><span class="nav-icon">ğŸ§€</span>STOK</div>
    <div class="nav-item" onclick="go('order', this)"><span class="nav-icon">ğŸšš</span>SÄ°PARÄ°Å</div>
    <div class="nav-item" onclick="go('archive', this)"><span class="nav-icon">ğŸ“œ</span>GEÃ‡MÄ°Å</div>
</div>

<div id="modalStock" class="modal">
    <div class="modal-content">
        <h3>Yeni Stok</h3>
        <input type="text" id="stkAd" placeholder="ÃœrÃ¼n AdÄ±">
        <input type="date" id="stkSkt">
        <select id="stkKaynak">
            <option value="Normal">Normal Stok</option>
            <option value="DaÄŸÄ±lÄ±m">Merkez DaÄŸÄ±lÄ±m</option>
            <option value="Ä°nsert">Ä°nsert / Kampanya</option>
        </select>
        <button class="btn-main" onclick="addStock()">KAYDET</button>
        <button onclick="closeModal('modalStock')" style="width:100%; padding:15px; border:none; background:white; color:#999;">Ä°PTAL</button>
    </div>
</div>

<div id="modalRemove" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--kirmizi);">ÃœrÃ¼nÃ¼ KaldÄ±r</h3>
        <p id="removeName" style="font-weight:bold; margin-bottom:10px;"></p>
        <label>NEDEN KALDIRIYORSUN?</label>
        <select id="removeReason">
            <option value="SatÄ±ldÄ±">âœ… SatÄ±ldÄ± (Normal)</option>
            <option value="SKT Fire">ğŸ—‘ï¸ SKT Doldu (Fire)</option>
            <option value="Bozuk">ğŸ¤¢ Bozuk/KÄ±rÄ±k (Fire)</option>
            <option value="Ä°ade">â†©ï¸ MÃ¼ÅŸteri Ä°adesi</option>
        </select>
        <button class="btn-main bg-kirmizi" onclick="confirmRemove()">ONAYLA VE SÄ°L</button>
        <button onclick="closeModal('modalRemove')" style="width:100%; padding:15px; border:none; background:white; color:#999;">Ä°PTAL</button>
    </div>
</div>

<div id="modalPrice" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--sari);">ğŸ’° Fiyat Ä°ste</h3>
        <p id="priceName"></p>
        <select id="priceReason">
            <option value="YÃ¼klÃ¼ Stok">YÃ¼klÃ¼ Stok</option>
            <option value="SKT Riski">SKT Riski</option>
            <option value="Rakip">Rakip Fiyat</option>
        </select>
        <input type="number" id="priceTarget" placeholder="Hedef Fiyat">
        <button class="btn-main bg-sari" onclick="confirmPrice()">GÃ–NDER</button>
        <button onclick="closeModal('modalPrice')" style="width:100%; padding:15px; border:none; background:white; color:#999;">Ä°PTAL</button>
    </div>
</div>

<div id="modalOrder" class="modal">
    <div class="modal-content">
        <h3>SipariÅŸ Ekle</h3>
        <select id="ordTur"><option value="SipariÅŸ">Biz Ä°stedik</option><option value="DaÄŸÄ±lÄ±m">Merkez GÃ¶nderdi</option></select>
        <input type="text" id="ordUrun" placeholder="ÃœrÃ¼n ve Miktar">
        <input type="text" id="ordNot" placeholder="Not">
        <button class="btn-main" onclick="addOrder()">KAYDET</button>
        <button onclick="closeModal('modalOrder')" style="width:100%; padding:15px; border:none; background:white; color:#999;">Ä°PTAL</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('skt_v14')) || { stocks: [], orders: [], archive: [] };
    let selectedId = null;

    // BÄ°LDÄ°RÄ°M Ä°ZNÄ° VE KONTROLÃœ
    function checkNotifications() {
        if ("Notification" in window) {
            let riskliSayisi = db.stocks.filter(s=>Math.ceil((new Date(s.skt)-new Date())/(1000*60*60*24))<=5).length;
            if (riskliSayisi > 0) {
                if (Notification.permission === "granted") {
                    new Notification("SKT PRO UYARI", { body: `âš ï¸ Dikkat! SKT'si yaklaÅŸan ${riskliSayisi} Ã¼rÃ¼nÃ¼nÃ¼z var.` });
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            new Notification("SKT PRO UYARI", { body: `âš ï¸ Dikkat! SKT'si yaklaÅŸan ${riskliSayisi} Ã¼rÃ¼nÃ¼nÃ¼z var.` });
                        }
                    });
                }
            }
        }
    }

    // EXCEL (CSV) Ã‡IKTISI ALMA
    function exportExcel() {
        let csv = "\ufeff"; // TÃ¼rkÃ§e karakter sorunu iÃ§in BOM
        csv += "--- AKTÄ°F STOK DURUMU ---\n";
        csv += "URUN ADI;SKT TARIHI;KALAN GUN;KAYNAK;TALEP\n";
        
        db.stocks.sort((a,b)=>new Date(a.skt)-new Date(b.skt)).forEach(s => {
            let days = Math.ceil((new Date(s.skt) - new Date())/(1000*60*60*24));
            let durum = days <= 5 ? "Kritik ("+days+" Gun)" : days+" Gun";
            let talep = s.priceReq ? s.priceReq.target + " TL" : "Yok";
            csv += `${s.ad};${s.skt.split('-').reverse().join('.')};${durum};${s.kaynak};${talep}\n`;
        });

        csv += "\n--- GECMIS VE FIRELER ---\n";
        csv += "URUN ADI;NEDEN;TARIH;KAYNAK\n";
        db.archive.forEach(a => {
            csv += `${a.ad};${a.removeReason};${a.removeDate};${a.kaynak}\n`;
        });

        let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "SKT_Yonetici_Raporu.csv";
        link.click();
    }

    function go(v, el) {
        document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        if(el) el.classList.add('active');
        refresh();
    }

    function openModal(id) { document.getElementById(id).style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function refresh() { renderStock(); renderOrders(); renderArchive(); updateDash(); }

    function addStock() {
        const ad = document.getElementById('stkAd').value;
        const skt = document.getElementById('stkSkt').value;
        const kaynak = document.getElementById('stkKaynak').value;
        if(ad && skt) {
            db.stocks.push({ id:Date.now(), ad, skt, kaynak });
            save(); closeModal('modalStock'); refresh();
            document.getElementById('stkAd').value="";
        }
    }

    function renderStock() {
        const list = document.getElementById('stockList');
        const term = document.getElementById('searchStock').value.toLowerCase();
        list.innerHTML = "";
        db.stocks.sort((a,b)=>new Date(a.skt)-new Date(b.skt)).forEach(s => {
            if(!s.ad.toLowerCase().includes(term)) return;
            const days = Math.ceil((new Date(s.skt) - new Date())/(1000*60*60*24));
            let color = "card-green", text = days + " gÃ¼n kaldÄ±";
            if(days<=5) { color="card-red"; text="âš ï¸ KRÄ°TÄ°K: "+days+" gÃ¼n!"; }
            
            let priceInfo = s.priceReq ? `<div style="background:#f9e79f; padding:5px; font-size:11px; border-radius:4px; margin-bottom:5px;">ğŸ’° Talep: ${s.priceReq.target}â‚º</div>` : '';

            list.innerHTML += `
                <div class="card ${color}">
                    <div class="row"><div class="val">${s.ad}</div><span class="badge">${s.kaynak}</span></div>
                    <div class="lbl">${s.skt.split('-').reverse().join('.')} | ${text}</div>
                    ${priceInfo}
                    <div class="btn-grp">
                        <button class="btn-act bg-sari" onclick="askPrice(${s.id}, '${s.ad}')">FÄ°YAT Ä°STE</button>
                        <button class="btn-act bg-kirmizi" onclick="askRemove(${s.id}, '${s.ad}')">KALDIR</button>
                    </div>
                </div>`;
        });
    }

    function askRemove(id, ad) { selectedId = id; document.getElementById('removeName').innerText = ad; openModal('modalRemove'); }
    function confirmRemove() {
        const reason = document.getElementById('removeReason').value;
        const item = db.stocks.find(x=>x.id===selectedId);
        if(item) {
            db.archive.push({ ...item, removeReason: reason, removeDate: new Date().toLocaleDateString() });
            db.stocks = db.stocks.filter(x=>x.id!==selectedId);
            save(); closeModal('modalRemove'); refresh();
        }
    }

    function askPrice(id, ad) { selectedId = id; document.getElementById('priceName').innerText = ad; openModal('modalPrice'); }
    function confirmPrice() {
        const target = document.getElementById('priceTarget').value;
        const reason = document.getElementById('priceReason').value;
        const item = db.stocks.find(x=>x.id===selectedId);
        if(item) { item.priceReq = { target, reason }; save(); closeModal('modalPrice'); refresh(); }
    }

    function addOrder() {
        const tur = document.getElementById('ordTur').value;
        const urun = document.getElementById('ordUrun').value;
        const not = document.getElementById('ordNot').value;
        if(urun) { db.orders.push({ id:Date.now(), tur, urun, not, durum:'Bekliyor' }); save(); closeModal('modalOrder'); refresh(); document.getElementById('ordUrun').value=""; }
    }

    function renderOrders(filter) {
        const list = document.getElementById('orderList'); list.innerHTML="";
        db.orders.slice().reverse().forEach(o => {
            if(filter!=='Hepsi' && o.durum!==filter && o.tur!==filter) return;
            const style = o.tur==='SipariÅŸ' ? 'border-left:5px solid #2980b9' : 'border-left:5px solid #8e44ad';
            list.innerHTML += `
                <div class="card" style="${style}">
                    <div class="row"><div class="val">${o.urun}</div><small>${o.durum}</small></div>
                    <div class="lbl">${o.tur} | ${o.not}</div>
                    ${o.durum==='Bekliyor' ? `<button class="btn-act bg-mavi" onclick="completeOrder(${o.id})">âœ… STOÄA EKLE</button>`:''}
                </div>`;
        });
    }

    function completeOrder(id) {
        const o = db.orders.find(x=>x.id===id);
        if(confirm("Geldi mi?")) { o.durum='TamamlandÄ±'; openModal('modalStock'); document.getElementById('stkAd').value = o.urun; save(); refresh(); }
    }

    function renderArchive() {
        const list = document.getElementById('archiveList'); list.innerHTML="";
        db.archive.slice().reverse().forEach(a => {
            list.innerHTML += `<div class="card card-gray"><div class="row"><div class="val" style="text-decoration:line-through">${a.ad}</div><b>${a.removeReason}</b></div><div class="lbl">${a.removeDate}</div></div>`;
        });
    }

    function updateDash() {
        document.getElementById('stat-risk').innerText = db.stocks.filter(s=>Math.ceil((new Date(s.skt)-new Date())/(1000*60*60*24))<=5).length;
        document.getElementById('stat-sip').innerText = db.orders.filter(o=>o.durum==='Bekliyor').length;
        const reqs = db.stocks.filter(s=>s.priceReq);
        document.getElementById('fiyatTalepListesi').innerHTML = reqs.length ? reqs.map(s=>`<div>â€¢ ${s.ad}: ${s.priceReq.target}â‚º</div>`).join('') : "Liste boÅŸ.";
    }

    function save() { localStorage.setItem('skt_v14', JSON.stringify(db)); }
    function backupDownload() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db)); a.download="skt_v15_yedek.json"; a.click(); }
    function backupUpload(i) { const r=new FileReader(); r.onload=function(e){if(confirm("YÃ¼klensin mi?")){db=JSON.parse(e.target.result); save(); refresh(); alert("Tamam!");}}; r.readAsText(i.files[0]); }

    // SAYFA YÃœKLENDÄ°ÄÄ°NDE BÄ°LDÄ°RÄ°MLERÄ° KONTROL ET
    window.onload = function() {
        refresh();
        setTimeout(checkNotifications, 2000); // Sayfa aÃ§Ä±ldÄ±ktan 2 saniye sonra bildirim sorar
    };
</script>
</body>
</html>
